---
phase: 28-module-1-diagram-migration
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/components/diagrams/module1/FirstConnectorDiagram.tsx
  - src/components/diagrams/module1/PythonConsumerDiagram.tsx
  - src/components/diagrams/module1/EventStructureDiagram.tsx
  - src/components/diagrams/module1/index.ts
  - src/content/course/01-module-1/01-cdc-fundamentals.mdx
  - src/content/course/01-module-1/02-debezium-architecture.mdx
  - src/content/course/01-module-1/03-lab-setup.mdx
  - src/content/course/01-module-1/04-first-connector.mdx
  - src/content/course/01-module-1/05-python-consumer.mdx
  - src/content/course/01-module-1/06-event-structure.mdx
autonomous: true

must_haves:
  truths:
    - "User can view data flow sequence diagram in lesson 04"
    - "User can view Python consumer data flow diagram in lesson 05"
    - "User can view CDC operation types diagram in lesson 06"
    - "User can view event structure hierarchy diagram in lesson 06"
    - "User can click any node in any Module 1 diagram to see tooltip"
    - "No Mermaid import statements exist in Module 1 MDX files"
    - "No <Mermaid chart={...}> blocks exist in Module 1 MDX files"
    - "Module 1 lessons render correctly at localhost:4321/course/01-module-1/*"
  artifacts:
    - path: "src/components/diagrams/module1/FirstConnectorDiagram.tsx"
      provides: "Connector data flow sequence diagram"
      exports: ["FirstConnectorDiagram"]
    - path: "src/components/diagrams/module1/PythonConsumerDiagram.tsx"
      provides: "Python consumer flow diagram"
      exports: ["PythonConsumerDiagram"]
    - path: "src/components/diagrams/module1/EventStructureDiagram.tsx"
      provides: "Operation types and event structure diagrams"
      exports: ["OperationTypesDiagram", "EventStructureDiagram"]
    - path: "src/content/course/01-module-1/*.mdx"
      provides: "Updated MDX files using glass components"
      contains: "from '../../../../components/diagrams/module1'"
  key_links:
    - from: "src/content/course/01-module-1/*.mdx"
      to: "src/components/diagrams/module1"
      via: "import statement"
      pattern: "import.*from.*diagrams/module1"
    - from: "src/content/course/01-module-1/*.mdx"
      to: "Mermaid component"
      via: "removal verification"
      pattern: "Mermaid"
---

<objective>
Complete Module 1 diagram migration by creating remaining diagram components (lessons 04-06) and updating all 6 MDX files to use the new glass components instead of Mermaid.

Purpose: Finish the migration, remove all Mermaid dependencies from Module 1, and verify the new interactive diagrams render correctly.

Output: 3 additional component files + updated barrel export + 6 MDX files migrated.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-module-1-diagram-migration/28-CONTEXT.md
@.planning/phases/28-module-1-diagram-migration/28-01-SUMMARY.md
@src/components/diagrams/primitives/types.ts
@src/components/diagrams/primitives/SequenceDiagram.tsx
@src/content/course/01-module-1/04-first-connector.mdx
@src/content/course/01-module-1/05-python-consumer.mdx
@src/content/course/01-module-1/06-event-structure.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create remaining diagram components for lessons 04-06</name>
  <files>
    src/components/diagrams/module1/FirstConnectorDiagram.tsx
    src/components/diagrams/module1/PythonConsumerDiagram.tsx
    src/components/diagrams/module1/EventStructureDiagram.tsx
    src/components/diagrams/module1/index.ts
  </files>
  <action>
**1. Create `src/components/diagrams/module1/FirstConnectorDiagram.tsx`:**

Sequence diagram showing connector data flow:
- Actors: psql (service), PostgreSQL (database), WAL (queue), Debezium (service), Kafka (queue)
- Messages:
  1. psql -> PostgreSQL: "INSERT INTO customers"
  2. PostgreSQL -> WAL: "Write to transaction log"
  3. PostgreSQL -> psql: "OK" (return)
  4. Note: "~миллисекунды"
  5. Debezium -> WAL: "Read via logical replication"
  6. WAL -> Debezium: "Change event" (return)
  7. Debezium -> Kafka: "Publish to inventory.public.customers"
  8. Note: "Event available for consumers"

**Tooltip content:**
- psql: "PostgreSQL CLI клиент для выполнения SQL команд. В лабораторных мы используем его через docker compose exec postgres psql."
- PostgreSQL: "База данных с настроенной logical replication. Параметры: wal_level=logical, max_replication_slots>=10."
- WAL: "Write-Ahead Log хранит изменения до прочтения Debezium. Replication slot гарантирует что сегменты не будут удалены преждевременно."
- Debezium: "Коннектор читает WAL через pgoutput плагин и преобразует в CDC envelope-формат с полями before/after/op/source."
- Kafka: "Топик inventory.public.customers хранит все CDC-события для таблицы customers."

**2. Create `src/components/diagrams/module1/PythonConsumerDiagram.tsx`:**

Simple flowchart showing Python consumer data flow:
- FlowNode (database/purple): PostgreSQL
- Arrow with label "WAL"
- FlowNode (connector/emerald): Debezium
- Arrow with label "CDC Events"
- FlowNode (cluster/emerald): Kafka Topic
- Arrow with label "poll"
- FlowNode (app/blue): Python Consumer

Use horizontal flow layout with flex.

**Tooltip content:**
- PostgreSQL: "Источник данных. Изменения захватываются через logical replication без нагрузки на production запросы."
- Debezium: "Преобразует WAL-записи в структурированные JSON-события с envelope-форматом (before/after/op/source)."
- Kafka Topic: "Топик inventory.public.customers хранит поток событий. Consumer может перечитать события при необходимости."
- Python Consumer: "confluent-kafka библиотека на базе librdkafka. Подключается к kafka:9092 внутри Docker или localhost:9092 с хоста."

**3. Create `src/components/diagrams/module1/EventStructureDiagram.tsx` with two exports:**

**A. OperationTypesDiagram** - Four operation types in a 2x2 grid:
- FlowNode "r (snapshot)" (emerald): "before: null, after: данные"
- FlowNode "c (create)" (blue): "before: null, after: данные"
- FlowNode "u (update)" (amber): "before: старое, after: новое"
- FlowNode "d (delete)" (rose): "before: данные, after: null"

**Tooltip content:**
- snapshot (r): "Read операция при начальном snapshot. Debezium читает существующие записи при первом запуске. Поле source.snapshot='true'."
- create (c): "INSERT операция. Новая запись добавлена в таблицу. Поле before=null, данные в after."
- update (u): "UPDATE операция. Изменение существующей записи. Оба поля before и after заполнены для сравнения."
- delete (d): "DELETE операция. Запись удалена. Поле after=null, удаленные данные в before для аудита."

**B. EventStructureDiagram** - Hierarchical event structure:
- Outer DiagramContainer "CDC Event"
- Two inner containers: "schema" (neutral, smaller) and "payload" (blue, larger)
- Inside payload: FlowNodes for "before", "after", "source", "op", "ts_ms"
- Show nested structure for source: db, schema, table, lsn, txId

Use flex column layout with nested DiagramContainers.

**Tooltip content:**
- schema: "JSON Schema описание структуры payload. Полезно для Schema Registry, но для базовой работы можно игнорировать."
- payload: "Основное содержимое события — данные и метаданные об источнике изменения."
- before: "Состояние строки ДО изменения. null для INSERT и snapshot, заполнен для UPDATE и DELETE."
- after: "Состояние строки ПОСЛЕ изменения. null для DELETE, заполнен для INSERT, UPDATE и snapshot."
- source: "Метаданные об источнике: версия Debezium, имя базы, схемы, таблицы, позиция в WAL (lsn), ID транзакции."
- op: "Тип операции: r=snapshot, c=create, u=update, d=delete. Критично для правильной обработки события."
- ts_ms: "Timestamp обработки события Debezium в миллисекундах. Для event time используйте source.ts_ms."

**4. Update `src/components/diagrams/module1/index.ts`:**

Add exports for new components:
```typescript
export * from './CdcFundamentalsDiagrams';
export * from './DebeziumArchitectureDiagrams';
export * from './LabSetupDiagram';
export * from './FirstConnectorDiagram';
export * from './PythonConsumerDiagram';
export * from './EventStructureDiagram';
```
  </action>
  <verify>
- All 3 new component files exist
- TypeScript compiles without errors: `npx tsc --noEmit`
- Index exports all 9 diagram components
  </verify>
  <done>
All 9 Module 1 diagram components created and exported from barrel file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MDX files to use glass components and remove Mermaid</name>
  <files>
    src/content/course/01-module-1/01-cdc-fundamentals.mdx
    src/content/course/01-module-1/02-debezium-architecture.mdx
    src/content/course/01-module-1/03-lab-setup.mdx
    src/content/course/01-module-1/04-first-connector.mdx
    src/content/course/01-module-1/05-python-consumer.mdx
    src/content/course/01-module-1/06-event-structure.mdx
  </files>
  <action>
For each MDX file, perform these changes:

**1. Replace Mermaid import with diagram component imports:**

Remove:
```
import { Mermaid } from '../../../components/Mermaid.tsx';
```

Add appropriate imports from module1 diagrams:
```typescript
// 01-cdc-fundamentals.mdx
import { CdcComparisonDiagram, CdcSequenceDiagram } from '../../../../components/diagrams/module1';

// 02-debezium-architecture.mdx
import { DeploymentModesDiagram, KafkaConnectClusterDiagram, CdcEventFlowDiagram } from '../../../../components/diagrams/module1';

// 03-lab-setup.mdx
import { LabSetupDiagram } from '../../../../components/diagrams/module1';

// 04-first-connector.mdx
import { FirstConnectorDiagram } from '../../../../components/diagrams/module1';

// 05-python-consumer.mdx
import { PythonConsumerDiagram } from '../../../../components/diagrams/module1';

// 06-event-structure.mdx
import { OperationTypesDiagram, EventStructureDiagram } from '../../../../components/diagrams/module1';
```

**2. Replace each <Mermaid chart={...}> block with corresponding component:**

01-cdc-fundamentals.mdx:
- First Mermaid (Polling vs CDC flowchart) -> `<CdcComparisonDiagram />`
- Second Mermaid (sequence diagram) -> `<CdcSequenceDiagram />`

02-debezium-architecture.mdx:
- First Mermaid (3 deployment modes) -> `<DeploymentModesDiagram />`
- Second Mermaid (Kafka Connect cluster) -> `<KafkaConnectClusterDiagram />`
- Third Mermaid (CDC event flow sequence) -> `<CdcEventFlowDiagram />`

03-lab-setup.mdx:
- Single Mermaid (Docker architecture) -> `<LabSetupDiagram />`

04-first-connector.mdx:
- Single Mermaid (data flow sequence) -> `<FirstConnectorDiagram />`

05-python-consumer.mdx:
- Single Mermaid (simple flow) -> `<PythonConsumerDiagram />`

06-event-structure.mdx:
- First Mermaid (operation types) -> `<OperationTypesDiagram />`
- Second Mermaid (event anatomy) -> `<EventStructureDiagram />`

**Important:**
- Remove the entire `<Mermaid chart={...}> client:visible />` block
- Replace with single-line component usage
- Ensure no `client:visible` directive needed (components handle interactivity)
- Keep surrounding content intact (headers, paragraphs, code blocks)

**Verification pattern:**
After changes, each MDX file should:
- Have NO import from Mermaid.tsx
- Have NO <Mermaid> tags
- Have imports from diagrams/module1
- Have appropriate <ComponentName /> usage
  </action>
  <verify>
- No Mermaid imports in any Module 1 MDX file: `grep -r "Mermaid" src/content/course/01-module-1/`
- All 6 MDX files have diagram component imports
- TypeScript/Astro content build: `npm run build`
- Visual check: `npm run dev` and navigate to each lesson
  </verify>
  <done>
All 6 Module 1 MDX files updated to use glass diagram components, Mermaid completely removed from Module 1.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Module 1 renders correctly</name>
  <files>None (verification only)</files>
  <action>
Run development server and verify all Module 1 lessons render correctly:

1. Start dev server: `npm run dev`

2. Verify each lesson URL loads without console errors:
   - http://localhost:4321/course/01-module-1/01-cdc-fundamentals
   - http://localhost:4321/course/01-module-1/02-debezium-architecture
   - http://localhost:4321/course/01-module-1/03-lab-setup
   - http://localhost:4321/course/01-module-1/04-first-connector
   - http://localhost:4321/course/01-module-1/05-python-consumer
   - http://localhost:4321/course/01-module-1/06-event-structure

3. For each page, verify:
   - Diagrams render (no blank spaces where Mermaid was)
   - Interactive elements respond to clicks (tooltips appear)
   - Layout is responsive (check mobile viewport)
   - No TypeScript/React errors in console

4. Run production build to ensure no build-time errors:
   ```bash
   npm run build
   ```

5. Grep verification (Mermaid completely removed):
   ```bash
   grep -r "Mermaid" src/content/course/01-module-1/
   # Should return nothing

   grep -r "import.*diagrams/module1" src/content/course/01-module-1/
   # Should return 6 results (one per file)
   ```
  </action>
  <verify>
- `npm run build` succeeds with exit code 0
- `grep -r "Mermaid" src/content/course/01-module-1/` returns no results
- All 6 lesson pages render with visible diagrams
  </verify>
  <done>
Module 1 diagram migration verified complete: all 9 diagrams migrated, Mermaid removed, lessons render correctly.
  </done>
</task>

</tasks>

<verification>
1. All 9 diagram components exist in src/components/diagrams/module1/
2. All 6 MDX files updated with glass component imports
3. Zero Mermaid references in Module 1: `grep -r "Mermaid" src/content/course/01-module-1/`
4. Production build succeeds: `npm run build`
5. Requirements coverage:
   - MOD1-01 (audit): Complete in 28-CONTEXT.md (9 diagrams)
   - MOD1-02 (glass versions): 9 components created
   - MOD1-03 (tooltips): All nodes have detailed Russian tooltips
   - MOD1-04 (Mermaid removal): Zero references after migration
</verification>

<success_criteria>
- 9 total diagram components exported from src/components/diagrams/module1/
- 6 MDX files updated with glass component usage
- Zero Mermaid imports/usage in Module 1
- All lessons render correctly in dev and production builds
- Interactive tooltips work on all diagram nodes
- Requirements MOD1-01 through MOD1-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/28-module-1-diagram-migration/28-02-SUMMARY.md`
</output>
