---
phase: 31-module-4-diagram-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/diagrams/module4/AlertingDiagrams.tsx
  - src/components/diagrams/module4/WalBloatHeartbeatDiagrams.tsx
  - src/components/diagrams/module4/index.ts
autonomous: true

must_haves:
  truths:
    - "Alert comparison diagram shows reactive (bad) vs proactive (good) approaches"
    - "Alert severity hierarchy renders Warning -> Critical -> Emergency escalation"
    - "Batch INSERT spike diagram shows transient lag vs recovery"
    - "Notification routing diagram shows alert-to-channel decision tree"
    - "Low-traffic WAL scenario renders as sequence diagram with 4 actors"
    - "Multi-layer defense diagram shows 4 protection layers with tooltips"
    - "Heartbeat flow diagram shows pg_logical_emit_message path"
    - "User can click nodes to see alerting and WAL bloat explanations"
  artifacts:
    - path: "src/components/diagrams/module4/AlertingDiagrams.tsx"
      provides: "Alerting visualization (4 exports)"
      exports: ["AlertComparisonDiagram", "AlertSeverityHierarchyDiagram", "BatchInsertSpikeDiagram", "NotificationRoutingDiagram"]
    - path: "src/components/diagrams/module4/WalBloatHeartbeatDiagrams.tsx"
      provides: "WAL bloat and heartbeat visualization (3 exports)"
      exports: ["LowTrafficWalScenarioDiagram", "MultiLayerDefenseDiagram", "HeartbeatFlowDiagram"]
  key_links:
    - from: "src/components/diagrams/module4/WalBloatHeartbeatDiagrams.tsx"
      to: "primitives/SequenceDiagram"
      via: "import"
      pattern: "import.*SequenceDiagram.*from.*primitives"
    - from: "src/components/diagrams/module4/AlertingDiagrams.tsx"
      to: "primitives/FlowNode"
      via: "import"
      pattern: "import.*FlowNode.*from.*primitives"
---

<objective>
Create glass diagram components for Module 4 lessons 04-05: lag detection alerting and WAL bloat heartbeat management.

Purpose: Provides interactive alerting architecture and WAL management diagrams with tooltips explaining alert severity, escalation patterns, and WAL bloat prevention strategies.
Output: 2 diagram files with 7 total diagram exports (4 alerting + 3 WAL/heartbeat).
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-module-4-diagram-migration/31-RESEARCH.md

# Primitives reference
@src/components/diagrams/primitives/FlowNode.tsx
@src/components/diagrams/primitives/Arrow.tsx
@src/components/diagrams/primitives/DiagramContainer.tsx
@src/components/diagrams/primitives/Tooltip.tsx
@src/components/diagrams/primitives/SequenceDiagram.tsx
@src/components/diagrams/primitives/types.ts

# Module 4 MDX files (diagram source)
@src/content/course/04-module-4/04-lag-detection-alerting.mdx
@src/content/course/04-module-4/05-wal-bloat-heartbeat.mdx

# Prior sequence diagram reference
@src/components/diagrams/module3/BinlogRetentionDiagrams.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AlertingDiagrams.tsx</name>
  <files>
    src/components/diagrams/module4/AlertingDiagrams.tsx
  </files>
  <action>
Create AlertingDiagrams.tsx with 4 diagram exports:

1. **AlertComparisonDiagram** (2 subgraphs side-by-side):
   - Left (rose): "Without Alerts" - Reactive flow: Problem -> User complaint -> Firefighting
   - Right (emerald): "With Alerts" - Proactive flow: Metric spike -> Alert -> Immediate action
   - Use grid-cols-1 md:grid-cols-2 layout
   - Tooltips explain cost of reactive vs proactive approaches

2. **AlertSeverityHierarchyDiagram** (vertical flowchart):
   - Warning (yellow-500): 5s lag threshold, Slack notification
   - Arrow down with label "30 min unresolved"
   - Critical (orange-500): 30s lag threshold, PagerDuty
   - Arrow down with label "15 min unresolved"
   - Emergency (rose-500): 60s lag threshold, Phone escalation
   - Use custom bg/border colors via className overrides
   - DiagramContainer with title="Alert Severity Hierarchy" color="amber"
   - Tooltips: "Warning at 5s - time to react. Critical at 30s - SLO already violated"

3. **BatchInsertSpikeDiagram** (horizontal flowchart):
   - Batch INSERT (database) -> Lag Spike (app, rose) -> Processing (connector) -> Recovery (sink, emerald)
   - Shows transient vs sustained lag pattern
   - Tooltips explain why spikes are normal and when to worry

4. **NotificationRoutingDiagram** (decision tree flowchart TD):
   - Alert fires (connector) -> Severity check (connector)
   - Branches: Warning -> Slack, Critical -> PagerDuty, Emergency -> Phone
   - Color-coded end states by severity
   - Tooltips explain routing logic
  </action>
  <verify>
    - Run `npm run build` - no TypeScript errors
    - File exists at src/components/diagrams/module4/AlertingDiagrams.tsx
    - grep confirms 4 exports: AlertComparisonDiagram, AlertSeverityHierarchyDiagram, BatchInsertSpikeDiagram, NotificationRoutingDiagram
  </verify>
  <done>
    AlertingDiagrams.tsx exists with 4 exported diagram components covering alert comparison, severity hierarchy, spike handling, and notification routing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WalBloatHeartbeatDiagrams.tsx and update index.ts</name>
  <files>
    src/components/diagrams/module4/WalBloatHeartbeatDiagrams.tsx
    src/components/diagrams/module4/index.ts
  </files>
  <action>
Create WalBloatHeartbeatDiagrams.tsx with 3 diagram exports:

1. **LowTrafficWalScenarioDiagram** (sequence diagram):
   - 4 actors: Orders (database), Slot (service), WAL (service), Disk (external)
   - Messages showing: Normal flow -> No activity period -> WAL accumulation -> Problem
   - Use SequenceDiagram primitive with messageSpacing=45
   - Tooltips: "Slot does not advance if table doesn't change - WAL accumulates"

2. **MultiLayerDefenseDiagram** (vertical flowchart):
   - Threats section at top (rose)
   - 4 defense layers stacked vertically:
     - Layer 1 (emerald): max_slot_wal_keep_size
     - Layer 2 (blue): Heartbeat events
     - Layer 3 (amber): Monitoring & alerting
     - Layer 4 (purple): Runbooks & procedures
   - Each layer has Arrow down between
   - Tooltips explain each layer's purpose

3. **HeartbeatFlowDiagram** (horizontal flowchart LR):
   - Debezium Timer -> pg_logical_emit_message -> WAL -> Slot -> Kafka
   - Shows how heartbeat advances slot position
   - Tooltips: "pg_logical_emit_message() - recommended approach for PostgreSQL 14+"

**Update index.ts** to include new exports:
```typescript
export * from './JmxMetricsDiagrams';
export * from './PrometheusCollectionDiagrams';
export * from './GrafanaDashboardDiagrams';
export * from './AlertingDiagrams';
export * from './WalBloatHeartbeatDiagrams';
```
  </action>
  <verify>
    - Run `npm run build` - no TypeScript errors
    - File exists at src/components/diagrams/module4/WalBloatHeartbeatDiagrams.tsx
    - grep WalBloatHeartbeatDiagrams.tsx confirms 3 exports
    - grep index.ts confirms 5 export statements
  </verify>
  <done>
    WalBloatHeartbeatDiagrams.tsx exists with 3 exports (sequence + 2 flowcharts), index.ts updated with all 5 diagram files, total 15 exports for lessons 01-05
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - zero errors
2. ls src/components/diagrams/module4/ shows 6 files (4 from plan-01 + 2 new)
3. All 7 new exports available from index.ts
4. SequenceDiagram import used correctly in WalBloatHeartbeatDiagrams.tsx
</verification>

<success_criteria>
- 7 diagram components created (4 alerting + 3 WAL/heartbeat)
- LowTrafficWalScenarioDiagram uses SequenceDiagram primitive
- Alert severity uses custom color classes (yellow/orange/rose progression)
- Russian tooltips explain alerting and WAL bloat concepts
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-module-4-diagram-migration/31-02-SUMMARY.md`
</output>
