---
phase: 18-github-pages-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "Workflow uses official withastro/action@v5 for build"
    - "Workflow uses latest action versions (checkout@v6, deploy-pages@v4)"
    - "Local build succeeds without errors"
    - "Preview server renders all pages correctly"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "GitHub Actions workflow for Astro deployment"
      contains: "withastro/action@v5"
    - path: "dist/"
      provides: "Build output directory"
      min_files: 60
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "withastro/action"
      via: "uses directive"
      pattern: "withastro/action@v5"
    - from: "astro.config.mjs"
      to: "dist/"
      via: "build output"
      pattern: "site.*base"
---

<objective>
Update GitHub Actions workflow to use official Astro action and verify local build

Purpose: Prepare deployment workflow using the recommended `withastro/action@v5` which auto-detects package manager, handles caching, and simplifies the build process. Local verification ensures the site builds correctly before pushing to GitHub.

Output: Updated `.github/workflows/deploy.yml` and verified local build
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-github-pages-deployment/18-RESEARCH.md
@.github/workflows/deploy.yml
@astro.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GitHub Actions workflow to use withastro/action</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Replace the current custom build workflow with the official Astro GitHub Action pattern:

1. Update `actions/checkout` from v4 to v6
2. Replace the manual Node setup + npm ci + npm build steps with single `withastro/action@v5` step
3. Keep existing concurrency and permissions blocks (already correct)
4. Keep `actions/deploy-pages@v4` (already correct)

The workflow should use this structure for the build job:
```yaml
build:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout your repository using git
      uses: actions/checkout@v6

    - name: Install, build, and upload your site output
      uses: withastro/action@v5
```

Remove:
- `actions/setup-node@v4` step (withastro/action handles Node setup)
- `npm ci` step (withastro/action handles installation)
- `npm run build` step (withastro/action handles build)
- `actions/upload-pages-artifact@v3` step (withastro/action handles artifact upload)

Keep unchanged:
- `permissions` block (contents: read, pages: write, id-token: write)
- `concurrency` block (group: "pages", cancel-in-progress: false)
- `deploy` job (uses actions/deploy-pages@v4)
- Workflow triggers (push to main, workflow_dispatch)
  </action>
  <verify>
cat .github/workflows/deploy.yml | grep -E "withastro/action@v5|checkout@v6|deploy-pages@v4"
# Should show all three action references
  </verify>
  <done>
Workflow file uses withastro/action@v5 for build, actions/checkout@v6, actions/deploy-pages@v4
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify local build succeeds</name>
  <files>dist/</files>
  <action>
Run the Astro build locally to verify:
1. Build completes without errors
2. All 65 pages are generated
3. No critical warnings (Shiki language warnings for avro/promql are acceptable)

Commands:
```bash
cd "/Users/levoely/debezium course"
npm run build
```

Expected output:
- Build completes successfully
- Output shows page count (should be ~65 pages)
- Build time reasonable (previous was 8.82s)
- dist/ directory contains output files
  </action>
  <verify>
npm run build && ls -la dist/ | head -20
# Build should complete with success message
# dist/ should contain index.html and _astro/ directory
  </verify>
  <done>
Local build succeeds with no errors, dist/ directory contains all expected output files
  </done>
</task>

<task type="auto">
  <name>Task 3: Test preview server with base path</name>
  <files>None (verification only)</files>
  <action>
Start Astro preview server and verify pages are accessible:
1. Run `npm run preview` (starts at http://localhost:4321/debezium-course/)
2. Test in background, verify server starts
3. Curl the homepage to verify it responds
4. Stop the preview server

This verifies that the base path `/debezium-course` is correctly applied in the build.

Note: Full visual verification will be done in Plan 02 checkpoint after deployment.
  </action>
  <verify>
# Start preview in background, test, then kill
npm run preview &
sleep 3
curl -s http://localhost:4321/debezium-course/ | head -20
pkill -f "astro preview" || true
# Should show HTML content with "Debezium" in title
  </verify>
  <done>
Preview server starts successfully at http://localhost:4321/debezium-course/ and serves valid HTML
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `.github/workflows/deploy.yml` contains `withastro/action@v5`
2. `npm run build` completes without errors
3. `dist/` directory contains build output
4. Preview server serves content at correct base path
</verification>

<success_criteria>
- Workflow updated to use official Astro action (v5)
- Local build succeeds
- Preview server confirms base path works correctly
- Ready for push to GitHub and deployment verification
</success_criteria>

<output>
After completion, create `.planning/phases/18-github-pages-deployment/18-01-SUMMARY.md`
</output>
