---
phase: 20-cross-reference-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/course/06-module-6/01-advanced-python-consumer.mdx
  - src/content/course/07-module-7/01-cloud-sql-setup.mdx
  - src/content/course/07-module-7/04-dataflow-bigquery.mdx
  - src/content/course/07-module-7/06-cloud-monitoring.mdx
  - src/content/course/08-module-8/01-capstone-overview.mdx
  - src/content/course/08-module-8/02-architecture-deliverables.mdx
  - src/content/course/08-module-8/03-self-assessment.mdx
  - src/content/course/08-module-8/04-multi-database-architecture.mdx
  - src/content/course/08-module-8/05-multi-database-configuration.mdx
  - src/stores/progress.ts
autonomous: true

must_haves:
  truths:
    - "All internal cross-reference links resolve to valid pages"
    - "Site builds with zero errors and no broken internal links"
    - "User progress for renamed modules is preserved after migration"
  artifacts:
    - path: "src/content/course/**/*.mdx"
      provides: "Updated cross-references with new URL format"
      contains: "/course/0X-module-X/"
    - path: "src/stores/progress.ts"
      provides: "Progress migration function"
      exports: ["migrateModuleSlugs"]
  key_links:
    - from: "src/content/course/08-module-8/*.mdx"
      to: "/course/0X-module-X/"
      via: "MDX markdown links"
      pattern: "\\[.*\\]\\(/course/0[3-8]-module-[3-8]/"
    - from: "src/stores/progress.ts"
      to: "localStorage course-progress"
      via: "slug mapping migration"
      pattern: "migrateModuleSlugs"
---

<objective>
Fix 25 broken cross-references in 9 MDX files and implement progress tracking migration

Purpose: Complete STRUCT-01c (cross-reference updates) and STRUCT-01e (progress tracking) requirements. After Phase 19 renamed directories, internal links using old `/course/module-X/` format are broken. Additionally, user progress stored with old slugs needs migration to preserve completion status.

Output:
- 9 MDX files with corrected cross-reference URLs
- Progress migration function added to progress.ts
- Site builds successfully with all internal links valid
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-cross-reference-updates/20-RESEARCH.md
@.planning/phases/19-module-renaming/19-01-SUMMARY.md
@src/stores/progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cross-references in MDX files using sed</name>
  <files>
    src/content/course/06-module-6/01-advanced-python-consumer.mdx
    src/content/course/07-module-7/01-cloud-sql-setup.mdx
    src/content/course/07-module-7/04-dataflow-bigquery.mdx
    src/content/course/07-module-7/06-cloud-monitoring.mdx
    src/content/course/08-module-8/01-capstone-overview.mdx
    src/content/course/08-module-8/02-architecture-deliverables.mdx
    src/content/course/08-module-8/03-self-assessment.mdx
    src/content/course/08-module-8/04-multi-database-architecture.mdx
    src/content/course/08-module-8/05-multi-database-configuration.mdx
  </files>
  <action>
    Use sed to replace old `/course/module-X/` URLs with new `/course/0X-module-X/` format.

    **CRITICAL: Order matters to prevent circular mapping!**
    Process module-8→3 FIRST, then in reverse order (7→8, 6→7, 5→6, 4→5, 3→4).

    **Mapping (from Phase 19 directory renames):**
    - `/course/module-8/` → `/course/03-module-3/` (MySQL moved to position 3)
    - `/course/module-7/` → `/course/08-module-8/` (old Capstone → new position)
    - `/course/module-6/` → `/course/07-module-7/` (Cloud-Native shifted)
    - `/course/module-5/` → `/course/06-module-6/` (Data Engineering shifted)
    - `/course/module-4/` → `/course/05-module-5/` (Advanced Patterns shifted)
    - `/course/module-3/` → `/course/04-module-4/` (Production Ops shifted)

    **Note:** Modules 1 and 2 did NOT change, so `/course/module-1/` and `/course/module-2/` references are already correct.

    Execute:
    ```bash
    FILES=$(git grep -l "/course/module-" -- "*.mdx")
    echo "$FILES" | xargs sed -i.bak \
      -e 's|/course/module-8/|/course/03-module-3/|g' \
      -e 's|/course/module-7/|/course/08-module-8/|g' \
      -e 's|/course/module-6/|/course/07-module-7/|g' \
      -e 's|/course/module-5/|/course/06-module-6/|g' \
      -e 's|/course/module-4/|/course/05-module-5/|g' \
      -e 's|/course/module-3/|/course/04-module-4/|g'
    ```

    After replacement:
    1. Verify no old patterns remain: `git grep "/course/module-[3-8]/" -- "*.mdx"`
    2. Review changes: `git diff src/content/course/`
    3. Remove backup files: `find src/content/course -name "*.bak" -delete`
  </action>
  <verify>
    - `git grep "/course/module-[3-8]/" -- "*.mdx"` returns empty (no old patterns)
    - `git diff --stat src/content/course/` shows 9 files changed with 25 insertions/deletions
    - New patterns present: `git grep "/course/0[3-8]-module-" -- "*.mdx" | wc -l` returns 25
  </verify>
  <done>
    All 25 cross-references updated from `/course/module-X/` to `/course/0X-module-X/` format. No old-format references remain in MDX files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progress migration function to progress.ts</name>
  <files>src/stores/progress.ts</files>
  <action>
    Add a one-time migration function to convert old lesson slugs to new format in localStorage.

    Add after the existing `resetProgress` function:

    ```typescript
    /**
     * One-time migration: Rename module slugs after v1.2 reorganization.
     * Converts old module-X slugs to new 0X-module-X format.
     * Called once on app initialization, skipped if already migrated.
     */
    export function migrateModuleSlugs(): void {
      const MIGRATION_KEY = 'course-progress-v1.2-migrated';

      // Skip if already migrated
      if (typeof window === 'undefined') return;
      if (localStorage.getItem(MIGRATION_KEY) === 'true') return;

      const data = $progress.get();
      if (!data || !Array.isArray(data.completed) || data.completed.length === 0) {
        // No progress to migrate, mark as done
        localStorage.setItem(MIGRATION_KEY, 'true');
        return;
      }

      // Slug prefix mapping (old → new)
      const prefixMap: Record<string, string> = {
        '08-module-8': '03-module-3',  // MySQL → position 3
        '03-module-3': '04-module-4',  // Production Ops → position 4
        '04-module-4': '05-module-5',  // Advanced Patterns → position 5
        '05-module-5': '06-module-6',  // Data Engineering → position 6
        '06-module-6': '07-module-7',  // Cloud-Native → position 7
        '07-module-7': '08-module-8',  // Capstone → position 8
      };

      const migratedCompleted = data.completed.map(slug => {
        // Check each prefix and replace if matching
        for (const [oldPrefix, newPrefix] of Object.entries(prefixMap)) {
          if (slug.startsWith(oldPrefix + '/')) {
            return newPrefix + slug.slice(oldPrefix.length);
          }
        }
        return slug; // Unchanged (modules 1-2 or already migrated)
      });

      $progress.set({
        completed: migratedCompleted,
        lastUpdated: Date.now(),
      });

      localStorage.setItem(MIGRATION_KEY, 'true');
    }
    ```

    **Key design decisions:**
    - Version flag (`course-progress-v1.2-migrated`) prevents re-running
    - Prefix-based mapping handles all lessons in each module
    - Preserves modules 1-2 slugs (unchanged in Phase 19)
    - No-op if no progress exists (new users)
    - SSR-safe with `typeof window` check
  </action>
  <verify>
    - Function `migrateModuleSlugs` is exported from `src/stores/progress.ts`
    - TypeScript compiles without errors: `npx tsc --noEmit`
    - Function exists: `grep -q "export function migrateModuleSlugs" src/stores/progress.ts`
  </verify>
  <done>
    Progress migration function added to progress.ts. Function is exported and ready to be called during app initialization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire migration into app initialization and verify build</name>
  <files>src/layouts/LessonLayout.astro (or appropriate layout)</files>
  <action>
    Call `migrateModuleSlugs()` once during app initialization on client-side.

    **Option A (Preferred):** Add to client-side script in a layout that loads on every lesson page.

    Find the appropriate layout file (likely `src/layouts/LessonLayout.astro` or `src/layouts/BaseLayout.astro`) and add:

    ```astro
    <script>
      import { migrateModuleSlugs } from '../stores/progress';

      // Run migration once on page load
      migrateModuleSlugs();
    </script>
    ```

    **Alternative:** If a client:load component already initializes the app, add the call there.

    After adding migration call:
    1. Clear Astro cache: `rm -rf .astro/`
    2. Run build: `npm run build`
    3. Verify build succeeds with zero errors
  </action>
  <verify>
    - `npm run build` completes successfully with 0 errors
    - Migration call exists: `grep -r "migrateModuleSlugs" src/layouts/`
    - Build output shows all pages generated: look for "65 page(s)" or similar in output
  </verify>
  <done>
    Migration function is called on app initialization. Site builds successfully with all internal links valid. Progress tracking migration is active for users visiting the course.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Cross-references valid:**
   ```bash
   git grep "/course/module-[3-8]/" -- "*.mdx"
   # Expected: empty (no results)
   ```

2. **New format present:**
   ```bash
   git grep "/course/0[3-8]-module-" -- "*.mdx" | wc -l
   # Expected: 25
   ```

3. **Build passes:**
   ```bash
   npm run build
   # Expected: 0 errors, ~65 pages generated
   ```

4. **Migration function wired:**
   ```bash
   grep -r "migrateModuleSlugs" src/
   # Expected: 2+ results (definition + call)
   ```

5. **No TypeScript errors:**
   ```bash
   npx tsc --noEmit
   # Expected: 0 errors
   ```
</verification>

<success_criteria>
- [ ] All 25 cross-references updated to new `/course/0X-module-X/` format
- [ ] No old `/course/module-X/` patterns remain in MDX files (modules 3-8)
- [ ] Progress migration function added and exported from progress.ts
- [ ] Migration called during app initialization
- [ ] Site builds with zero errors
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-cross-reference-updates/20-01-SUMMARY.md`
</output>
