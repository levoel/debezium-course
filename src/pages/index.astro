---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { ProgressIndicator } from '../components/ProgressIndicator';
import { ProgressExport } from '../components/ProgressExport';
import { ModuleAccordion } from '../components/ModuleAccordion';

// Helper to clean entry.id to URL-friendly slug
function cleanSlug(id: string): string {
  return id.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '');
}

// Fetch all course entries and sort by order
const courseEntries = await getCollection('course');
const sortedLessons = courseEntries
  .filter(c => !c.data.draft)
  .sort((a, b) => a.data.order - b.data.order);

// Total lessons for progress indicator
const totalLessons = sortedLessons.length;

// Group lessons by module
function groupByModule(lessons: typeof sortedLessons) {
  const groups = new Map<string, typeof sortedLessons>();

  for (const lesson of lessons) {
    // Extract module ID from lesson slug (e.g., "01-module-1/01-cdc-fundamentals" -> "01-module-1")
    const moduleId = cleanSlug(lesson.id).split('/')[0];

    if (!groups.has(moduleId)) {
      groups.set(moduleId, []);
    }
    groups.get(moduleId)!.push(lesson);
  }

  return groups;
}

const moduleGroups = groupByModule(sortedLessons);

// Convert to array format for React component (Maps not serializable)
const modulesArray = Array.from(moduleGroups.entries())
  .sort(([a], [b]) => a.localeCompare(b))
  .map(([moduleId, lessons]) => [
    moduleId,
    lessons.map(lesson => ({
      title: lesson.data.title,
      slug: cleanSlug(lesson.id),
      difficulty: lesson.data.difficulty,
      estimatedTime: lesson.data.estimatedTime,
    }))
  ]);
---

<BaseLayout
  title="Курс Debezium: CDC паттерны для production"
  description="Научитесь проектировать и реализовывать production-ready CDC-пайплайны с использованием Debezium"
>
  <div class="prose prose-invert max-w-none">
    <h1 class="text-4xl font-bold text-gray-100 mb-4">
      Debezium: Change Data Capture для production
    </h1>

    <p class="text-lg text-gray-300 mb-8">
      Комплексный курс по проектированию и реализации CDC-пайплайнов на основе Debezium.
      От базовых концепций до production-ready архитектур с пониманием всех критических нюансов интеграций.
    </p>

    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-blue-300 mt-0 mb-2">Что вы получите</h2>
      <ul class="text-gray-300 mb-0">
        <li>Глубокое понимание CDC паттернов и архитектурных решений</li>
        <li>Практические навыки настройки Debezium для различных СУБД</li>
        <li>Знание производительностных нюансов и стратегий оптимизации</li>
        <li>Опыт обработки реальных production-сценариев</li>
      </ul>
    </div>

    <!-- Progress Tracking Section -->
    <div class="glass-panel p-6 mb-8">
      <div class="grid gap-6 lg:grid-cols-2">
        <div>
          <ProgressIndicator totalLessons={totalLessons} client:load />
        </div>
        <div>
          <ProgressExport client:load />
        </div>
      </div>
    </div>

    <h2 class="text-2xl font-bold text-gray-100 mb-6">Модули курса</h2>

    <div class="space-y-4 not-prose">
      <ModuleAccordion
        modules={modulesArray}
        basePath={import.meta.env.BASE_URL}
        client:load
      />
    </div>

    {sortedLessons.length === 0 && (
      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-6 text-center">
        <p class="text-yellow-300 mb-0">
          Уроки курса находятся в разработке. Скоро здесь появится контент!
        </p>
      </div>
    )}
  </div>
</BaseLayout>
