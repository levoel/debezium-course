---
phase: 04-lab-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - labs/docker-compose.yml
  - labs/README.md
autonomous: false

must_haves:
  truths:
    - "Full stack starts with single docker compose up command"
    - "All 8 services are healthy after startup"
    - "README guides students through first-time setup"
    - "Student can run verification notebook successfully"
  artifacts:
    - path: "labs/docker-compose.yml"
      provides: "Complete service orchestration"
      contains: "jupyter"
    - path: "labs/README.md"
      provides: "Student setup instructions"
      contains: "docker compose up"
  key_links:
    - from: "labs/docker-compose.yml"
      to: "labs/monitoring/prometheus.yml"
      via: "volume mount"
      pattern: "prometheus.yml:/etc/prometheus"
    - from: "labs/docker-compose.yml"
      to: "labs/jupyter/Dockerfile"
      via: "build context"
      pattern: "build:.*jupyter"
    - from: "labs/README.md"
      to: "labs/docker-compose.yml"
      via: "setup instructions"
      pattern: "docker compose"
---

<objective>
Integrate all lab components (monitoring, JupyterLab) into docker-compose.yml and create README with setup instructions.

Purpose: Deliver a complete, documented lab environment that students can start with one command.
Output: Updated docker-compose.yml with all 8 services and comprehensive README.md.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-lab-infrastructure/04-RESEARCH.md
@.planning/phases/04-lab-infrastructure/04-01-SUMMARY.md
@.planning/phases/04-lab-infrastructure/04-02-SUMMARY.md
@.planning/phases/04-lab-infrastructure/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add monitoring and JupyterLab services to docker-compose.yml</name>
  <files>labs/docker-compose.yml</files>
  <action>
Update labs/docker-compose.yml to add Prometheus, Grafana, and JupyterLab services.

Add these services after schema-registry (reference 04-02-SUMMARY and 04-03-SUMMARY for configs):

**Prometheus service:**
```yaml
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    depends_on:
      connect:
        condition: service_healthy
```

**Grafana service:**
```yaml
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
```

**JupyterLab service:**
```yaml
  jupyter:
    build:
      context: ./jupyter
      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/work
    environment:
      - JUPYTER_ENABLE_LAB=yes
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      connect:
        condition: service_healthy
```

**Add volumes:**
```yaml
volumes:
  postgres-data:
  kafka-data:
  prometheus-data:
  grafana-data:
```

Ensure proper network connectivity - all services use default Docker Compose network.
  </action>
  <verify>
`docker compose config` validates successfully
`grep -c "image:\|build:" labs/docker-compose.yml` returns 8 (postgres, kafka, connect, schema-registry, prometheus, grafana, jupyter = 7 images/builds, but schema-registry uses image)
  </verify>
  <done>docker-compose.yml contains all 8 services with correct dependencies and volume mounts</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive README with setup instructions</name>
  <files>labs/README.md</files>
  <action>
Create labs/README.md with clear setup instructions in Russian (course language).

Structure:
1. **Title and Overview** - What the lab environment provides
2. **Prerequisites** - Docker Desktop 4.x+, 8GB RAM, macOS M-series or Intel
3. **Quick Start** - 3 steps to get running
4. **Services** - Table of all services with ports and purposes
5. **Verification** - How to confirm everything works
6. **Common Tasks** - Creating connectors, viewing metrics, etc.
7. **Troubleshooting** - Common issues and solutions
8. **Cleanup** - How to stop and remove everything

Include:
- ARM64 compatibility note (research confirmed)
- Memory requirements (8GB minimum for all services)
- Port mapping table (5432, 9092, 8083, 8081, 9090, 3000, 8888)
- curl examples for Connect REST API
- Link to verification notebook

Key sections (in Russian):

```markdown
# Debezium Lab Environment

Лабораторная среда для практических упражнений курса по Debezium CDC.

## Требования

- Docker Desktop 4.x или выше
- 8 GB RAM (минимум)
- macOS (Apple Silicon M1/M2/M3 или Intel) / Linux / Windows с WSL2

## Быстрый старт

1. Запустите все сервисы:
   ```bash
   cd labs
   docker compose up -d
   ```

2. Дождитесь запуска (2-3 минуты):
   ```bash
   docker compose ps
   ```

3. Откройте JupyterLab: http://localhost:8888

## Сервисы

| Сервис | Порт | URL | Назначение |
|--------|------|-----|------------|
| PostgreSQL | 5432 | - | База данных с logical replication |
| Kafka | 9092 | - | Message broker (KRaft mode) |
| Kafka Connect | 8083 | http://localhost:8083 | Debezium connectors |
| Schema Registry | 8081 | http://localhost:8081 | Avro schema management |
| Prometheus | 9090 | http://localhost:9090 | Metrics collection |
| Grafana | 3000 | http://localhost:3000 | Monitoring dashboards |
| JupyterLab | 8888 | http://localhost:8888 | Python notebooks |

## Проверка установки

Запустите notebook `01-setup-verification.ipynb` в JupyterLab.

## Создание коннектора

[Include curl example for creating PostgreSQL connector]

## Остановка

docker compose down

## Полная очистка (включая данные)

docker compose down -v
```
  </action>
  <verify>File exists at labs/README.md with sections for Prerequisites, Quick Start, Services table</verify>
  <done>README provides complete setup guide in Russian with port table, verification steps, and troubleshooting</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full lab stack functionality</name>
  <what-built>
Complete Docker Compose lab environment with 8 services:
- PostgreSQL 15 with logical replication
- Kafka 3.x in KRaft mode
- Debezium Connect 3.0.8
- Schema Registry
- Prometheus + Grafana monitoring
- JupyterLab with Python CDC libraries
  </what-built>
  <how-to-verify>
1. Start the lab stack:
   ```bash
   cd labs
   docker compose up -d
   ```

2. Wait 2-3 minutes, then check all services are healthy:
   ```bash
   docker compose ps
   ```
   Expected: All 8 services show "healthy" or "running"

3. Verify core services:
   - Connect API: http://localhost:8083 (should show version JSON)
   - Schema Registry: http://localhost:8081/subjects (should return [])
   - Grafana: http://localhost:3000 (login: admin/admin)
   - JupyterLab: http://localhost:8888

4. Open JupyterLab and run `01-setup-verification.ipynb`:
   - All cells should execute without errors
   - PostgreSQL connection: OK
   - Kafka connection: OK
   - Connect API: OK

5. Check Grafana dashboard:
   - Navigate to Dashboards > Debezium > Debezium Connect Monitoring
   - Dashboard should load (may show no data until connectors are created)

6. Test creating a connector:
   ```bash
   curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d '{
     "name": "test-connector",
     "config": {
       "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
       "database.hostname": "postgres",
       "database.port": "5432",
       "database.user": "postgres",
       "database.password": "postgres",
       "database.dbname": "inventory",
       "topic.prefix": "dbserver1",
       "plugin.name": "pgoutput"
     }
   }'
   ```
   Then verify: `curl http://localhost:8083/connectors`
   Expected: ["test-connector"]

7. Stop and clean up:
   ```bash
   docker compose down
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Full stack verification checklist:

```bash
cd labs

# 1. Start everything
docker compose up -d

# 2. Wait and check status
sleep 60
docker compose ps

# 3. Check each service
# PostgreSQL
docker compose exec postgres psql -U postgres -c "SHOW wal_level;"

# Kafka
docker compose exec kafka kafka-topics.sh --bootstrap-server localhost:9092 --list

# Connect
curl -s http://localhost:8083/ | jq .version

# Schema Registry
curl -s http://localhost:8081/subjects

# Prometheus
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets | length'

# Grafana (check datasource)
curl -s -u admin:admin http://localhost:3000/api/datasources | jq '.[].name'

# JupyterLab (check it's running)
curl -s http://localhost:8888/api

# 4. Cleanup
docker compose down
```
</verification>

<success_criteria>
1. `docker compose up -d` starts all 8 services without errors
2. All services reach healthy/running state within 3 minutes
3. PostgreSQL has wal_level=logical
4. Kafka is in KRaft mode (no ZooKeeper container)
5. Connect REST API returns version 3.0.8.Final
6. Schema Registry responds on port 8081
7. Prometheus scrapes connect:9404 target
8. Grafana loads with Prometheus datasource and Debezium dashboard
9. JupyterLab accessible at localhost:8888
10. Verification notebook runs all cells successfully
11. Test connector creation succeeds
12. README provides clear instructions that work first try
</success_criteria>

<output>
After completion, create `.planning/phases/04-lab-infrastructure/04-04-SUMMARY.md`
</output>
