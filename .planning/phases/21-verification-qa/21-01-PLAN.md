---
phase: 21-verification-qa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - playwright.config.ts
  - tests/fixtures/error-tracking.ts
  - tests/e2e/navigation.spec.ts
  - tests/e2e/progress.spec.ts
autonomous: true

must_haves:
  truths:
    - "All internal navigation links return 200 status"
    - "Progress migration converts old slugs to new slugs"
    - "No console errors on any page"
    - "Migration flag prevents re-running migration"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with baseURL"
    - path: "tests/fixtures/error-tracking.ts"
      provides: "Auto console error detection fixture"
    - path: "tests/e2e/navigation.spec.ts"
      provides: "Navigation link verification tests"
    - path: "tests/e2e/progress.spec.ts"
      provides: "Progress migration verification tests"
  key_links:
    - from: "tests/e2e/*.spec.ts"
      to: "tests/fixtures/error-tracking.ts"
      via: "import { test, expect }"
      pattern: "from.*fixtures/error-tracking"
    - from: "tests/e2e/progress.spec.ts"
      to: "src/stores/progress.ts"
      via: "localStorage course-progress key"
      pattern: "course-progress"
---

<objective>
Setup Playwright E2E testing infrastructure and write tests for navigation links, progress migration, and console error detection.

Purpose: Verify all v1.2 reorganization changes work correctly before shipping.
Output: Working E2E test suite that validates navigation, progress persistence, and error-free pages.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-verification-qa/21-RESEARCH.md
@src/stores/progress.ts
@astro.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and create test infrastructure</name>
  <files>
    package.json
    playwright.config.ts
    tests/fixtures/error-tracking.ts
  </files>
  <action>
1. Install Playwright as dev dependency:
   ```bash
   npm install -D @playwright/test
   npx playwright install chromium
   ```
   (Only chromium needed for local verification - saves disk space)

2. Create playwright.config.ts at project root:
   ```typescript
   import { defineConfig } from '@playwright/test';

   export default defineConfig({
     testDir: './tests/e2e',
     fullyParallel: true,
     forbidOnly: !!process.env.CI,
     retries: process.env.CI ? 2 : 0,
     workers: process.env.CI ? 1 : undefined,
     reporter: 'list',
     use: {
       baseURL: 'http://localhost:4321/debezium-course',
       trace: 'on-first-retry',
     },
     webServer: {
       command: 'npm run preview',
       url: 'http://localhost:4321/debezium-course',
       reuseExistingServer: !process.env.CI,
     },
   });
   ```
   Note: baseURL includes /debezium-course because astro preview respects the base config.

3. Create tests/fixtures/error-tracking.ts with automatic console error detection:
   ```typescript
   import { test as baseTest, expect, Page } from '@playwright/test';

   type ErrorTrackingFixtures = {
     page: Page;
   };

   export const test = baseTest.extend<ErrorTrackingFixtures>({
     page: async ({ page }, use) => {
       const consoleErrors: string[] = [];
       const pageErrors: string[] = [];

       page.on('console', msg => {
         if (msg.type() === 'error') {
           consoleErrors.push(msg.text());
         }
       });

       page.on('pageerror', error => {
         pageErrors.push(error.message);
       });

       await use(page);

       expect(consoleErrors, 'Console errors detected').toEqual([]);
       expect(pageErrors, 'Page errors detected').toEqual([]);
     }
   });

   export { expect };
   ```

4. Add test scripts to package.json:
   ```json
   "scripts": {
     ...existing scripts...
     "test:e2e": "rm -rf .astro/ && npm run build && playwright test",
     "test:e2e:ui": "playwright test --ui"
   }
   ```
  </action>
  <verify>
    - `npx playwright --version` shows installed version
    - `ls tests/fixtures/error-tracking.ts` exists
    - `ls playwright.config.ts` exists
    - `npm run test:e2e` script is defined in package.json
  </verify>
  <done>Playwright installed, config created, error-tracking fixture ready for tests</done>
</task>

<task type="auto">
  <name>Task 2: Write navigation and progress E2E tests</name>
  <files>
    tests/e2e/navigation.spec.ts
    tests/e2e/progress.spec.ts
  </files>
  <action>
1. Create tests/e2e/navigation.spec.ts:
   ```typescript
   import { test, expect } from '../fixtures/error-tracking';

   test.describe('Navigation verification', () => {
     test('homepage loads without errors', async ({ page }) => {
       const response = await page.goto('/');
       expect(response?.status()).toBe(200);
     });

     test('all sidebar navigation links work', async ({ page }) => {
       await page.goto('/');

       // Get all internal navigation links from sidebar
       const links = await page.locator('nav a[href^="/debezium-course/course/"]').all();

       // Ensure we have links to test
       expect(links.length).toBeGreaterThan(0);

       const visited = new Set<string>();
       for (const link of links) {
         const href = await link.getAttribute('href');
         if (!href || visited.has(href)) continue;
         visited.add(href);

         // Navigate and verify 200 response
         const response = await page.goto(href);
         expect(response?.status(), `Failed for ${href}`).toBe(200);
       }
     });

     test('module pages are accessible', async ({ page }) => {
       // Test key module entry points after reorganization
       const modulePaths = [
         '/course/01-module-1/01-intro/',
         '/course/02-module-2/01-intro/',
         '/course/03-module-3/01-intro/',  // MySQL (moved from 08)
         '/course/04-module-4/01-intro/',
         '/course/05-module-5/01-intro/',
         '/course/06-module-6/01-intro/',
         '/course/07-module-7/01-intro/',
         '/course/08-module-8/01-intro/',  // Capstone (moved from 07)
       ];

       for (const path of modulePaths) {
         const response = await page.goto(path);
         expect(response?.status(), `Failed for ${path}`).toBe(200);
       }
     });
   });
   ```

2. Create tests/e2e/progress.spec.ts:
   ```typescript
   import { test, expect } from '../fixtures/error-tracking';

   test.describe('Progress migration verification', () => {
     test('migration converts old module-8 slugs to module-3', async ({ page }) => {
       // Seed old progress data (pre-v1.2 format)
       await page.goto('/');
       await page.evaluate(() => {
         localStorage.removeItem('course-progress-v1.2-migrated');
         const oldProgress = {
           completed: [
             '08-module-8/01-intro',  // Old MySQL position
             '01-module-1/01-intro',  // Should not change
           ],
           lastUpdated: Date.now()
         };
         localStorage.setItem('course-progress', JSON.stringify(oldProgress));
       });

       // Reload to trigger migration
       await page.reload();

       // Wait for migration flag
       await page.waitForFunction(() =>
         localStorage.getItem('course-progress-v1.2-migrated') === 'true',
         { timeout: 5000 }
       );

       // Verify slugs were updated
       const migratedProgress = await page.evaluate(() =>
         JSON.parse(localStorage.getItem('course-progress') || '{}')
       );

       expect(migratedProgress.completed).toContain('03-module-3/01-intro');
       expect(migratedProgress.completed).toContain('01-module-1/01-intro');
       expect(migratedProgress.completed).not.toContain('08-module-8/01-intro');
     });

     test('migration handles module chain correctly', async ({ page }) => {
       // Test the full chain: 08->03, 03->04, 04->05, etc.
       await page.goto('/');
       await page.evaluate(() => {
         localStorage.removeItem('course-progress-v1.2-migrated');
         const oldProgress = {
           completed: [
             '03-module-3/01-config',  // Old Production Ops -> 04
             '04-module-4/01-patterns', // Old Advanced -> 05
             '07-module-7/01-capstone', // Old Capstone -> 08
           ],
           lastUpdated: Date.now()
         };
         localStorage.setItem('course-progress', JSON.stringify(oldProgress));
       });

       await page.reload();

       await page.waitForFunction(() =>
         localStorage.getItem('course-progress-v1.2-migrated') === 'true',
         { timeout: 5000 }
       );

       const migratedProgress = await page.evaluate(() =>
         JSON.parse(localStorage.getItem('course-progress') || '{}')
       );

       expect(migratedProgress.completed).toContain('04-module-4/01-config');
       expect(migratedProgress.completed).toContain('05-module-5/01-patterns');
       expect(migratedProgress.completed).toContain('08-module-8/01-capstone');
     });

     test('migration flag prevents re-running', async ({ page }) => {
       await page.goto('/');

       // Set migration flag and some progress
       await page.evaluate(() => {
         localStorage.setItem('course-progress-v1.2-migrated', 'true');
         const progress = {
           completed: ['08-module-8/01-intro'],  // "Old" slug
           lastUpdated: Date.now()
         };
         localStorage.setItem('course-progress', JSON.stringify(progress));
       });

       await page.reload();
       await page.waitForTimeout(1000);  // Give time for any migration to run

       // Should NOT have migrated (flag was set)
       const progress = await page.evaluate(() =>
         JSON.parse(localStorage.getItem('course-progress') || '{}')
       );

       expect(progress.completed).toContain('08-module-8/01-intro');
       expect(progress.completed).not.toContain('03-module-3/01-intro');
     });

     test('empty progress sets migration flag without error', async ({ page }) => {
       await page.goto('/');

       // Clear all progress data
       await page.evaluate(() => {
         localStorage.removeItem('course-progress');
         localStorage.removeItem('course-progress-v1.2-migrated');
       });

       await page.reload();

       // Migration should complete (set flag) even with no data
       await page.waitForFunction(() =>
         localStorage.getItem('course-progress-v1.2-migrated') === 'true',
         { timeout: 5000 }
       );
     });
   });
   ```
  </action>
  <verify>
    - `ls tests/e2e/navigation.spec.ts` exists
    - `ls tests/e2e/progress.spec.ts` exists
    - `npm run test:e2e` runs and all tests pass
  </verify>
  <done>Navigation tests verify all links work, progress tests verify migration logic</done>
</task>

<task type="auto">
  <name>Task 3: Run verification suite and fix any issues</name>
  <files>
    (no new files - execution and verification)
  </files>
  <action>
1. Clear Astro cache and build:
   ```bash
   rm -rf .astro/
   npm run build
   ```

2. Run the full E2E test suite:
   ```bash
   npm run test:e2e
   ```

3. If tests fail:
   - Navigation failures: Check if href patterns in test match actual nav structure
   - Progress migration failures: Check if migrateModuleSlugs() is called on page load
   - Console errors: Investigate and fix any JavaScript errors

4. After all tests pass, verify manually by running preview:
   ```bash
   npm run preview
   ```
   Visit http://localhost:4321/debezium-course/ and spot-check navigation.

5. Commit the test infrastructure:
   ```bash
   git add package.json package-lock.json playwright.config.ts tests/
   git commit -m "test(21-01): add Playwright E2E tests for v1.2 verification

   - Navigation link verification (all sidebar links return 200)
   - Progress migration tests (old slugs -> new slugs)
   - Console error detection fixture (automatic per-test)
   - Module accessibility tests (all 8 modules accessible)"
   ```
  </action>
  <verify>
    - `npm run test:e2e` shows all tests passing
    - No console errors during test run
    - Git commit created with test files
  </verify>
  <done>All E2E tests pass, verifying navigation works and progress migrates correctly</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Navigation verification (STRUCT-01f):**
   - `npm run test:e2e` passes navigation tests
   - All sidebar links return 200 status
   - All 8 module entry points accessible

2. **Progress persistence (STRUCT-01g):**
   - Migration tests pass (old slugs -> new slugs)
   - Migration flag prevents duplicate runs
   - Empty progress handles gracefully

3. **Console error detection:**
   - Error-tracking fixture catches any console.error
   - No uncaught exceptions on any page

4. **Build verification:**
   - `npm run build` completes without errors
   - `npm run preview` serves site correctly
</verification>

<success_criteria>
- [ ] Playwright installed and configured
- [ ] Error-tracking fixture created
- [ ] Navigation tests pass (all links return 200)
- [ ] Progress migration tests pass (4 test cases)
- [ ] No console errors detected
- [ ] Test infrastructure committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/21-verification-qa/21-01-SUMMARY.md`
</output>
