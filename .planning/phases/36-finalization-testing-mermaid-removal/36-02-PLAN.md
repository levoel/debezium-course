---
phase: 36-finalization-testing-mermaid-removal
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - tests/e2e/diagrams.spec.ts
  - src/components/Mermaid.tsx
  - src/pages/mermaid-test.astro
  - package.json
autonomous: true

must_haves:
  truths:
    - "Mobile viewport tests confirm diagrams fit iPhone 12 viewport (390x844)"
    - "Mermaid.tsx component is deleted from src/components/"
    - "mermaid-test.astro page is deleted from src/pages/"
    - "mermaid package is removed from package.json dependencies"
  artifacts:
    - path: "tests/e2e/diagrams.spec.ts"
      provides: "Mobile responsiveness tests added to existing diagram tests"
      contains: "Mobile responsiveness"
    - path: "package.json"
      provides: "Clean dependency list without mermaid"
      excludes: "mermaid"
  key_links:
    - from: "package.json"
      to: "node_modules"
      via: "npm install after removal"
      pattern: "dependencies.*without.*mermaid"
---

<objective>
Add mobile viewport tests to diagrams.spec.ts, then safely remove Mermaid dependency.

Purpose: Verify diagrams work on mobile devices and eliminate unused Mermaid code (~2.3MB bundle savings).

Output: Mobile tests passing + Mermaid completely removed from codebase.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-finalization/36-RESEARCH.md
@.planning/phases/36-finalization-testing-mermaid-removal/36-01-SUMMARY.md

Files to remove:
@src/components/Mermaid.tsx
@src/pages/mermaid-test.astro

Package file:
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mobile responsiveness tests</name>
  <files>tests/e2e/diagrams.spec.ts</files>
  <action>
Extend `tests/e2e/diagrams.spec.ts` with mobile viewport tests:

1. Add new describe block "Mobile responsiveness" after the existing "Glass diagram rendering" block
2. Create test "diagrams fit iPhone 12 viewport (390x844)":
   - Set viewport to 390x844 (iPhone 12 dimensions)
   - Navigate to a diagram-heavy lesson (02-debezium-architecture has multiple diagrams)
   - waitForLoadState('networkidle')
   - Check document scrollWidth <= 390 (no horizontal overflow)
   - Verify at least one diagram is visible

3. Create test "diagrams visible on mobile":
   - Set viewport to 390x844
   - Navigate to 01-cdc-fundamentals
   - Verify diagram containers are visible (not display:none)
   - Verify diagrams have reasonable width (> 200px, not squashed)

Pattern:
```typescript
test.describe('Mobile responsiveness', () => {
  test('diagrams fit iPhone 12 viewport (390x844)', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto(`${BASE}/course/01-module-1/02-debezium-architecture`);
    await page.waitForLoadState('networkidle');

    // Check no horizontal scroll needed
    const scrollWidth = await page.evaluate(() => document.documentElement.scrollWidth);
    expect(scrollWidth).toBeLessThanOrEqual(390);

    // Verify diagrams are present
    const diagrams = await page.locator('figure[role="figure"]').count();
    expect(diagrams).toBeGreaterThan(0);
  });

  test('diagrams visible and not squashed on mobile', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto(`${BASE}/course/01-module-1/01-cdc-fundamentals`);
    await page.waitForLoadState('networkidle');

    const firstDiagram = page.locator('figure[role="figure"]').first();
    await expect(firstDiagram).toBeVisible();

    // Verify diagram has reasonable width (not squashed to tiny size)
    const box = await firstDiagram.boundingBox();
    expect(box?.width).toBeGreaterThan(200);
  });
});
```
  </action>
  <verify>tests/e2e/diagrams.spec.ts contains "Mobile responsiveness" describe block with 2 tests</verify>
  <done>Mobile responsiveness tests added to diagram test file</done>
</task>

<task type="auto">
  <name>Task 2: Remove Mermaid files and dependency</name>
  <files>src/components/Mermaid.tsx, src/pages/mermaid-test.astro, package.json</files>
  <action>
Remove Mermaid from the codebase following the safe removal procedure from RESEARCH.md:

1. Delete Mermaid component:
   ```bash
   rm src/components/Mermaid.tsx
   ```

2. Delete Mermaid test page:
   ```bash
   rm src/pages/mermaid-test.astro
   ```

3. Verify build still works (catches any hidden imports):
   ```bash
   npm run build
   ```
   If build fails with "mermaid" in error, search for remaining imports and remove them.

4. Edit package.json to remove mermaid from dependencies:
   - Remove the line: `"mermaid": "^11.12.2",`
   - Do NOT touch other dependencies

5. Clean install to remove mermaid from node_modules:
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```

6. Verify final build works:
   ```bash
   npm run build
   ```

IMPORTANT: The research confirms NO course MDX files use Mermaid. Only the deleted test page referenced it.
  </action>
  <verify>
- `ls src/components/Mermaid.tsx` returns "No such file"
- `ls src/pages/mermaid-test.astro` returns "No such file"
- `grep mermaid package.json` returns no results
- `npm run build` completes successfully
  </verify>
  <done>Mermaid component, test page, and dependency completely removed</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite after removal</name>
  <files></files>
  <action>
Run the complete E2E test suite to verify nothing broke:

1. Run tests:
   ```bash
   npm run test:e2e
   ```

2. Verify:
   - All diagram smoke tests pass (8 modules)
   - All mobile responsiveness tests pass (2 tests)
   - All accessibility tests pass (including new diagram keyboard tests)
   - All existing navigation and progress tests pass

3. If any tests fail, diagnose and fix:
   - Check if removal of Mermaid affected any test pages
   - Verify all imports are correct
   - Re-run tests

Expected: All tests pass. The Mermaid removal should have ZERO impact on course content since no MDX files used it.
  </action>
  <verify>`npm run test:e2e` passes with 0 failures after Mermaid removal</verify>
  <done>Full test suite passes, confirming Mermaid removal did not break anything</done>
</task>

</tasks>

<verification>
1. `tests/e2e/diagrams.spec.ts` contains mobile viewport tests
2. `src/components/Mermaid.tsx` does not exist
3. `src/pages/mermaid-test.astro` does not exist
4. `package.json` does not contain "mermaid"
5. `npm run build` succeeds
6. `npm run test:e2e` passes all tests
</verification>

<success_criteria>
- Mobile viewport test confirms no horizontal overflow at 390x844
- Diagrams visible and not squashed on mobile (width > 200px)
- Mermaid.tsx component deleted
- mermaid-test.astro page deleted
- mermaid removed from package.json
- Build succeeds without mermaid
- All E2E tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/36-finalization-testing-mermaid-removal/36-02-SUMMARY.md`
</output>
