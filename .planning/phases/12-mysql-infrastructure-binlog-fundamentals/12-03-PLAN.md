---
phase: 12-mysql-infrastructure-binlog-fundamentals
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx
  - src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx
autonomous: true

must_haves:
  truths:
    - "Learner can explain GTID (Global Transaction Identifier) structure and benefits"
    - "Learner understands why GTID mode is critical for CDC failover scenarios"
    - "Learner knows how to configure enforce-gtid-consistency"
    - "Learner can configure binlog retention for CDC reliability"
    - "Learner understands heartbeat events and their role in preventing position loss"
  artifacts:
    - path: "src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx"
      provides: "GTID mode deep-dive lesson"
      min_lines: 180
      contains: "gtid_mode"
    - path: "src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx"
      provides: "Retention and heartbeat lesson"
      min_lines: 150
      contains: "binlog_expire_logs_seconds"
  key_links:
    - from: "src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx"
      to: "src/content/course/08-module-8/01-binlog-architecture.mdx"
      via: "prerequisite reference"
      pattern: "prerequisites.*01-binlog"
    - from: "src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx"
      to: "Debezium heartbeat configuration"
      via: "connector config reference"
      pattern: "heartbeat.interval.ms"
---

<objective>
Create two lessons covering GTID mode fundamentals and binlog retention/heartbeat configuration for reliable MySQL CDC.

Purpose: Learners need to understand GTID for failover resilience and retention/heartbeat to prevent the common pitfall of binlog position loss. These are critical production concepts.

Output: Two lesson files completing the Phase 12 content requirements (MYSQL-02, MYSQL-03).
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-mysql-infrastructure-binlog-fundamentals/12-RESEARCH.md
@src/content/course/02-module-2/01-logical-decoding-deep-dive.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GTID mode fundamentals lesson</name>
  <files>
    src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx
  </files>
  <action>
Create `02-gtid-mode-fundamentals.mdx` covering Global Transaction Identifiers for CDC.

**Frontmatter:**
```yaml
---
title: "GTID Mode: Глобальные идентификаторы транзакций"
description: "GTID architecture, конфигурация gtid-mode и enforce-gtid-consistency, преимущества для CDC и failover сценариев"
order: 2
difficulty: "intermediate"
estimatedTime: 25
topics: ["mysql", "gtid", "replication", "failover"]
prerequisites: ["module-8/01-binlog-architecture"]
---
```

**Content structure:**

1. **Introduction: The Position Tracking Problem**
   - Traditional position tracking: filename + offset (mysql-bin.000003:154)
   - Problem: After failover, position changes on new primary
   - Solution: Global Transaction Identifiers

2. **GTID Anatomy** - Mermaid diagram
   - Format: `source_id:transaction_id` (e.g., `3E11FA47-71CA-11E1-9E33-C80AA9429562:1-5`)
   - source_id = server UUID (unique per MySQL instance)
   - transaction_id = monotonically increasing sequence
   - GTID set example: `3E11FA47-...:1-100, 4E22GB58-...:1-50`

3. **Why GTID Matters for CDC**
   - **Failover resilience**: Debezium can continue from same GTID on new primary
   - **Position independence**: No need to recalculate offsets after topology change
   - **Gap detection**: Easy to identify missing transactions
   - Comparison with PostgreSQL LSN (which is local to a server)

4. **Configuring GTID Mode** - practical configuration
   ```bash
   # Required settings (already in our docker-compose.yml)
   --gtid-mode=ON
   --enforce-gtid-consistency=ON
   ```

   Explain enforce-gtid-consistency:
   - Blocks unsafe statements: CREATE TABLE...SELECT, transactions mixing storage engines
   - Why it's mandatory with gtid-mode=ON
   - Common errors when disabled

5. **GTID in Action** - SQL verification commands
   ```sql
   -- Check GTID mode
   SHOW VARIABLES LIKE 'gtid_mode';
   -- Expected: ON

   -- View executed GTIDs
   SHOW GLOBAL VARIABLES LIKE 'gtid_executed';
   -- Shows all transactions this server has executed

   -- View purged GTIDs (no longer in binlog)
   SHOW GLOBAL VARIABLES LIKE 'gtid_purged';
   -- Important: If Debezium needs purged GTIDs, full resnapshot required
   ```

6. **GTID vs File Position: Debezium Configuration**
   - Debezium tracks GTID by default when available
   - schema.history.internal.kafka.topic stores GTID position
   - Example from connector offset storage

7. **Common GTID Pitfalls**
   - enforce-gtid-consistency=OFF leads to replication breaks
   - gtid_purged grows when binlogs expire - monitor this
   - Mixing GTID and non-GTID servers in topology

8. **Key Takeaways** - bullet points
9. **What's Next** - preview retention/heartbeat lesson

**Style:** Russian text, English code, Mermaid diagrams, tables for comparisons
  </action>
  <verify>
File exists: `ls "/Users/levoely/debezium course/src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx"`

Content includes key concepts:
- `grep "gtid_mode" "/Users/levoely/debezium course/src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx"`
- `grep "enforce-gtid-consistency" "/Users/levoely/debezium course/src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx"`
- `grep "failover" "/Users/levoely/debezium course/src/content/course/08-module-8/02-gtid-mode-fundamentals.mdx"`

Line count > 180
  </verify>
  <done>
02-gtid-mode-fundamentals.mdx exists with GTID architecture, configuration requirements, CDC benefits, and verification commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create binlog retention and heartbeat lesson</name>
  <files>
    src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx
  </files>
  <action>
Create `03-binlog-retention-heartbeat.mdx` covering binlog retention configuration and heartbeat events for CDC reliability.

**Frontmatter:**
```yaml
---
title: "Binlog Retention и Heartbeat: Защита от потери позиции"
description: "Настройка binlog_expire_logs_seconds, предотвращение purge до чтения Debezium, heartbeat events для idle периодов"
order: 3
difficulty: "intermediate"
estimatedTime: 20
topics: ["mysql", "binlog", "retention", "heartbeat", "monitoring"]
prerequisites: ["module-8/02-gtid-mode-fundamentals"]
---
```

**Content structure:**

1. **The Retention Problem** - Mermaid timeline diagram
   - Binlog files grow continuously
   - MySQL purges old files automatically (binlog_expire_logs_seconds)
   - If Debezium is offline longer than retention period -> DISASTER
   - Error message: "Cannot replicate because the master purged required binary logs"
   - Recovery: Full resnapshot (can take hours/days for large databases)

2. **Configuring Binlog Retention**
   ```sql
   -- Check current retention
   SHOW VARIABLES LIKE 'binlog_expire_logs_seconds';
   -- Default: 2592000 (30 days)
   -- Our config: 604800 (7 days)

   -- Check binlog disk usage
   SHOW BINARY LOGS;

   -- Manual purge (dangerous - know what you're doing)
   PURGE BINARY LOGS TO 'mysql-bin.000010';
   ```

   Retention planning formula:
   - Max expected Debezium downtime + safety margin
   - Example: 3 days downtime expected -> 7 days retention minimum
   - Trade-off: Disk space vs recovery safety

3. **Deprecated: expire_logs_days**
   - Old parameter (MySQL 5.x style)
   - binlog_expire_logs_seconds is the current standard
   - If both set, seconds takes precedence
   - Mention for learners who see old tutorials

4. **The Idle Table Problem**
   - Scenario: Table receives no changes for weeks
   - Debezium position points to old binlog file
   - Binlog file gets purged
   - Next change causes position loss error
   - This is why heartbeats exist!

5. **Heartbeat Events** - Mermaid sequence diagram
   - Debezium periodically writes to a heartbeat table
   - This creates binlog events even on idle databases
   - Keeps Debezium position current
   - Configuration:
   ```json
   {
     "name": "mysql-connector",
     "config": {
       "heartbeat.interval.ms": "10000",
       "heartbeat.action.query": "INSERT INTO debezium_heartbeat (id, ts) VALUES (1, NOW()) ON DUPLICATE KEY UPDATE ts = NOW()"
     }
   }
   ```

6. **Creating the Heartbeat Table**
   ```sql
   -- Heartbeat table for Debezium
   CREATE TABLE IF NOT EXISTS debezium_heartbeat (
     id INT PRIMARY KEY,
     ts TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
   ) ENGINE=InnoDB;

   -- Grant access to Debezium user
   GRANT INSERT, UPDATE ON inventory.debezium_heartbeat TO 'debezium'@'%';
   ```

7. **Monitoring Binlog Health**
   - Key metrics to watch:
     - Total binlog size (disk pressure)
     - Oldest binlog file age vs retention
     - Debezium lag (seconds behind)
   - JMX metric: `MilliSecondsBehindSource`
   - Alert: If lag approaches retention period

8. **Recovery When Position Is Lost**
   - Don't panic - it's recoverable
   - Options:
     1. Trigger full resnapshot (snapshot.mode=initial)
     2. Reset offset to specific GTID (advanced)
   - Prevention is better than recovery

9. **Key Takeaways** - bullet points summarizing retention, heartbeat, monitoring
10. **What's Next** - preview connector setup in Phase 13

**Style:** Russian text, English code, warning callouts for dangerous operations
  </action>
  <verify>
File exists: `ls "/Users/levoely/debezium course/src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx"`

Content includes key concepts:
- `grep "binlog_expire_logs_seconds" "/Users/levoely/debezium course/src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx"`
- `grep "heartbeat" "/Users/levoely/debezium course/src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx"`
- `grep "heartbeat.interval.ms" "/Users/levoely/debezium course/src/content/course/08-module-8/03-binlog-retention-heartbeat.mdx"`

Line count > 150
  </verify>
  <done>
03-binlog-retention-heartbeat.mdx exists with retention configuration, heartbeat setup, monitoring guidance, and recovery procedures.
  </done>
</task>

</tasks>

<verification>
1. Both lesson files exist in src/content/course/08-module-8/
2. 02-gtid-mode-fundamentals.mdx covers GTID anatomy, configuration, CDC benefits
3. 03-binlog-retention-heartbeat.mdx covers retention, heartbeat, and monitoring
4. Frontmatter is valid with correct prerequisites chain
5. Code examples include all referenced SQL and JSON configs
6. Mermaid diagrams are properly formatted
</verification>

<success_criteria>
- 02-gtid-mode-fundamentals.mdx created with 180+ lines
- 03-binlog-retention-heartbeat.mdx created with 150+ lines
- GTID lesson explains gtid_mode, enforce-gtid-consistency, and failover benefits
- Retention lesson explains binlog_expire_logs_seconds and heartbeat.interval.ms
- Both lessons follow established style (Russian text, English code)
- Prerequisites chain is correct (01 -> 02 -> 03)
</success_criteria>

<output>
After completion, create `.planning/phases/12-mysql-infrastructure-binlog-fundamentals/12-03-SUMMARY.md`
</output>
