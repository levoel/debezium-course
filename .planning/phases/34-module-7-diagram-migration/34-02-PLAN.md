---
phase: 34-module-7-diagram-migration
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/components/diagrams/module7/IamWorkloadDiagrams.tsx
  - src/components/diagrams/module7/DataflowBigQueryDiagrams.tsx
autonomous: true

must_haves:
  truths:
    - "User can see Workload Identity authentication flow"
    - "User can see CDC → BigQuery pipeline architecture"
    - "User can see end-to-end Dataflow workflow with stages"
    - "User can click IAM/security nodes to see Russian explanations"
    - "Dataflow pipeline shows changelog vs replica table pattern"
  artifacts:
    - path: "src/components/diagrams/module7/IamWorkloadDiagrams.tsx"
      provides: "1 diagram for lesson 03 (Workload Identity flow)"
      exports: ["WorkloadIdentityFlowDiagram"]
    - path: "src/components/diagrams/module7/DataflowBigQueryDiagrams.tsx"
      provides: "2 diagrams for lesson 04 (CDC to BigQuery pipeline)"
      exports: ["CdcToBigQueryDiagram", "DataflowEndToEndWorkflowDiagram"]
  key_links:
    - from: "IamWorkloadDiagrams.tsx"
      to: "SequenceDiagram primitive"
      via: "import for authentication flow"
      pattern: "import.*SequenceDiagram"
    - from: "DataflowBigQueryDiagrams.tsx"
      to: "gcp-compute, gcp-storage variants"
      via: "Dataflow and BigQuery nodes"
      pattern: "variant=\"gcp-(compute|storage)"
---

<objective>
Create IAM/Workload Identity and Dataflow/BigQuery diagrams for Module 7 lessons 03-04.

Purpose: Visualize GCP security patterns (Workload Identity Federation) and managed streaming pipelines (Dataflow CDC replication to BigQuery). Demonstrates complex multi-stage GCP architectures with authentication flows and data lake patterns.

Output:
- IamWorkloadDiagrams.tsx with 1 sequence diagram
- DataflowBigQueryDiagrams.tsx with 2 diagrams (architecture + end-to-end)
- 3 total diagrams with Russian tooltips for GCP patterns
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-module-7-diagram-migration/34-RESEARCH.md

# Source MDX files
@src/content/course/07-module-7/03-iam-workload-identity.mdx
@src/content/course/07-module-7/04-dataflow-bigquery.mdx

# Reference primitives
@src/components/diagrams/primitives/SequenceDiagram.tsx
@src/components/diagrams/primitives/FlowNode.tsx
@src/components/diagrams/primitives/DiagramContainer.tsx

# Reference Wave 1 output (will exist after 34-01)
@src/components/diagrams/primitives/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IamWorkloadDiagrams.tsx (1 sequence diagram)</name>
  <files>src/components/diagrams/module7/IamWorkloadDiagrams.tsx</files>
  <action>
Create IamWorkloadDiagrams.tsx with 1 diagram for lesson 03.

**WorkloadIdentityFlowDiagram** (sequence diagram showing authentication chain)

Pattern: K8s Pod → K8s SA → Workload Identity → GCP SA → Pub/Sub API

```typescript
import React from 'react';
import { SequenceDiagram } from '../primitives/SequenceDiagram';
import { DiagramContainer } from '../primitives/DiagramContainer';

export function WorkloadIdentityFlowDiagram() {
  return (
    <DiagramContainer
      title="Workload Identity поток аутентификации"
      color="purple"
      description="K8s Service Account → GCP Service Account binding без ключей"
    >
      <SequenceDiagram
        actors={[
          {
            id: 'pod',
            label: 'Pod в GKE',
            variant: 'service',
            tooltip: (
              <div>
                <p className="font-semibold mb-1">Kubernetes Pod</p>
                <p className="text-sm">Запускается с K8s Service Account аннотацией</p>
                <p className="text-sm mt-1">serviceAccountName: debezium-sa</p>
              </div>
            )
          },
          {
            id: 'ksa',
            label: 'K8s Service Account',
            variant: 'service',
            tooltip: (
              <div>
                <p className="font-semibold mb-1">Kubernetes SA</p>
                <p className="text-sm">Аннотация:</p>
                <p className="text-xs font-mono mt-1">iam.gke.io/gcp-service-account=debezium@project.iam</p>
              </div>
            )
          },
          {
            id: 'wi',
            label: 'Workload Identity',
            variant: 'external',
            tooltip: (
              <div>
                <p className="font-semibold mb-1">GKE Metadata Server</p>
                <p className="text-sm">Предоставляет GCP access token pod'у автоматически</p>
                <p className="text-sm mt-1">Токен автоматически ротируется каждый час</p>
              </div>
            )
          },
          {
            id: 'gcpsa',
            label: 'GCP Service Account',
            variant: 'external',
            tooltip: (
              <div>
                <p className="font-semibold mb-1">GCP Service Account</p>
                <p className="text-sm">IAM роли:</p>
                <p className="text-xs mt-1">• roles/pubsub.publisher</p>
                <p className="text-xs">• roles/cloudsql.client</p>
              </div>
            )
          },
          {
            id: 'api',
            label: 'Pub/Sub API',
            variant: 'queue',
            tooltip: (
              <div>
                <p className="font-semibold mb-1">Google Cloud APIs</p>
                <p className="text-sm">Проверяет IAM роли GCP SA перед доступом</p>
              </div>
            )
          }
        ]}
        messages={[
          {
            id: '1',
            from: 'pod',
            to: 'ksa',
            label: 'Использует K8s SA',
            variant: 'sync',
            tooltip: "Pod указывает serviceAccountName в манифесте"
          },
          {
            id: '2',
            from: 'ksa',
            to: 'wi',
            label: 'Аннотация связывает',
            variant: 'async',
            tooltip: "Workload Identity binding создается через gcloud iam service-accounts add-iam-policy-binding"
          },
          {
            id: '3',
            from: 'wi',
            to: 'gcpsa',
            label: 'Запрос GCP токена',
            variant: 'sync',
            tooltip: "GKE Metadata Server выдает short-lived OAuth 2.0 token"
          },
          {
            id: '4',
            from: 'gcpsa',
            to: 'pod',
            label: 'Токен (1h TTL)',
            variant: 'response',
            tooltip: "Access token действителен 1 час, автоматически обновляется"
          },
          {
            id: '5',
            from: 'pod',
            to: 'api',
            label: 'Аутентифицированный вызов',
            variant: 'sync',
            tooltip: "Pod использует токен в Authorization: Bearer header"
          },
          {
            id: '6',
            from: 'api',
            to: 'pod',
            label: 'API Response',
            variant: 'response',
            tooltip: "Pub/Sub API проверяет IAM роли и возвращает результат"
          }
        ]}
        messageSpacing={55}
      />

      <div className="mt-4 pt-3 border-t border-white/10">
        <div className="grid md:grid-cols-2 gap-4 text-xs">
          <div>
            <h3 className="font-semibold text-emerald-200 mb-1">✅ Workload Identity (Рекомендуется)</h3>
            <ul className="text-emerald-200/70 space-y-1">
              <li>• Токен автоматически ротируется каждый час</li>
              <li>• Нет ключей для хранения и ротации</li>
              <li>• Аудит через Cloud Logging</li>
              <li>• Least privilege IAM роли</li>
            </ul>
          </div>
          <div>
            <h3 className="font-semibold text-rose-200 mb-1">❌ Service Account Keys (Не делайте)</h3>
            <ul className="text-rose-200/70 space-y-1">
              <li>• key.json может утечь в git/logs</li>
              <li>• Нет автоматической ротации</li>
              <li>• Сложный аудит утечек</li>
              <li>• Долгоживущие credentials</li>
            </ul>
          </div>
        </div>
      </div>
    </DiagramContainer>
  );
}
```

**Key features:**
- SequenceDiagram with 5 actors showing authentication chain
- 6 messages with Russian tooltips
- messageSpacing=55 for clarity
- Comparison footer (Workload Identity vs Service Account Keys anti-pattern)
- Uses variant='external' for GCP-side actors
  </action>
  <verify>
- File exists at src/components/diagrams/module7/IamWorkloadDiagrams.tsx
- Exports WorkloadIdentityFlowDiagram component
- Uses SequenceDiagram primitive with 5 actors, 6 messages
- All tooltips in Russian
- Comparison footer shows anti-pattern warning
- No TypeScript errors
  </verify>
  <done>
WorkloadIdentityFlowDiagram created with 5-actor sequence, Russian tooltips, anti-pattern warning
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DataflowBigQueryDiagrams.tsx (2 diagrams)</name>
  <files>src/components/diagrams/module7/DataflowBigQueryDiagrams.tsx</files>
  <action>
Create DataflowBigQueryDiagrams.tsx with 2 diagrams for lesson 04.

**1. CdcToBigQueryDiagram** (horizontal multi-stage pipeline)

Shows: Cloud SQL → Debezium Server → Pub/Sub → Dataflow → BigQuery (Changelog + Replica tables)

```typescript
import React from 'react';
import { FlowNode } from '../primitives/FlowNode';
import { Arrow } from '../primitives/Arrow';
import { DiagramContainer } from '../primitives/DiagramContainer';
import { Tooltip } from '../primitives/Tooltip';

export function CdcToBigQueryDiagram() {
  return (
    <DiagramContainer
      title="Архитектура CDC → BigQuery"
      color="blue"
      description="Managed Dataflow template для репликации CDC событий"
    >
      <div className="flex flex-col gap-6">
        {/* Source Stage */}
        <div className="flex items-center gap-3 justify-center">
          <DiagramContainer title="Source" color="purple" className="flex-shrink-0">
            <Tooltip content="Cloud SQL PostgreSQL с logical decoding настроенным">
              <FlowNode variant="gcp-database" size="sm">
                Cloud SQL<br/>PostgreSQL
              </FlowNode>
            </Tooltip>
          </DiagramContainer>

          <Arrow direction="right" label="WAL" />

          <DiagramContainer title="CDC Engine" color="emerald">
            <Tooltip content="Debezium Server читает WAL и публикует в Pub/Sub">
              <FlowNode variant="connector" size="sm">
                Debezium<br/>Server
              </FlowNode>
            </Tooltip>
          </DiagramContainer>

          <Arrow direction="right" label="CDC Events" />

          <DiagramContainer title="Messaging" color="amber">
            <Tooltip content="Pub/Sub Topics с ordering enabled для сохранения порядка событий">
              <FlowNode variant="gcp-messaging" size="sm">
                Pub/Sub<br/>Topics
              </FlowNode>
            </Tooltip>
          </DiagramContainer>
        </div>

        {/* Processing Stage */}
        <div className="flex items-center gap-3 justify-center">
          <DiagramContainer title="Stream Processing" color="emerald">
            <div className="flex flex-col gap-2">
              <Tooltip content="Managed Dataflow template: Pub/Sub CDC to BigQuery">
                <FlowNode variant="gcp-compute" size="sm">
                  Dataflow Job
                </FlowNode>
              </Tooltip>
              <div className="text-xs text-emerald-200/70 text-center">
                MERGE каждые 60s
              </div>
            </div>
          </DiagramContainer>

          <div className="flex flex-col gap-2">
            <Arrow direction="right" label="Raw Events" />
            <Arrow direction="right" label="MERGE" dashed />
          </div>

          <DiagramContainer title="Storage" color="blue">
            <div className="flex flex-col gap-2">
              <Tooltip content={
                <div>
                  <p className="font-semibold mb-1">Changelog Table</p>
                  <p className="text-sm">Staging: полная история всех CDC операций</p>
                  <p className="text-sm mt-1">Партиционирована по _metadata_timestamp</p>
                </div>
              }>
                <FlowNode variant="gcp-storage" size="sm">
                  BigQuery<br/>Changelog
                </FlowNode>
              </Tooltip>
              <Tooltip content={
                <div>
                  <p className="font-semibold mb-1">Replica Table</p>
                  <p className="text-sm">Current state: результат MERGE операций</p>
                  <p className="text-sm mt-1">Отражает актуальное состояние источника</p>
                </div>
              }>
                <FlowNode variant="gcp-storage" size="sm">
                  BigQuery<br/>Replica
                </FlowNode>
              </Tooltip>
            </div>
          </DiagramContainer>
        </div>
      </div>

      <div className="mt-4 pt-3 border-t border-white/10 text-xs text-blue-200/70">
        <p>updateFrequencySecs=60 определяет частоту MERGE (каждую минуту)</p>
        <p className="mt-1">At-least-once достаточно для CDC: MERGE по PK идемпотентен</p>
      </div>
    </DiagramContainer>
  );
}
```

**2. DataflowEndToEndWorkflowDiagram** (complex nested workflow with stages)

Shows detailed end-to-end flow with subgraphs for each processing stage

```typescript
export function DataflowEndToEndWorkflowDiagram() {
  return (
    <DiagramContainer
      title="End-to-End Workflow: Cloud SQL → BigQuery"
      color="purple"
      description="Полный цикл CDC репликации с использованием Dataflow template"
    >
      <div className="space-y-4">
        {/* Stage 1: Database Change */}
        <DiagramContainer title="1. Database Change Event" color="blue">
          <div className="flex items-center gap-2">
            <FlowNode variant="gcp-database" size="sm">Cloud SQL</FlowNode>
            <Arrow direction="right" label="INSERT/UPDATE/DELETE" />
            <Tooltip content="PostgreSQL пишет транзакцию в WAL">
              <FlowNode variant="database" size="sm">WAL</FlowNode>
            </Tooltip>
          </div>
        </DiagramContainer>

        <Arrow direction="down" />

        {/* Stage 2: CDC Capture */}
        <DiagramContainer title="2. CDC Event Capture" color="emerald">
          <div className="flex items-center gap-2">
            <Tooltip content="Debezium читает через replication slot">
              <FlowNode variant="connector" size="sm">Debezium Server</FlowNode>
            </Tooltip>
            <Arrow direction="right" label="Parse & Transform" />
            <Tooltip content="JSON envelope: before, after, source, op, ts_ms">
              <FlowNode variant="app" size="sm">CDC Event</FlowNode>
            </Tooltip>
          </div>
        </DiagramContainer>

        <Arrow direction="down" />

        {/* Stage 3: Message Delivery */}
        <DiagramContainer title="3. Message Delivery" color="amber">
          <div className="flex items-center gap-2">
            <Tooltip content="Pub/Sub topic: cdc.public.orders">
              <FlowNode variant="gcp-messaging" size="sm">Pub/Sub Topic</FlowNode>
            </Tooltip>
            <Arrow direction="right" label="Ordering Key = PK" />
            <Tooltip content="Subscription читает Dataflow worker">
              <FlowNode variant="gcp-messaging" size="sm">Subscription</FlowNode>
            </Tooltip>
          </div>
        </DiagramContainer>

        <Arrow direction="down" />

        {/* Stage 4: Stream Processing */}
        <DiagramContainer title="4. Dataflow Processing" color="emerald">
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Tooltip content="Windowed aggregation: micro-batch каждые 60 секунд">
                <FlowNode variant="gcp-compute" size="sm">Window (60s)</FlowNode>
              </Tooltip>
              <Arrow direction="right" />
              <Tooltip content="Группировка по primary key для дедупликации">
                <FlowNode variant="gcp-compute" size="sm">Group by PK</FlowNode>
              </Tooltip>
              <Arrow direction="right" />
              <Tooltip content="Последнее событие по ts_ms wins">
                <FlowNode variant="gcp-compute" size="sm">Dedup</FlowNode>
              </Tooltip>
            </div>
          </div>
        </DiagramContainer>

        <Arrow direction="down" />

        {/* Stage 5: Storage */}
        <DiagramContainer title="5. BigQuery Storage" color="blue">
          <div className="flex items-center gap-3">
            <div className="flex flex-col gap-2">
              <Tooltip content="Все события записываются для аудита">
                <FlowNode variant="gcp-storage" size="sm">Changelog Table</FlowNode>
              </Tooltip>
              <div className="text-xs text-blue-200/70">Append-only</div>
            </div>
            <Arrow direction="right" label="MERGE" />
            <div className="flex flex-col gap-2">
              <Tooltip content="MERGE ON primary_key WHEN MATCHED THEN UPDATE/DELETE">
                <FlowNode variant="gcp-storage" size="sm">Replica Table</FlowNode>
              </Tooltip>
              <div className="text-xs text-blue-200/70">Current state</div>
            </div>
          </div>
        </DiagramContainer>
      </div>

      <div className="mt-4 pt-3 border-t border-white/10 text-xs text-purple-200/70">
        <p className="font-semibold mb-1">Key Points:</p>
        <ul className="space-y-1">
          <li>• Latency: ~60-90 секунд от INSERT в Cloud SQL до Replica в BigQuery</li>
          <li>• Throughput: до 10,000 events/sec на 1 Dataflow worker</li>
          <li>• Auto-scaling: workers увеличиваются при росте Pub/Sub backlog</li>
          <li>• Idempotency: повторная обработка событий безопасна (MERGE по PK)</li>
        </ul>
      </div>
    </DiagramContainer>
  );
}
```

**Pattern used:**
- Multi-stage pipeline with nested DiagramContainers (5 stages)
- Each stage shows internal processing steps
- Changelog vs Replica table dual-write pattern
- Russian tooltips with technical details
- Performance characteristics in footer
  </action>
  <verify>
- File exists at src/components/diagrams/module7/DataflowBigQueryDiagrams.tsx
- Exports 2 diagram components: CdcToBigQueryDiagram, DataflowEndToEndWorkflowDiagram
- Uses gcp-database, gcp-messaging, gcp-compute, gcp-storage variants
- CdcToBigQueryDiagram shows multi-stage pipeline
- DataflowEndToEndWorkflowDiagram shows 5 nested stages
- All tooltips in Russian
- No TypeScript errors
  </verify>
  <done>
2 Dataflow/BigQuery diagrams created showing managed CDC replication pipeline with changelog/replica pattern
  </done>
</task>

</tasks>

<verification>
- IamWorkloadDiagrams.tsx exists with 1 sequence diagram
- DataflowBigQueryDiagrams.tsx exists with 2 diagrams
- All 3 diagrams use GCP variants (gcp-database, gcp-messaging, gcp-compute, gcp-storage, gcp-security)
- Workload Identity diagram shows authentication flow with anti-pattern warning
- Dataflow diagrams show multi-stage pipeline and end-to-end workflow
- All tooltips in Russian
- TypeScript compiles: `npm run build`
- Dev server renders diagrams: `npm run dev`
</verification>

<success_criteria>
- 3 consumer service diagrams created (1 IAM + 2 Dataflow)
- Workload Identity sequence diagram complete
- CDC to BigQuery architecture visualized
- End-to-end Dataflow workflow with 5 stages
- Requirements MOD7-02 (create glass versions) partially complete for lessons 03-04
- Ready for Wave 3 (event-driven + monitoring + MDX migration)
</success_criteria>

<output>
After completion, create `.planning/phases/34-module-7-diagram-migration/34-02-SUMMARY.md`
</output>
