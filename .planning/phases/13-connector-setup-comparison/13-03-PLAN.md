---
phase: 13-connector-setup-comparison
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/course/08-module-8/06-schema-history-recovery.mdx
autonomous: true

must_haves:
  truths:
    - "Learner understands schema history topic's critical role for connector recovery"
    - "Learner can configure schema history topic with proper retention settings"
    - "Learner knows recovery procedures when schema history is corrupted/missing"
    - "Learner can monitor schema history topic health"
  artifacts:
    - path: "src/content/course/08-module-8/06-schema-history-recovery.mdx"
      provides: "Schema history topic and recovery lesson"
      min_lines: 400
      contains: ["schema.history.internal", "retention.ms=-1", "recovery", "DDL"]
  key_links:
    - from: "06-schema-history-recovery.mdx"
      to: "04-mysql-connector-configuration.mdx"
      via: "deep dive reference"
      pattern: "04-mysql-connector-configuration"
---

<objective>
Create deep-dive lesson on schema history topic configuration and its critical role for MySQL CDC connector recovery after restart.

Purpose: MYSQL-06 requires coverage of schema history topic configuration and its critical role for recovery. This lesson explains WHY schema history exists (no PostgreSQL equivalent) and how to protect it.

Output: `src/content/course/08-module-8/06-schema-history-recovery.mdx` with complete schema history guide
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-connector-setup-comparison/13-RESEARCH.md
@src/content/course/08-module-8/01-binlog-architecture.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema history and recovery lesson</name>
  <files>src/content/course/08-module-8/06-schema-history-recovery.mdx</files>
  <action>
Create lesson file with frontmatter:
- title: "Schema History Topic: Критический Компонент Recovery"
- order: 6
- difficulty: advanced
- estimatedTime: 30 minutes
- topics: mysql, debezium, schema-history, recovery, kafka
- prerequisites: module-8/05-binlog-wal-comparison

Content structure (Russian text, English code):

1. **Introduction** - Why MySQL needs schema history
   - MySQL binlog contains TABLE_MAP events with table_id (not full schema)
   - Connector must reconstruct schema at specific binlog position
   - PostgreSQL doesn't need this (schema embedded in each message)
   - "Schema history topic - это память коннектора о DDL-изменениях"

2. **How Schema History Works** (detailed mechanism)
   - Initial snapshot: Full schema captured
   - During streaming: DDL statements recorded with binlog position
   - On restart: Replay DDL history to reconstruct schemas at saved offset
   - Mermaid: Schema reconstruction timeline diagram

3. **Schema History Topic Configuration** (comprehensive)
   - Required properties:
     - schema.history.internal.kafka.topic (naming convention)
     - schema.history.internal.kafka.bootstrap.servers
   - Optional properties:
     - schema.history.internal.kafka.recovery.attempts
     - schema.history.internal.kafka.recovery.poll.interval.ms
   - Code: Full JSON config excerpt

4. **CRITICAL: Retention Configuration** (Pitfall 1 from research)
   - Default Kafka retention = 7 days -> DISASTER
   - MUST set retention.ms=-1 and retention.bytes=-1
   - Danger callout: "7-дневная бомба замедленного действия"
   - Step-by-step: Create topic with correct settings
   - Verification: kafka-topics --describe

5. **Topic Requirements** (Anti-patterns from research)
   - MUST be single partition (DDL ordering matters)
   - MUST NOT be compacted (need full history)
   - MUST have infinite retention
   - Table summarizing requirements

6. **What Gets Stored** (internal format - educational)
   - DDL statements with binlog position
   - Database and table metadata
   - Format: JSON per-line (not Avro)
   - Code: Example schema history entry (annotated)

7. **Recovery Scenarios** (comprehensive)

   **Scenario A: Normal Connector Restart**
   - What happens: Reads schema history, reconstructs at offset
   - Outcome: Seamless resume
   - No action needed

   **Scenario B: Schema History Topic Partially Purged**
   - Symptom: "db history topic is missing or incomplete"
   - Cause: Default retention deleted old DDL entries
   - Recovery:
     - Option 1: Delete connector, fix retention, full resnapshot
     - Option 2: Restore topic from backup, resume
   - Warning callout: "Resnapshot может занять часы для больших таблиц"

   **Scenario C: Schema History Topic Corrupted**
   - Symptom: Schema parsing errors, events with wrong columns
   - Cause: Manual edits, network issues during write
   - Recovery:
     - Delete connector and topic
     - Recreate topic with correct settings
     - Deploy with snapshot.mode=initial (full resnapshot)

   **Scenario D: Multiple Connectors Sharing Topic** (anti-pattern)
   - Symptom: Random schema errors, connector A sees B's DDL
   - Cause: Shared topic.prefix or shared schema history topic
   - Prevention: Unique schema history topic per connector
   - Recovery: Separate topics, resnapshot both

8. **Monitoring Schema History Health** (proactive)
   - Metrics to watch:
     - Topic size (growing is normal)
     - Consumer lag (connector reading topic)
     - Message count (DDL frequency)
   - Alerts:
     - Topic size suddenly drops (purge happened!)
     - Consumer lag increasing (connector falling behind)
   - Grafana panel example (optional)

9. **Backup and Restore Procedures** (operational)
   - Why backup: Faster recovery than full resnapshot
   - How: kafka-console-consumer to file, periodic
   - Restore: kafka-console-producer from backup file
   - Warning: Must restore to same topic name
   - Code: Backup/restore commands

10. **Schema Evolution Best Practices**
    - DDL changes are recorded automatically
    - Compatible changes (ADD COLUMN) - seamless
    - Incompatible changes (DROP COLUMN) - need consumer coordination
    - Tip: Test schema changes in staging first

11. **Key Takeaways** (10-12 bullet points)

12. **What's Next** (preview Aurora MySQL specifics - Phase 14)

Use Mermaid for:
- Schema reconstruction flow (snapshot -> DDL -> current state)
- Recovery decision tree (symptom -> diagnosis -> action)

Use Callout components:
- type="danger" for retention settings, anti-patterns
- type="warning" for recovery scenarios requiring resnapshot
- type="tip" for monitoring and backup practices
- type="note" for "Unlike PostgreSQL..." comparisons
  </action>
  <verify>
```bash
# File exists with substantial content
wc -l src/content/course/08-module-8/06-schema-history-recovery.mdx
# Expected: 400+ lines

# Contains critical configuration
grep -c "schema.history.internal" src/content/course/08-module-8/06-schema-history-recovery.mdx
grep -c "retention.ms=-1" src/content/course/08-module-8/06-schema-history-recovery.mdx

# Contains recovery scenarios
grep -c "[Rr]ecovery\|[Вв]осстановлен" src/content/course/08-module-8/06-schema-history-recovery.mdx

# Contains DDL explanation
grep -c "DDL" src/content/course/08-module-8/06-schema-history-recovery.mdx
```
  </verify>
  <done>Lesson covers: schema history mechanism, configuration, retention requirements, recovery scenarios, monitoring, backup/restore. Learner understands critical role of schema history for MySQL CDC reliability.</done>
</task>

</tasks>

<verification>
```bash
# Lesson file exists and has proper frontmatter
head -20 src/content/course/08-module-8/06-schema-history-recovery.mdx | grep -E "^(title|order|difficulty):"

# Minimum content depth
wc -l src/content/course/08-module-8/06-schema-history-recovery.mdx

# Build passes (Astro can process MDX)
cd /Users/levoely/debezium\ course && npm run build 2>&1 | tail -5
```
</verification>

<success_criteria>
- Lesson file exists at src/content/course/08-module-8/06-schema-history-recovery.mdx
- Content is 400+ lines covering mechanism, config, recovery
- Contains schema.history.internal configuration examples
- Contains retention.ms=-1 requirement (explicitly stated)
- Contains recovery scenarios with step-by-step procedures
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-connector-setup-comparison/13-03-SUMMARY.md`
</output>
