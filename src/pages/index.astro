---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { ProgressIndicator } from '../components/ProgressIndicator';
import { ProgressExport } from '../components/ProgressExport';
import { getModuleName, getModuleNumber } from '../utils/moduleNames';

// Helper to clean entry.id to URL-friendly slug
function cleanSlug(id: string): string {
  return id.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '');
}

// Fetch all course entries and sort by order
const courseEntries = await getCollection('course');
const sortedLessons = courseEntries
  .filter(c => !c.data.draft)
  .sort((a, b) => a.data.order - b.data.order);

// Total lessons for progress indicator
const totalLessons = sortedLessons.length;

// Group lessons by module
function groupByModule(lessons: typeof sortedLessons) {
  const groups = new Map<string, typeof sortedLessons>();

  for (const lesson of lessons) {
    // Extract module ID from lesson slug (e.g., "01-module-1/01-cdc-fundamentals" -> "01-module-1")
    const moduleId = cleanSlug(lesson.id).split('/')[0];

    if (!groups.has(moduleId)) {
      groups.set(moduleId, []);
    }
    groups.get(moduleId)!.push(lesson);
  }

  return groups;
}

const moduleGroups = groupByModule(sortedLessons);
const moduleIds = Array.from(moduleGroups.keys()).sort();

// Get difficulty badge color
function getDifficultyColor(difficulty: string) {
  switch (difficulty) {
    case 'beginner':
      return 'bg-green-500/20 text-green-300 border-green-500';
    case 'intermediate':
      return 'bg-yellow-500/20 text-yellow-300 border-yellow-500';
    case 'advanced':
      return 'bg-red-500/20 text-red-300 border-red-500';
    default:
      return 'bg-gray-500/20 text-gray-300 border-gray-500';
  }
}

// Translate difficulty to Russian
function translateDifficulty(difficulty: string) {
  switch (difficulty) {
    case 'beginner':
      return 'Начальный';
    case 'intermediate':
      return 'Средний';
    case 'advanced':
      return 'Продвинутый';
    default:
      return difficulty;
  }
}
---

<BaseLayout
  title="Курс Debezium: CDC паттерны для production"
  description="Научитесь проектировать и реализовывать production-ready CDC-пайплайны с использованием Debezium"
>
  <div class="prose prose-invert max-w-none">
    <h1 class="text-4xl font-bold text-gray-100 mb-4">
      Debezium: Change Data Capture для production
    </h1>

    <p class="text-lg text-gray-300 mb-8">
      Комплексный курс по проектированию и реализации CDC-пайплайнов на основе Debezium.
      От базовых концепций до production-ready архитектур с пониманием всех критических нюансов интеграций.
    </p>

    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-blue-300 mt-0 mb-2">Что вы получите</h2>
      <ul class="text-gray-300 mb-0">
        <li>Глубокое понимание CDC паттернов и архитектурных решений</li>
        <li>Практические навыки настройки Debezium для различных СУБД</li>
        <li>Знание производительностных нюансов и стратегий оптимизации</li>
        <li>Опыт обработки реальных production-сценариев</li>
      </ul>
    </div>

    <!-- Progress Tracking Section -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-8">
      <div class="grid gap-6 lg:grid-cols-2">
        <div>
          <ProgressIndicator totalLessons={totalLessons} client:load />
        </div>
        <div>
          <ProgressExport client:load />
        </div>
      </div>
    </div>

    <h2 class="text-2xl font-bold text-gray-100 mb-6">Модули курса</h2>

    <div class="space-y-8 not-prose">
      {moduleIds.map((moduleId) => {
        const lessons = moduleGroups.get(moduleId)!;
        const moduleNumber = getModuleNumber(moduleId);
        const moduleName = getModuleName(moduleId);

        return (
          <section key={moduleId} class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-200 flex items-center gap-3">
              <span class="text-blue-400 font-mono">{moduleNumber}</span>
              <span>{moduleName}</span>
              <span class="text-sm text-gray-500 font-normal">({lessons.length} уроков)</span>
            </h3>

            <div class="grid gap-4 pl-4 border-l-2 border-blue-500/30">
              {lessons.map((lesson) => (
                <a
                  href={`${import.meta.env.BASE_URL}/course/${cleanSlug(lesson.id)}`}
                  class="block bg-gray-800/50 border border-gray-700/50 rounded-lg p-4 hover:border-blue-500/50 hover:bg-gray-800/70 transition-colors"
                >
                  <div class="flex items-start justify-between mb-2">
                    <h4 class="text-lg font-medium text-gray-100">
                      {lesson.data.title}
                    </h4>
                    <span class={`px-2 py-0.5 rounded-full text-xs font-medium border ${getDifficultyColor(lesson.data.difficulty)}`}>
                      {translateDifficulty(lesson.data.difficulty)}
                    </span>
                  </div>

                  <p class="text-gray-400 text-sm mb-3 line-clamp-2">
                    {lesson.data.description}
                  </p>

                  <div class="flex flex-wrap gap-3 text-xs text-gray-500">
                    <div class="flex items-center gap-1">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span>{lesson.data.estimatedTime} мин</span>
                    </div>

                    <div class="flex items-center gap-1 flex-wrap">
                      {lesson.data.topics.slice(0, 2).map((topic) => (
                        <span class="px-1.5 py-0.5 bg-gray-700/50 rounded text-xs">
                          {topic}
                        </span>
                      ))}
                      {lesson.data.topics.length > 2 && (
                        <span class="text-gray-600">
                          +{lesson.data.topics.length - 2}
                        </span>
                      )}
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </section>
        );
      })}
    </div>

    {sortedLessons.length === 0 && (
      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-6 text-center">
        <p class="text-yellow-300 mb-0">
          Уроки курса находятся в разработке. Скоро здесь появится контент!
        </p>
      </div>
    )}
  </div>
</BaseLayout>
