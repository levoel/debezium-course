---
phase: 04-lab-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - labs/docker-compose.yml
  - labs/.env
  - labs/postgres/init.sql
autonomous: true

must_haves:
  truths:
    - "Docker Compose starts PostgreSQL with logical replication enabled"
    - "Kafka runs in KRaft mode without ZooKeeper"
    - "Debezium Connect starts and exposes REST API"
    - "Schema Registry connects to Kafka and accepts schemas"
  artifacts:
    - path: "labs/docker-compose.yml"
      provides: "Core service orchestration"
      contains: "quay.io/debezium"
    - path: "labs/.env"
      provides: "Environment variables for versions and ports"
      contains: "DEBEZIUM_VERSION"
    - path: "labs/postgres/init.sql"
      provides: "Sample schema for CDC exercises"
      contains: "CREATE TABLE"
  key_links:
    - from: "labs/docker-compose.yml"
      to: "labs/.env"
      via: "environment variable substitution"
      pattern: "\\$\\{.*_VERSION\\}"
    - from: "labs/docker-compose.yml"
      to: "labs/postgres/init.sql"
      via: "volume mount to docker-entrypoint-initdb.d"
      pattern: "init.sql:/docker-entrypoint-initdb.d"
---

<objective>
Create the core Docker Compose stack with PostgreSQL, Kafka (KRaft mode), Debezium Connect, and Schema Registry.

Purpose: Establish the foundation for hands-on CDC labs with all essential services running on ARM64 macOS.
Output: Working docker-compose.yml with core CDC infrastructure that starts with `docker compose up`.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-lab-infrastructure/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment file with version pinning</name>
  <files>labs/.env</files>
  <action>
Create labs/.env with version variables for all services:

```
# Debezium Lab Environment Variables
# All versions tested for ARM64 compatibility

# Core versions
DEBEZIUM_VERSION=3.0.8.Final
KAFKA_VERSION=3.0.8.Final
POSTGRES_VERSION=15
SCHEMA_REGISTRY_VERSION=8.1.1

# Kafka configuration
KAFKA_CLUSTER_ID=oh-sxaDRTcyAr6pFRbXyzA

# PostgreSQL
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=inventory

# Ports (external:internal)
POSTGRES_PORT=5432
KAFKA_PORT=9092
CONNECT_PORT=8083
SCHEMA_REGISTRY_PORT=8081
```

Use static CLUSTER_ID from research (valid UUID format required for KRaft).
  </action>
  <verify>File exists at labs/.env with all required variables</verify>
  <done>Environment file contains DEBEZIUM_VERSION=3.0.8.Final, KAFKA_CLUSTER_ID, and database credentials</done>
</task>

<task type="auto">
  <name>Task 2: Create sample PostgreSQL schema for CDC exercises</name>
  <files>labs/postgres/init.sql</files>
  <action>
Create labs/postgres/init.sql with sample inventory schema:

```sql
-- Sample Inventory Database for Debezium CDC Labs
-- This schema is used throughout the course modules

-- Customers table
CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Products table
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    quantity INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Orders table (references customers and has order items)
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(id),
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'pending',
    total_amount DECIMAL(10, 2)
);

-- Order items (junction table)
CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    product_id INTEGER REFERENCES products(id),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL
);

-- Insert sample data
INSERT INTO customers (first_name, last_name, email) VALUES
    ('John', 'Doe', 'john.doe@example.com'),
    ('Jane', 'Smith', 'jane.smith@example.com'),
    ('Bob', 'Johnson', 'bob.johnson@example.com');

INSERT INTO products (name, description, price, quantity) VALUES
    ('Laptop', 'High-performance laptop', 999.99, 50),
    ('Mouse', 'Wireless ergonomic mouse', 29.99, 200),
    ('Keyboard', 'Mechanical keyboard', 79.99, 100);

-- Create publication for Debezium (required for pgoutput)
CREATE PUBLICATION dbz_publication FOR ALL TABLES;

-- Grant replication permissions
ALTER USER postgres WITH REPLICATION;
```

Include CREATE PUBLICATION for pgoutput plugin (research: pgoutput is built-in, no custom plugins needed).
  </action>
  <verify>File exists at labs/postgres/init.sql with customers, products, orders tables and sample data</verify>
  <done>SQL file creates inventory schema with customers/products/orders tables, sample data, and CDC publication</done>
</task>

<task type="auto">
  <name>Task 3: Create core Docker Compose configuration</name>
  <files>labs/docker-compose.yml</files>
  <action>
Create labs/docker-compose.yml with PostgreSQL, Kafka (KRaft), Connect, and Schema Registry.

Use exact patterns from 04-RESEARCH.md:
- quay.io/debezium/* images (NOT Docker Hub - stopped publishing in 3.0.0)
- PostgreSQL with `command: ["postgres", "-c", "wal_level=logical", "-c", "max_replication_slots=10", "-c", "max_wal_senders=10"]`
- Kafka KRaft with CLUSTER_ID, NODE_ROLE=combined, proper listeners
- Health checks with `depends_on: condition: service_healthy` for startup ordering
- Named volumes for data persistence

Services to include:
1. postgres - official postgres:${POSTGRES_VERSION} with logical replication
2. kafka - quay.io/debezium/kafka:${DEBEZIUM_VERSION} in KRaft mode
3. connect - quay.io/debezium/connect:${DEBEZIUM_VERSION} with JMX on 9404
4. schema-registry - confluentinc/cp-schema-registry:${SCHEMA_REGISTRY_VERSION}

Health checks (from research):
- postgres: `pg_isready -U postgres`
- kafka: `kafka-broker-api-versions.sh --bootstrap-server localhost:9092`
- connect: `curl -f http://localhost:8083/`

Listener configuration for Kafka (from research pitfall #6):
- KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092" for host access

Volume mounts:
- postgres-data:/var/lib/postgresql/data
- kafka-data:/var/lib/kafka/data
- ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql

DO NOT include monitoring or JupyterLab - those are in separate plans.
  </action>
  <verify>
Run from labs/ directory:
1. `docker compose config` - validates YAML syntax
2. `docker compose up -d` - starts all services
3. `docker compose ps` - shows postgres, kafka, connect, schema-registry as healthy
4. `curl http://localhost:8083/connectors` - Connect REST API responds with []
5. `curl http://localhost:8081/subjects` - Schema Registry responds with []
  </verify>
  <done>
- PostgreSQL starts with wal_level=logical and sample schema loaded
- Kafka starts in KRaft mode (no ZooKeeper container)
- Debezium Connect exposes REST API on port 8083
- Schema Registry connects to Kafka and responds on port 8081
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full stack:

```bash
cd labs

# Start the stack
docker compose up -d

# Wait for services (health checks should handle this)
sleep 30

# Check all services are healthy
docker compose ps

# Verify PostgreSQL logical replication
docker compose exec postgres psql -U postgres -c "SHOW wal_level;"
# Expected: logical

# Verify Kafka is running (KRaft mode - no ZooKeeper)
docker compose exec kafka kafka-topics.sh --bootstrap-server localhost:9092 --list
# Should return without error

# Verify Connect REST API
curl -s http://localhost:8083/ | jq .version
# Expected: 3.0.8.Final

# Verify Schema Registry
curl -s http://localhost:8081/subjects
# Expected: []

# Stop the stack
docker compose down
```
</verification>

<success_criteria>
1. `docker compose up -d` starts all 4 services without errors
2. `docker compose ps` shows postgres, kafka, connect, schema-registry as healthy
3. PostgreSQL has wal_level=logical and inventory database with sample tables
4. Kafka runs without ZooKeeper (KRaft mode)
5. Connect REST API at http://localhost:8083 returns version info
6. Schema Registry at http://localhost:8081 is accessible
7. All images pull successfully on ARM64 (no platform warnings)
</success_criteria>

<output>
After completion, create `.planning/phases/04-lab-infrastructure/04-01-SUMMARY.md`
</output>
