---
phase: 10-module-6-cloud-native-gcp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/course/06-module-6/01-cloud-sql-setup.mdx
  - src/content/course/06-module-6/02-debezium-server-pubsub.mdx
autonomous: true

must_haves:
  truths:
    - "Students can configure Cloud SQL PostgreSQL for logical replication"
    - "Students can deploy Debezium Server with Pub/Sub sink"
    - "Students understand the Kafka-less CDC architecture"
  artifacts:
    - path: "src/content/course/06-module-6/01-cloud-sql-setup.mdx"
      provides: "Cloud SQL PostgreSQL CDC configuration lesson"
      contains: "cloudsql.logical_decoding"
    - path: "src/content/course/06-module-6/02-debezium-server-pubsub.mdx"
      provides: "Debezium Server Pub/Sub sink lesson"
      contains: "debezium.sink.type=pubsub"
  key_links:
    - from: "lesson-01"
      to: "lesson-02"
      via: "Cloud SQL provides source for Debezium Server"
      pattern: "Cloud SQL.*Debezium Server"
---

<objective>
Create the foundational GCP CDC lessons covering Cloud SQL PostgreSQL configuration and Debezium Server with Pub/Sub sink.

Purpose: Establish the core Kafka-less CDC architecture on GCP that all subsequent lessons build upon. These two lessons cover the source database setup (Cloud SQL) and the CDC engine (Debezium Server) that replaces Kafka Connect.

Output: Two MDX lessons teaching students how to configure Cloud SQL for logical replication and deploy Debezium Server publishing to Pub/Sub.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-module-6-cloud-native-gcp/10-RESEARCH.md

Reference for content patterns:
@src/content/course/05-module-5/01-advanced-python-consumer.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloud SQL PostgreSQL CDC Setup lesson</name>
  <files>src/content/course/06-module-6/01-cloud-sql-setup.mdx</files>
  <action>
Create MDX lesson covering Cloud SQL PostgreSQL configuration for Debezium CDC.

**Frontmatter:**
```yaml
title: "Настройка Cloud SQL PostgreSQL для CDC"
description: "Конфигурация logical replication, создание replication user и мониторинг слотов"
order: 1
difficulty: "intermediate"
estimatedTime: 35
topics: ["Cloud SQL", "PostgreSQL", "Logical Decoding", "Replication Slots", "GCP"]
prerequisites: ["module-2/01-logical-decoding-deep-dive", "module-2/02-replication-slots-lifecycle"]
```

**Content structure (Russian text, English code/config):**

1. **Introduction** - Why Cloud SQL for CDC
   - Managed PostgreSQL with logical replication support
   - Key difference from self-managed: `cloudsql.logical_decoding` flag
   - No direct access to postgresql.conf - use database flags

2. **Enabling Logical Decoding**
   - gcloud command to patch instance with flag:
     ```bash
     gcloud sql instances patch INSTANCE_NAME \
       --database-flags=cloudsql.logical_decoding=on
     ```
   - Console path: Cloud SQL > Instance > Edit > Flags
   - Important: requires instance restart
   - Verify with: `SHOW wal_level;` (should return 'logical')

3. **Creating Replication User**
   - SQL for user creation with REPLICATION privilege:
     ```sql
     CREATE USER debezium_user WITH REPLICATION
       IN ROLE cloudsqlsuperuser LOGIN PASSWORD 'secure_password';
     ```
   - Grant SELECT on tables:
     ```sql
     GRANT SELECT ON ALL TABLES IN SCHEMA public TO debezium_user;
     ALTER DEFAULT PRIVILEGES IN SCHEMA public
       GRANT SELECT ON TABLES TO debezium_user;
     ```

4. **Creating Publication**
   - Publication for specific tables:
     ```sql
     CREATE PUBLICATION debezium_publication
       FOR TABLE public.orders, public.customers;
     ```
   - Verify with `SELECT * FROM pg_publication_tables;`

5. **Replication Slot Monitoring** (critical section)
   - Query for slot health:
     ```sql
     SELECT slot_name, active,
       pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) AS lag
     FROM pg_replication_slots;
     ```
   - WAL bloat prevention: explain `max_slot_wal_keep_size` flag
   - Reference Module 2 lessons for deeper understanding

6. **Cloud SQL vs Self-Managed Differences**
   - Table comparing configuration approaches
   - No direct pg_hba.conf access
   - cloudsqlsuperuser role instead of superuser
   - Automatic backups include replication state

7. **Summary checklist** - Prerequisites for Debezium Server connection

Use Mermaid diagram showing: Cloud SQL PostgreSQL -> Logical Decoding -> WAL -> Debezium Server
  </action>
  <verify>
File exists at src/content/course/06-module-6/01-cloud-sql-setup.mdx
Content includes cloudsql.logical_decoding flag documentation
Content includes replication user SQL
Content includes replication slot monitoring query
Frontmatter has all required fields (title, description, order, difficulty, estimatedTime, topics, prerequisites)
  </verify>
  <done>
Lesson teaches Cloud SQL PostgreSQL CDC setup with gcloud commands, SQL for replication user/publication, and slot monitoring - all patterns from research document.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Debezium Server Pub/Sub lesson</name>
  <files>src/content/course/06-module-6/02-debezium-server-pubsub.mdx</files>
  <action>
Create MDX lesson covering Debezium Server deployment with Pub/Sub sink (Kafka-less architecture).

**Frontmatter:**
```yaml
title: "Debezium Server с Pub/Sub Sink"
description: "Kafka-less CDC архитектура: Debezium Server публикует события напрямую в Google Cloud Pub/Sub"
order: 2
difficulty: "intermediate"
estimatedTime: 45
topics: ["Debezium Server", "Pub/Sub", "Kafka-less", "GCP", "CDC"]
prerequisites: ["module-6/01-cloud-sql-setup"]
```

**Content structure:**

1. **Introduction** - Why Kafka-less?
   - Traditional: PostgreSQL -> Debezium Connector -> Kafka Connect -> Kafka
   - Kafka-less: PostgreSQL -> Debezium Server -> Pub/Sub
   - Benefits: simpler infrastructure, GCP-native messaging, lower operational burden
   - Tradeoff: no Kafka ecosystem (Streams, ksqlDB, multi-sink)

2. **Debezium Server Architecture**
   - Mermaid diagram: Quarkus-based standalone application
   - Components: Source connector + Sink adapter
   - Supported sinks: Pub/Sub, Kinesis, HTTP, Redis Streams
   - Docker image: `debezium/server:2.5`

3. **application.properties Configuration**
   - Complete working configuration from research:
     ```properties
     # Sink: Google Cloud Pub/Sub
     debezium.sink.type=pubsub
     debezium.sink.pubsub.project.id=${GCP_PROJECT_ID}
     debezium.sink.pubsub.ordering.enabled=true

     # Source: PostgreSQL
     debezium.source.connector.class=io.debezium.connector.postgresql.PostgresConnector
     debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat
     debezium.source.offset.flush.interval.ms=5000

     # Database connection (from Cloud SQL lesson)
     debezium.source.database.hostname=${DB_HOST}
     debezium.source.database.port=5432
     debezium.source.database.user=debezium_user
     debezium.source.database.password=${DB_PASSWORD}
     debezium.source.database.dbname=production

     # Logical replication
     debezium.source.topic.prefix=cdc
     debezium.source.plugin.name=pgoutput
     debezium.source.publication.name=debezium_publication
     debezium.source.slot.name=debezium_slot

     # Performance
     debezium.source.max.batch.size=2048
     debezium.source.poll.interval.ms=100

     # Heartbeat (critical!)
     debezium.source.heartbeat.interval.ms=10000
     ```
   - Explain each section with Russian comments

4. **Pub/Sub Topic Naming Convention**
   - Pattern: `{topic.prefix}.{schema}.{table}` -> `cdc.public.orders`
   - Topics must be pre-created (script example)
   - Common pitfall: case sensitivity mismatch

5. **Offset Storage Strategy**
   - File-based: `/debezium/data/offsets.dat`
   - Critical: Persistent storage required (PVC for Kubernetes)
   - Pitfall: Pod restart without PVC = duplicate processing or data loss
   - Alternative: Redis offset storage for HA

6. **Running Debezium Server**
   - Docker run command:
     ```bash
     docker run -d --name debezium-server \
       -v $(pwd)/config:/debezium/conf \
       -v $(pwd)/data:/debezium/data \
       -e GOOGLE_APPLICATION_CREDENTIALS=/secrets/key.json \
       -v $(pwd)/secrets:/secrets \
       debezium/server:2.5
     ```
   - Health check: `curl localhost:8080/q/health`

7. **Verifying CDC Events in Pub/Sub**
   - gcloud commands to pull messages:
     ```bash
     gcloud pubsub subscriptions create test-sub --topic=cdc.public.orders
     gcloud pubsub subscriptions pull test-sub --limit=5
     ```
   - Show example Debezium event structure in Pub/Sub

8. **Comparison with Kafka Connect**
   - Table: Debezium Connect vs Debezium Server
   - When to use each approach

Include Mermaid architecture diagram showing full flow from Cloud SQL to Pub/Sub consumers.
  </action>
  <verify>
File exists at src/content/course/06-module-6/02-debezium-server-pubsub.mdx
Content includes complete application.properties configuration
Content includes debezium.sink.type=pubsub
Content includes offset storage strategy explanation
Content includes Docker run command
Frontmatter has all required fields
  </verify>
  <done>
Lesson covers Debezium Server Kafka-less architecture with complete configuration, offset storage pitfalls, and verification steps for Pub/Sub events.
  </done>
</task>

</tasks>

<verification>
- Both lessons created in src/content/course/06-module-6/ directory
- Lesson 01 prerequisite chain: Module 2 lessons (logical decoding, replication slots)
- Lesson 02 prerequisite chain: Lesson 01 (Cloud SQL setup)
- Both lessons use Russian explanatory text with English code/config
- Mermaid diagrams included for architecture visualization
- Research patterns (from 10-RESEARCH.md) incorporated: cloudsql.logical_decoding, pgoutput plugin, application.properties, heartbeat config
</verification>

<success_criteria>
- MOD6-01 requirement covered by lesson 01 (Cloud SQL PostgreSQL for Debezium)
- MOD6-02 requirement covered by lesson 02 (Debezium Server with Pub/Sub sink)
- Students can follow lessons to configure Cloud SQL and deploy Debezium Server
- Critical pitfalls documented (WAL bloat, offset storage, topic naming)
</success_criteria>

<output>
After completion, create `.planning/phases/10-module-6-cloud-native-gcp/10-01-SUMMARY.md`
</output>
