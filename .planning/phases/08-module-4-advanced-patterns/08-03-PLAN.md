---
phase: 08-module-4-advanced-patterns
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/course/04-module-4/05-outbox-pattern-theory.mdx
  - src/content/course/04-module-4/06-outbox-implementation.mdx
  - labs/schemas/outbox-table.sql
autonomous: true

must_haves:
  truths:
    - "Student can explain Outbox pattern and its role in microservices"
    - "Student understands Outbox provides at-least-once, not distributed ACID"
    - "Student can create outbox table with correct schema"
    - "Student can configure Outbox Event Router SMT"
    - "Student can implement transactional event emission pattern"
  artifacts:
    - path: "src/content/course/04-module-4/05-outbox-pattern-theory.mdx"
      provides: "Outbox pattern architecture and theory"
      contains: "Outbox pattern"
    - path: "src/content/course/04-module-4/06-outbox-implementation.mdx"
      provides: "Outbox Event Router SMT configuration"
      contains: "OutboxEventRouter"
    - path: "labs/schemas/outbox-table.sql"
      provides: "Outbox table DDL"
      contains: "CREATE TABLE"
  key_links:
    - from: "06-outbox-implementation.mdx"
      to: "connector config"
      via: "OutboxEventRouter configuration"
      pattern: "io.debezium.transforms.outbox.EventRouter"
    - from: "outbox-table.sql"
      to: "PostgreSQL"
      via: "table creation"
      pattern: "aggregatetype"
---

<objective>
Create Outbox pattern lessons covering theory and practical implementation with Outbox Event Router SMT.

Purpose: Students learn the transactional messaging pattern critical for microservices data exchange.
Output: Two MDX lessons and outbox table DDL for lab exercises.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-module-4-advanced-patterns/08-RESEARCH.md

# Pattern reference
@src/content/course/03-module-3/01-jmx-metrics-interpretation.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Outbox Pattern Theory Lesson (05-outbox-pattern-theory.mdx)</name>
  <files>src/content/course/04-module-4/05-outbox-pattern-theory.mdx</files>
  <action>
Create lesson explaining Outbox pattern theory and architecture for microservices.

Content structure:
1. **The dual-write problem:**
   - Update database + send message = two separate operations
   - Either can fail, leaving inconsistent state
   - Distributed transactions (2PC) are slow and complex
2. **Outbox pattern solution:**
   - Write business data + event to same database (atomic transaction)
   - CDC captures outbox table changes
   - Events published to Kafka automatically
3. **Outbox table schema:**
   ```sql
   CREATE TABLE public.outbox (
       id UUID PRIMARY KEY,
       aggregatetype VARCHAR(255) NOT NULL,
       aggregateid VARCHAR(255) NOT NULL,
       type VARCHAR(255) NOT NULL,
       payload JSONB NOT NULL,
       created_at TIMESTAMP DEFAULT NOW()
   );
   ```
4. **Event structure:**
   - aggregatetype: Domain entity (Order, Customer)
   - aggregateid: Entity ID (for Kafka key)
   - type: Event type (OrderCreated, OrderApproved)
   - payload: Event data as JSON
5. **Guarantees and limitations:**
   - Single-database atomicity (YES)
   - At-least-once delivery (YES)
   - Exactly-once delivery (NO - consumers handle idempotency)
   - Cross-service ACID (NO - eventual consistency)
6. **Outbox cleanup strategies:**
   - DELETE in same transaction (Debezium ignores DELETEs)
   - External cleanup job (risk: lock contention)

Include Mermaid diagram showing Outbox pattern data flow.

Critical callout: Outbox pattern is NOT distributed transactions. It provides eventually consistent, reliable messaging.

Frontmatter:
- title: "Outbox Pattern: Theory and Architecture"
- description: "Reliable microservices messaging with transactional outbox"
- order: 5
- difficulty: "intermediate"
- estimatedTime: 30
- topics: ["outbox", "microservices", "patterns", "transactions"]
- prerequisites: ["module-4/04-content-based-routing"]

Language: Russian explanatory text, English code/config.
  </action>
  <verify>File exists at src/content/course/04-module-4/05-outbox-pattern-theory.mdx with Outbox schema and Mermaid diagram</verify>
  <done>Lesson explains dual-write problem, Outbox solution, table schema, guarantees and limitations clearly</done>
</task>

<task type="auto">
  <name>Task 2: Create Outbox Implementation Lesson (06-outbox-implementation.mdx)</name>
  <files>src/content/course/04-module-4/06-outbox-implementation.mdx, labs/schemas/outbox-table.sql</files>
  <action>
Create lesson teaching Outbox Event Router SMT configuration and practical implementation.

Content for 06-outbox-implementation.mdx:
1. **Outbox Event Router SMT basics:**
   ```json
   {
     "transforms": "outbox",
     "transforms.outbox.type": "io.debezium.transforms.outbox.EventRouter",
     "transforms.outbox.table.field.event.id": "id",
     "transforms.outbox.table.field.event.key": "aggregateid",
     "transforms.outbox.table.field.event.payload": "payload",
     "transforms.outbox.route.by.field": "aggregatetype",
     "transforms.outbox.route.topic.replacement": "outbox.event.${routedByValue}"
   }
   ```
2. **Configuration options:**
   - table.field.event.* - Map outbox columns to event fields
   - route.by.field - Field for topic routing
   - route.topic.replacement - Topic naming pattern
   - table.expand.json.payload - Parse JSONB payload
3. **Complete connector configuration:**
   ```json
   {
     "name": "outbox-connector",
     "config": {
       "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
       "table.include.list": "public.outbox",
       "transforms": "outbox",
       "transforms.outbox.type": "io.debezium.transforms.outbox.EventRouter",
       "transforms.outbox.table.expand.json.payload": "true"
     }
   }
   ```
4. **Application code pattern:**
   ```sql
   BEGIN;
   UPDATE orders SET status = 'APPROVED' WHERE id = '...';
   INSERT INTO outbox (id, aggregatetype, aggregateid, type, payload)
   VALUES (gen_random_uuid(), 'Order', '...', 'OrderApproved', '{"orderId": "...", "amount": 299.99}');
   DELETE FROM outbox WHERE id = '...';  -- Optional cleanup
   COMMIT;
   ```
5. **Consumer idempotency:**
   - Event ID in message header
   - Deduplicate by event ID
   ```python
   event_id = msg.headers()['id']
   if event_id in processed:
       continue
   ```
6. **Lab: Implement order approval flow**
   - Create outbox table
   - Deploy outbox connector
   - Emit OrderApproved event
   - Consume from outbox.event.Order topic

Also create labs/schemas/outbox-table.sql:
```sql
-- Outbox table for reliable event publishing
-- Used with Debezium Outbox Event Router SMT

CREATE TABLE IF NOT EXISTS public.outbox (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    aggregatetype VARCHAR(255) NOT NULL,
    aggregateid VARCHAR(255) NOT NULL,
    type VARCHAR(255) NOT NULL,
    payload JSONB NOT NULL,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_outbox_created ON public.outbox(created_at);

COMMENT ON TABLE public.outbox IS 'Transactional outbox for reliable event publishing via Debezium';
```

Frontmatter:
- title: "Outbox Implementation with Event Router SMT"
- description: "Configuring Debezium Outbox Event Router for production"
- order: 6
- difficulty: "advanced"
- estimatedTime: 40
- topics: ["outbox", "smt", "implementation", "lab"]
- prerequisites: ["module-4/05-outbox-pattern-theory"]

Language: Russian explanatory text, English code/config.
  </action>
  <verify>Files exist: 06-outbox-implementation.mdx with OutboxEventRouter config, outbox-table.sql with CREATE TABLE</verify>
  <done>Lesson shows complete Outbox Event Router configuration, application pattern, consumer idempotency, plus DDL file for labs</done>
</task>

</tasks>

<verification>
- Both MDX files exist in src/content/course/04-module-4/
- labs/schemas/outbox-table.sql exists with valid DDL
- Frontmatter is valid YAML with required fields
- Prerequisites chain correctly (05 -> 04, 06 -> 05)
</verification>

<success_criteria>
- Lesson 05 explains Outbox pattern theory with clear guarantees/limitations
- Lesson 06 provides complete implementation guide with working config
- labs/schemas/outbox-table.sql ready for lab use
- Requirements MOD4-05 and MOD4-06 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/08-module-4-advanced-patterns/08-03-SUMMARY.md`
</output>
