---
phase: 32-module-5-diagram-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/diagrams/module5/ContentRoutingDiagrams.tsx
  - src/components/diagrams/module5/OutboxPatternDiagrams.tsx
  - src/components/diagrams/module5/OutboxImplementationDiagrams.tsx
autonomous: true

must_haves:
  truths:
    - "Content-based routing diagrams show multi-tenant topic splitting with FlowNode"
    - "Outbox pattern diagrams show transaction flow with atomic commit visualization"
    - "Dual-write problem diagram shows failure scenarios with rose-colored failure paths"
    - "User can click nodes to see Russian explanations of outbox pattern concepts"
    - "All 8 diagrams render without console errors"
  artifacts:
    - path: "src/components/diagrams/module5/ContentRoutingDiagrams.tsx"
      provides: "3 diagram components for lesson 04"
      exports: ["ContentBasedRouterDiagram", "MultiTenantRoutingDiagram", "RegionBasedRoutingDiagram"]
    - path: "src/components/diagrams/module5/OutboxPatternDiagrams.tsx"
      provides: "4 diagram components for lesson 05"
      exports: ["DualWriteProblemDiagram", "OutboxSolutionDiagram", "OutboxTransactionFlowDiagram", "MicroservicesOutboxDiagram"]
    - path: "src/components/diagrams/module5/OutboxImplementationDiagrams.tsx"
      provides: "1 diagram component for lesson 06"
      exports: ["OutboxEventRouterSmtDiagram"]
  key_links:
    - from: "OutboxPatternDiagrams.tsx"
      to: "primitives"
      via: "import from ../primitives"
      pattern: "from ['\"]\\.\\.\/primitives['\"]"
    - from: "All diagrams"
      to: "DiagramTooltip"
      via: "Tooltip wrapper for FlowNode"
      pattern: "<DiagramTooltip.*content="
---

<objective>
Create glass diagram components for Module 5 lessons 04-06 (Routing & Outbox Pattern).

Purpose: Replace 8 Mermaid diagrams with interactive React components. Content-based routing shows multi-tenant topic splitting. Outbox pattern diagrams visualize the dual-write problem solution using transactional outbox tables with CDC.

Output:
- ContentRoutingDiagrams.tsx with 3 diagrams (content-based router, multi-tenant, region-based)
- OutboxPatternDiagrams.tsx with 4 diagrams (dual-write problem, outbox solution, transaction flow, microservices architecture)
- OutboxImplementationDiagrams.tsx with 1 diagram (Outbox Event Router SMT)
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-module-5-diagram-migration/32-RESEARCH.md

@src/components/diagrams/primitives/FlowNode.tsx
@src/components/diagrams/primitives/Arrow.tsx
@src/components/diagrams/primitives/DiagramContainer.tsx
@src/components/diagrams/primitives/Tooltip.tsx

@src/content/course/05-module-5/04-content-based-routing.mdx
@src/content/course/05-module-5/05-outbox-pattern-theory.mdx
@src/content/course/05-module-5/06-outbox-implementation.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContentRoutingDiagrams.tsx (3 diagrams)</name>
  <files>src/components/diagrams/module5/ContentRoutingDiagrams.tsx</files>
  <action>
Create ContentRoutingDiagrams.tsx with 3 diagram components for content-based routing concepts:

1. **ContentBasedRouterDiagram**:
   - Vertical flow: Source Table -> Debezium -> ContentBasedRouter SMT -> Multiple output topics
   - Router node in purple
   - Show Groovy expression example: `value.after.region == 'EU' ? 'events-eu' : 'events-us'`
   - Output topics branching to EU and US destinations

2. **MultiTenantRoutingDiagram** (based on RESEARCH.md pattern):
   - PostgreSQL (multi-tenant) -> ContentBasedRouter -> Multiple tenant topics
   - Show tenant_id field routing to different topics
   - Example: tenant=acme -> orders-acme (blue), tenant=globex -> orders-globex (purple)
   - Arrows labeled with routing condition

3. **RegionBasedRoutingDiagram**:
   - Similar to multi-tenant but with region field
   - Show EU/US/APAC routing to regional topics
   - Color-code regions: EU=blue, US=purple, APAC=amber

Russian tooltips explaining:
- When to use ContentBasedRouter vs ByLogicalTableRouter
- Groovy expression syntax for routing
- Multi-tenant isolation benefits
  </action>
  <verify>
- `npm run build` completes without errors
- File exists and exports 3 named functions
- Routing diagrams show branching paths with labeled arrows
  </verify>
  <done>
ContentRoutingDiagrams.tsx exports ContentBasedRouterDiagram, MultiTenantRoutingDiagram, RegionBasedRoutingDiagram with interactive tooltips
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OutboxPatternDiagrams.tsx (4 diagrams)</name>
  <files>src/components/diagrams/module5/OutboxPatternDiagrams.tsx</files>
  <action>
Create OutboxPatternDiagrams.tsx with 4 diagram components matching Mermaid diagrams in 05-outbox-pattern-theory.mdx:

1. **DualWriteProblemDiagram** (Mermaid flowchart TB at line 41):
   - approve_order(123) -> UPDATE orders -> COMMIT -> kafka_producer.send(...)
   - Fork at kafka success: SUCCESS path (emerald) vs FAIL path (rose)
   - SUCCESS: "БД обновлена, Событие отправлено, Consistency OK"
   - FAIL: "БД обновлена, Событие НЕ отправлено, Data loss!"
   - Kafka step colored amber to highlight risk point

2. **OutboxSolutionDiagram** (Mermaid flowchart LR at line 74):
   - Complex diagram with 4 subgraphs: Application, PostgreSQL, CDC (Debezium), Kafka
   - Application: Business Logic -> BEGIN TX -> UPDATE orders -> INSERT outbox -> COMMIT
   - PostgreSQL: orders table, outbox table, WAL (with dotted lines showing atomic write)
   - CDC: Debezium Connector -> Outbox Event Router SMT
   - Kafka: order-events topic
   - Use nested DiagramContainers for subgraphs
   - Color scheme: APP=purple, DB=blue, CDC=amber, Kafka=emerald

3. **OutboxTransactionFlowDiagram** (use RESEARCH.md example):
   - Vertical flow showing atomic transaction
   - Application -> BEGIN TRANSACTION -> (UPDATE orders + INSERT outbox) -> COMMIT
   - PostgreSQL WAL with "Atomic commit" emerald label
   - Debezium CDC -> Debezium + Outbox SMT -> Kafka Topic
   - Tooltips explaining why atomicity guarantees event delivery

4. **MicroservicesOutboxDiagram** (Mermaid flowchart TB at line 362):
   - Multi-service architecture: Order Service, Payment Service, Notification Service
   - Each service has its own PostgreSQL + outbox
   - Debezium connectors per service
   - Kafka topics: outbox.event.Order, outbox.event.Payment
   - Notification Service consumes from both topics
   - Use nested DiagramContainers for service boundaries

Russian tooltips explaining:
- Why dual-write fails (network partitions, crash scenarios)
- How CDC guarantees at-least-once delivery
- Eventual consistency vs immediate consistency
- Idempotency requirements for consumers
  </action>
  <verify>
- `npm run build` completes without errors
- File exists and exports 4 named functions
- Dual-write problem shows failure path in rose color
- Outbox solution shows 4 distinct subsystems
  </verify>
  <done>
OutboxPatternDiagrams.tsx exports DualWriteProblemDiagram, OutboxSolutionDiagram, OutboxTransactionFlowDiagram, MicroservicesOutboxDiagram with interactive tooltips
  </done>
</task>

<task type="auto">
  <name>Task 3: Create OutboxImplementationDiagrams.tsx (1 diagram)</name>
  <files>src/components/diagrams/module5/OutboxImplementationDiagrams.tsx</files>
  <action>
Create OutboxImplementationDiagrams.tsx with 1 diagram component for lesson 06:

1. **OutboxEventRouterSmtDiagram**:
   - Shows transformation from outbox CDC record to domain event
   - Input: Outbox table CDC record with fields (id, aggregatetype, aggregateid, type, payload)
   - Output: Clean domain event in Kafka
   - Mapping visualization:
     - aggregatetype = "Order" -> Topic: outbox.event.Order
     - aggregateid = "order-123" -> Kafka key: "order-123"
     - type = "OrderApproved" -> Event header: type = "OrderApproved"
     - payload = {...} -> Kafka message value
   - Use side-by-side comparison: Outbox Record (rose) -> Kafka Event (emerald)
   - Arrow labeled "Outbox Event Router SMT"

Russian tooltips explaining:
- How aggregatetype determines topic name
- Why aggregateid becomes Kafka key (partition affinity)
- Header propagation for event type filtering
  </action>
  <verify>
- `npm run build` completes without errors
- File exists and exports 1 named function
- Diagram shows field mapping from outbox to Kafka event
  </verify>
  <done>
OutboxImplementationDiagrams.tsx exports OutboxEventRouterSmtDiagram showing outbox-to-Kafka field mapping with tooltips
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds with no errors
2. All 3 component files exist in src/components/diagrams/module5/
3. Total 8 diagram components exported
4. Each diagram has Russian tooltips
5. Outbox diagrams show atomic transaction boundaries clearly
6. Multi-tenant routing shows branching to different topics
</verification>

<success_criteria>
- 3 component files created with 8 total diagram exports
- All diagrams use FlowNode, Arrow, DiagramContainer, DiagramTooltip primitives
- Content-based routing shows topic splitting with labeled branches
- Outbox pattern clearly visualizes atomic write and CDC capture
- Dual-write problem shows failure scenario in rose color
- Microservices architecture uses nested DiagramContainers
- All tooltips in Russian
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-module-5-diagram-migration/32-02-SUMMARY.md`
</output>
