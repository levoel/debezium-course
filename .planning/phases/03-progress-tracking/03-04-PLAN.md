---
phase: 03-progress-tracking
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/pages/index.astro
  - src/pages/course/[...slug].astro
autonomous: false

must_haves:
  truths:
    - "Homepage shows progress percentage via ProgressIndicator"
    - "Homepage shows export/import controls via ProgressExport"
    - "Lesson pages show LessonCompleteButton for marking completion"
    - "All progress features work after page refresh"
    - "All progress features work in new browser tabs"
  artifacts:
    - path: "src/pages/index.astro"
      provides: "Homepage with progress display"
      contains: ["ProgressIndicator", "ProgressExport"]
    - path: "src/pages/course/[...slug].astro"
      provides: "Lesson pages with completion button"
      contains: "LessonCompleteButton"
  key_links:
    - from: "src/pages/index.astro"
      to: "src/components/ProgressIndicator.tsx"
      via: "Astro island with client:load"
      pattern: "ProgressIndicator.*client:load"
    - from: "src/pages/index.astro"
      to: "src/components/ProgressExport.tsx"
      via: "Astro island with client:load"
      pattern: "ProgressExport.*client:load"
    - from: "src/pages/course/[...slug].astro"
      to: "src/components/LessonCompleteButton.tsx"
      via: "Astro island with client:load"
      pattern: "LessonCompleteButton.*client:load"
---

<objective>
Integrate progress components into pages and verify complete functionality.

Purpose: Wire all components together so students can use progress tracking - see progress on homepage, mark lessons complete on lesson pages.
Output: Working progress tracking across all pages with persistence.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-progress-tracking/03-RESEARCH.md

# Pages to update
@src/pages/index.astro
@src/pages/course/[...slug].astro

# Components to integrate (created in 03-02)
@src/components/ProgressIndicator.tsx
@src/components/ProgressExport.tsx
@src/components/LessonCompleteButton.tsx

# Navigation utility for lesson count
@src/utils/navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress components to homepage</name>
  <files>src/pages/index.astro</files>
  <action>
Update src/pages/index.astro to show ProgressIndicator and ProgressExport:

1. Add imports in frontmatter:
```astro
---
import { ProgressIndicator } from '../components/ProgressIndicator';
import { ProgressExport } from '../components/ProgressExport';
// ... existing imports
---
```

2. Add totalLessons calculation after sortedLessons:
```astro
// Total lessons for progress indicator
const totalLessons = sortedLessons.length;
```

3. Add progress section after the "Что вы получите" box and before the CourseRoadmap.
Insert this block:

```astro
<!-- Progress Tracking Section -->
<div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-8">
  <div class="grid gap-6 lg:grid-cols-2">
    <div>
      <ProgressIndicator totalLessons={totalLessons} client:load />
    </div>
    <div>
      <ProgressExport client:load />
    </div>
  </div>
</div>
```

Key decisions:
- Use `client:load` (not client:visible) for progress components - they need localStorage immediately
- Grid layout: progress bar on left, export/import on right (stacks on mobile)
- Placed before roadmap so user sees progress first
- bg-gray-800 matches existing card styling
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Run `npm run dev` and visit homepage - progress section should appear.
  </verify>
  <done>Homepage shows ProgressIndicator and ProgressExport components.</done>
</task>

<task type="auto">
  <name>Task 2: Add LessonCompleteButton to lesson pages</name>
  <files>src/pages/course/[...slug].astro</files>
  <action>
Update src/pages/course/[...slug].astro to show completion button:

1. Add import in frontmatter:
```astro
---
import { LessonCompleteButton } from '../../components/LessonCompleteButton';
// ... existing imports
---
```

2. Get the current lesson slug for the button:
```astro
// Clean slug for progress tracking (same as used in routing)
const lessonSlug = entry.id.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '');
```

3. Add the completion button after the lesson metadata section (after the closing </div> of the metadata block, before the article):

```astro
<!-- Lesson completion -->
<div class="mb-8">
  <LessonCompleteButton slug={lessonSlug} client:load />
</div>
```

4. Also add a completion prompt at the end of the lesson content, before the navigation section:

```astro
<!-- Lesson content -->
<article class="prose prose-invert prose-lg max-w-none">
  <Content />
</article>

<!-- End of lesson completion prompt -->
<div class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-lg">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <h3 class="text-lg font-semibold text-gray-200 mb-1">Закончили урок?</h3>
      <p class="text-sm text-gray-400">Отметьте его как пройденный, чтобы отслеживать свой прогресс</p>
    </div>
    <LessonCompleteButton slug={lessonSlug} client:load />
  </div>
</div>
```

Key decisions:
- Button appears twice: at top (for quick marking) and at bottom (natural end-of-lesson action)
- Use `client:load` for immediate interactivity
- Slug extracted using same cleanSlug logic as routing to ensure consistency
- Russian text for prompts
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Run `npm run dev` and visit a lesson page - completion buttons should appear at top and bottom.
  </verify>
  <done>Lesson pages show LessonCompleteButton at top and bottom with completion prompt.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete progress tracking system:
- Progress store with localStorage persistence
- ProgressIndicator showing percentage on homepage
- ProgressExport for backup/restore
- LessonCompleteButton on lesson pages
- Visual indicators on CourseRoadmap (green nodes, checkmarks)
- Visual indicators on Navigation sidebar (checkmarks)
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:4321 (or appropriate port)

2. **Verify homepage progress display:**
   - Progress bar should show 0% initially
   - "0 из N уроков пройдено" text visible
   - Export/Import buttons visible

3. **Verify lesson completion:**
   - Click any lesson in the roadmap or sidebar
   - See "Отметить как пройденный" button at top
   - Click the button - should turn green with "Урок пройден"
   - Scroll to bottom - should see completion prompt with button (also green now)

4. **Verify roadmap updates:**
   - Return to homepage
   - Completed lesson should show green node with ✓ prefix
   - Progress bar should update (e.g., 50% if 1 of 2 lessons)

5. **Verify sidebar updates:**
   - Sidebar should show green checkmark next to completed lesson

6. **Verify persistence:**
   - Refresh the page (F5)
   - Progress should remain (still shows completed lesson)
   - Close browser, reopen, revisit site
   - Progress should still be there

7. **Verify export/import:**
   - Click "Экспорт" button
   - JSON file should download
   - Mark another lesson complete
   - Click "Импорт" and select the downloaded file
   - Progress should revert to exported state (first lesson only)
   - Success message should appear briefly

8. **Verify toggle behavior:**
   - On a completed lesson, click the green button
   - Should turn gray "Отметить как пройденный"
   - Roadmap and sidebar should update (remove green/checkmark)
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` starts successfully
3. Homepage shows ProgressIndicator with percentage
4. Homepage shows ProgressExport with export/import buttons
5. Lesson pages show LessonCompleteButton (top and bottom)
6. CourseRoadmap shows green nodes for completed lessons
7. Navigation shows checkmarks for completed lessons
8. Progress persists across page refresh
9. Export creates valid JSON file
10. Import restores progress correctly
</verification>

<success_criteria>
- Student progress persists when browser is closed and reopened (Success Criteria 1)
- Completed lessons display visual indicators on the roadmap (Success Criteria 2)
- Progress percentage appears on the course homepage (Success Criteria 3)
- Students can mark lessons as complete manually (Success Criteria 4)
- Progress data survives browser cache clearing via export/import (Success Criteria 5)
</success_criteria>

<output>
After completion, create `.planning/phases/03-progress-tracking/03-04-SUMMARY.md`
</output>
