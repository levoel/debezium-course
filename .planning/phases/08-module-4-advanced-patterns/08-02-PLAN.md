---
phase: 08-module-4-advanced-patterns
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/course/04-module-4/03-pii-masking.mdx
  - src/content/course/04-module-4/04-content-based-routing.mdx
autonomous: true

must_haves:
  truths:
    - "Student can mask PII fields using MaskField SMT"
    - "Student can configure replacement values for masked fields"
    - "Student can route events to different topics based on field values"
    - "Student can use ContentBasedRouter with Groovy expressions"
  artifacts:
    - path: "src/content/course/04-module-4/03-pii-masking.mdx"
      provides: "PII masking with MaskField SMT"
      contains: "MaskField"
    - path: "src/content/course/04-module-4/04-content-based-routing.mdx"
      provides: "Content-based routing configuration"
      contains: "ContentBasedRouter"
  key_links:
    - from: "03-pii-masking.mdx"
      to: "connector config"
      via: "MaskField configuration"
      pattern: "transforms.mask.fields"
    - from: "04-content-based-routing.mdx"
      to: "connector config"
      via: "routing expression"
      pattern: "topic.expression"
---

<objective>
Create SMT application lessons covering PII data masking and content-based event routing.

Purpose: Students learn practical SMT use cases for compliance (GDPR/PII) and multi-tenant/regional routing.
Output: Two MDX lesson files teaching MaskField and ContentBasedRouter SMTs.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-module-4-advanced-patterns/08-RESEARCH.md

# Pattern reference
@src/content/course/03-module-3/01-jmx-metrics-interpretation.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PII Masking Lesson (03-pii-masking.mdx)</name>
  <files>src/content/course/04-module-4/03-pii-masking.mdx</files>
  <action>
Create lesson teaching PII data masking using MaskField SMT.

Content structure:
1. **Why mask data in CDC** - GDPR compliance, downstream system limitations, security
2. **MaskField SMT basics:**
   ```json
   "transforms": "mask",
   "transforms.mask.type": "org.apache.kafka.connect.transforms.MaskField$Value",
   "transforms.mask.fields": "ssn,credit_card,email",
   "transforms.mask.replacement": "***MASKED***"
   ```
3. **Field types and masking behavior:**
   - String: replaced with `replacement` value
   - Numeric: replaced with 0 or custom value
   - Date: replaced with epoch (0)
4. **Combining with ExtractNewRecordState:**
   ```json
   "transforms": "unwrap,mask",
   "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
   "transforms.mask.type": "org.apache.kafka.connect.transforms.MaskField$Value"
   ```
5. **Key vs Value masking** - Use `MaskField$Key` for key field masking
6. **Selective masking with predicates** - Mask only specific tables
7. **Lab: Mask customer PII fields** - ssn, email, phone in customers table

Include table showing field type → masked value mapping.

Security callout: MaskField replaces data, doesn't encrypt. Original data still in WAL until retention.

Frontmatter:
- title: "PII Data Masking with SMT"
- description: "Protecting sensitive data using MaskField SMT"
- order: 3
- difficulty: "intermediate"
- estimatedTime: 25
- topics: ["pii", "masking", "gdpr", "smt", "security"]
- prerequisites: ["module-4/02-predicates-filtering"]

Language: Russian explanatory text, English code/config.
  </action>
  <verify>File exists at src/content/course/04-module-4/03-pii-masking.mdx with MaskField configuration examples</verify>
  <done>Lesson explains PII masking motivation, shows MaskField$Value configuration, covers field types and predicates</done>
</task>

<task type="auto">
  <name>Task 2: Create Content-Based Routing Lesson (04-content-based-routing.mdx)</name>
  <files>src/content/course/04-module-4/04-content-based-routing.mdx</files>
  <action>
Create lesson teaching content-based event routing using ContentBasedRouter and ByLogicalTableRouter SMTs.

Content structure:
1. **Why route events** - Multi-tenant isolation, regional compliance, priority queues
2. **ByLogicalTableRouter** - Regex-based topic renaming:
   ```json
   "transforms": "route",
   "transforms.route.type": "io.debezium.transforms.ByLogicalTableRouter",
   "transforms.route.topic.regex": "(.*)customers_shard(.*)",
   "transforms.route.topic.replacement": "$1customers_all_shards"
   ```
3. **ContentBasedRouter** - Field value-based routing with Groovy:
   ```json
   "transforms": "route",
   "transforms.route.type": "io.debezium.transforms.ContentBasedRouter",
   "transforms.route.language": "jsr223.groovy",
   "transforms.route.topic.expression": "value.after.region == 'EU' ? 'events-eu' : 'events-us'"
   ```
4. **Use cases:**
   - Regional data sovereignty (EU data → EU topic)
   - Multi-tenant SaaS (tenant_id → tenant-specific topic)
   - Priority routing (VIP customers → priority topic)
5. **Predicate protection** - Route SMT needs predicates to avoid failures on non-DML events
6. **Key uniqueness** - ByLogicalTableRouter `key.enforce.uniqueness` for merged topics
7. **Lab: Route orders by region** - EU orders → orders-eu, US orders → orders-us

Include Mermaid diagram showing content-based routing decision flow.

Pitfall callout: ContentBasedRouter requires JSR 223 implementation (Groovy) in classpath.

Frontmatter:
- title: "Content-Based Event Routing"
- description: "Routing CDC events to different topics based on content"
- order: 4
- difficulty: "intermediate"
- estimatedTime: 30
- topics: ["routing", "smt", "multi-tenant", "regional"]
- prerequisites: ["module-4/03-pii-masking"]

Language: Russian explanatory text, English code/config.
  </action>
  <verify>File exists at src/content/course/04-module-4/04-content-based-routing.mdx with ContentBasedRouter examples</verify>
  <done>Lesson explains routing use cases, shows ByLogicalTableRouter and ContentBasedRouter, includes Groovy expression example</done>
</task>

</tasks>

<verification>
- Both MDX files exist in src/content/course/04-module-4/
- Frontmatter is valid YAML with required fields
- Code blocks use correct language tags
- Prerequisites chain correctly (03 -> 02, 04 -> 03)
</verification>

<success_criteria>
- Lesson 03 covers MaskField SMT for PII protection
- Lesson 04 explains content-based routing with Groovy
- Both lessons follow established pattern (Russian text, English code)
- Requirements MOD4-03 and MOD4-04 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/08-module-4-advanced-patterns/08-02-SUMMARY.md`
</output>
