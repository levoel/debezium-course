---
phase: 27-sequence-diagram-primitives
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/components/diagrams/primitives/SequenceDiagram.tsx
  - src/components/diagrams/primitives/types.ts
  - src/components/diagrams/primitives/index.ts
autonomous: true

must_haves:
  truths:
    - "SequenceDiagram renders actors in a horizontal row with equal spacing"
    - "SequenceDiagram renders lifelines extending from each actor"
    - "SequenceDiagram renders messages at specified y positions between actors"
    - "User can click actors and messages to reveal tooltips"
    - "Sequence diagram layout adapts to variable actor count (4-7 typical)"
  artifacts:
    - path: "src/components/diagrams/primitives/SequenceDiagram.tsx"
      provides: "Layout container for sequence diagrams"
      exports: ["SequenceDiagram"]
    - path: "src/components/diagrams/primitives/types.ts"
      provides: "Actor and Message type definitions"
      contains: "SequenceDiagramProps"
  key_links:
    - from: "SequenceDiagram.tsx"
      to: "SequenceActor, SequenceLifeline, SequenceMessage"
      via: "imports from primitives"
      pattern: "import.*SequenceActor"
    - from: "SequenceDiagram.tsx"
      to: "DiagramTooltip"
      via: "tooltip wrapping"
      pattern: "<DiagramTooltip"
---

<objective>
Create the SequenceDiagram layout container that composes SequenceActor, SequenceLifeline, and SequenceMessage into complete interactive sequence diagrams with tooltip support.

Purpose: This container handles column-based layout calculation, lifeline positioning, and integrates with DiagramTooltip for interactive explanations. It enables building complete sequence diagrams from declarative actor/message definitions.

Output: SequenceDiagram component with column layout algorithm and tooltip integration, completing the sequence diagram primitives library.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-sequence-diagram-primitives/27-RESEARCH.md
@.planning/phases/27-sequence-diagram-primitives/27-01-SUMMARY.md

# Primitives from Plan 01
@src/components/diagrams/primitives/SequenceActor.tsx
@src/components/diagrams/primitives/SequenceLifeline.tsx
@src/components/diagrams/primitives/SequenceMessage.tsx
@src/components/diagrams/primitives/Tooltip.tsx
@src/components/diagrams/primitives/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SequenceDiagram types to types.ts</name>
  <files>src/components/diagrams/primitives/types.ts</files>
  <action>
Add type definitions for the SequenceDiagram component's actor and message data structures.

Append to types.ts after the existing SequenceMessageProps:

```typescript
// SequenceDiagram layout types
export interface SequenceActorDef {
  id: string;
  label: string;
  variant?: SequenceActorVariant;
  tooltip?: React.ReactNode;
}

export interface SequenceMessageDef {
  id: string;
  from: string;
  to: string;
  label: string;
  variant?: SequenceMessageVariant;
  tooltip?: React.ReactNode;
}

export interface SequenceDiagramProps {
  actors: SequenceActorDef[];
  messages: SequenceMessageDef[];
  messageSpacing?: number;
  className?: string;
}
```

These types define the declarative API for sequence diagrams:
- SequenceActorDef: Actor definition with id, label, variant, and optional tooltip content
- SequenceMessageDef: Message definition with from/to actor ids, label, variant, tooltip
- SequenceDiagramProps: The main component props accepting arrays of actors and messages
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check: Types compile without errors.
  </verify>
  <done>
types.ts contains SequenceActorDef, SequenceMessageDef, and SequenceDiagramProps interfaces.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SequenceDiagram layout component</name>
  <files>src/components/diagrams/primitives/SequenceDiagram.tsx</files>
  <action>
Create the SequenceDiagram component that composes the primitive components with column-based layout.

**Layout algorithm:**
- Actors positioned using flex justify-around in a horizontal row
- Column centers calculated as: (columnWidth * index) + (columnWidth / 2)
- Use percentage-based positioning (100 / actorCount) for responsive layout
- SVG below actors renders lifelines and messages

**Component structure:**
```tsx
import { SequenceActor } from './SequenceActor';
import { SequenceLifeline } from './SequenceLifeline';
import { SequenceMessage } from './SequenceMessage';
import { DiagramTooltip } from './Tooltip';
import type { SequenceDiagramProps, SequenceActorDef, SequenceMessageDef } from './types';

export function SequenceDiagram({
  actors,
  messages,
  messageSpacing = 40,
  className = '',
}: SequenceDiagramProps) {
  // Calculate diagram height based on message count
  const diagramHeight = 20 + messages.length * messageSpacing;

  // Calculate column width as percentage
  const columnWidth = 100 / actors.length;

  // Helper to get actor column center X position (as percentage)
  const getActorCenterX = (actorId: string): number => {
    const index = actors.findIndex(a => a.id === actorId);
    if (index === -1) return 50; // fallback to center
    return columnWidth * index + columnWidth / 2;
  };

  return (
    <div className={`relative ${className}`}>
      {/* Actor row */}
      <div className="flex justify-around mb-4">
        {actors.map((actor) => (
          actor.tooltip ? (
            <DiagramTooltip key={actor.id} content={actor.tooltip}>
              <SequenceActor variant={actor.variant} tabIndex={0}>
                {actor.label}
              </SequenceActor>
            </DiagramTooltip>
          ) : (
            <SequenceActor key={actor.id} variant={actor.variant}>
              {actor.label}
            </SequenceActor>
          )
        ))}
      </div>

      {/* SVG for lifelines and messages */}
      <svg
        width="100%"
        height={diagramHeight}
        className="overflow-visible"
        aria-label="Sequence diagram messages"
      >
        {/* Lifelines - positioned at actor column centers */}
        {actors.map((actor) => {
          const x = getActorCenterX(actor.id);
          return (
            <line
              key={`lifeline-${actor.id}`}
              x1={`${x}%`}
              y1="0"
              x2={`${x}%`}
              y2={diagramHeight}
              stroke="currentColor"
              strokeWidth="1"
              strokeDasharray="4 3"
              className="text-gray-500"
            />
          );
        })}

        {/* Messages */}
        {messages.map((msg, i) => {
          const fromX = getActorCenterX(msg.from);
          const toX = getActorCenterX(msg.to);
          const y = 20 + i * messageSpacing;

          // Note: SequenceMessage expects pixel values, but we're using percentages
          // We'll render messages inline here for percentage support
          const isLeftToRight = toX > fromX;
          const arrowheadSize = 8;
          const lineStyle = msg.variant === 'return' ? { strokeDasharray: '4 2' } : {};
          const arrowFill = msg.variant === 'sync' ? 'currentColor' : 'none';

          // Arrow path calculation
          const arrowPath = isLeftToRight
            ? `M${-arrowheadSize},${-arrowheadSize/2} L0,0 L${-arrowheadSize},${arrowheadSize/2}`
            : `M${arrowheadSize},${-arrowheadSize/2} L0,0 L${arrowheadSize},${arrowheadSize/2}`;

          const messageContent = (
            <g
              key={msg.id}
              className="text-gray-400"
              tabIndex={msg.tooltip ? 0 : undefined}
              role={msg.tooltip ? 'button' : undefined}
              style={{ cursor: msg.tooltip ? 'pointer' : undefined }}
            >
              <line
                x1={`${fromX}%`}
                y1={y}
                x2={`${toX}%`}
                y2={y}
                stroke="currentColor"
                strokeWidth="1.5"
                {...lineStyle}
              />
              {/* Arrowhead at destination */}
              <g transform={`translate(${toX}%, ${y})`} style={{ transform: `translate(calc(${toX}% + ${isLeftToRight ? -1 : 1}px), ${y}px)` }}>
                <path
                  d={arrowPath}
                  stroke="currentColor"
                  strokeWidth="1.5"
                  fill={arrowFill}
                  strokeLinejoin="round"
                  transform={`translate(${isLeftToRight ? 0 : 0}, 0)`}
                />
              </g>
              {/* Label above line */}
              <text
                x={`${(fromX + toX) / 2}%`}
                y={y - 6}
                textAnchor="middle"
                className="text-xs fill-gray-300"
              >
                {msg.label}
              </text>
            </g>
          );

          // Wrap in tooltip if tooltip content provided
          if (msg.tooltip) {
            return (
              <DiagramTooltip key={msg.id} content={msg.tooltip}>
                {messageContent}
              </DiagramTooltip>
            );
          }
          return messageContent;
        })}
      </svg>
    </div>
  );
}
```

**Important implementation notes:**
- Use percentage-based x positions for lifelines: x1={`${x}%`}
- SVG supports percentage values in attributes
- Arrowhead positioning needs special handling - use a simpler approach with the SVG marker element or inline transform
- Handle cases where actor id not found (fallback to center)
- Wrap actors/messages with tooltips only when tooltip prop provided

Simplify the arrowhead by using a different approach - calculate actual pixel positions based on a ref to the SVG container, or use CSS transform with percentage positioning. The research doc shows detailed patterns.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Run: `npm run build`
Check: Component compiles and builds without errors.
  </verify>
  <done>
SequenceDiagram.tsx exports a layout container that:
- Renders actors in flex row with even spacing
- Renders dashed lifelines from each actor
- Renders messages with labels between actor lifelines
- Supports tooltips on actors and messages
- Calculates layout based on actor count
  </done>
</task>

<task type="auto">
  <name>Task 3: Update barrel exports and verify integration</name>
  <files>src/components/diagrams/primitives/index.ts</files>
  <action>
Add SequenceDiagram export to the barrel file and verify the complete primitives library.

Update index.ts:

```typescript
/**
 * Diagram primitives barrel exports
 * Reusable building blocks for glass-styled diagrams
 */

export * from './types';
export { FlowNode } from './FlowNode';
export { Arrow } from './Arrow';
export { DiagramContainer } from './DiagramContainer';
export { DiagramTooltip } from './Tooltip';

// Sequence diagram primitives
export { SequenceActor } from './SequenceActor';
export { SequenceLifeline } from './SequenceLifeline';
export { SequenceMessage } from './SequenceMessage';
export { SequenceDiagram } from './SequenceDiagram';
```

The primitives library now exports 8 components total:
- Flowchart: FlowNode, Arrow, DiagramContainer, DiagramTooltip
- Sequence: SequenceActor, SequenceLifeline, SequenceMessage, SequenceDiagram

Verify by checking imports work:
```typescript
import {
  SequenceDiagram,
  SequenceActor,
  DiagramContainer,
  type SequenceActorDef,
  type SequenceMessageDef
} from '@/components/diagrams/primitives';
```
  </action>
  <verify>
Run: `npm run build`
Check: Build succeeds with all 8 primitives exported.
Run: `grep "export" src/components/diagrams/primitives/index.ts | wc -l`
Check: Should show 9 exports (1 types + 8 components).
  </verify>
  <done>
index.ts exports all 8 primitives. Build passes. Sequence diagram primitives library is complete.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. SequenceDiagram properly composes:
   - SequenceActor in flex row
   - Lifelines as dashed SVG lines
   - Messages with directional arrows and labels
4. Tooltips work on actors and messages
5. Layout responds to different actor counts (test with 3, 5, 7 actors mentally)
</verification>

<success_criteria>
- SequenceDiagram renders actors in a horizontal row with equal spacing
- Lifelines extend from each actor position down through the message area
- Messages render at correct y positions with arrows pointing in correct direction
- Click on actors/messages with tooltip content reveals tooltip
- Layout adapts to variable actor count (4-7 range typical for course diagrams)
- Build passes without errors
- All 8 primitives exported from index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/27-sequence-diagram-primitives/27-02-SUMMARY.md`
</output>
