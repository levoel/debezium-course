---
phase: 02-navigation-roadmap
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/layouts/BaseLayout.astro
  - src/pages/index.astro
autonomous: false

must_haves:
  truths:
    - "Sidebar is always visible on desktop (lg:1024px+)"
    - "Hamburger button appears on mobile and toggles sidebar"
    - "Clicking overlay closes mobile sidebar"
    - "Landing page shows interactive course roadmap"
    - "Roadmap nodes are clickable and navigate to lessons"
  artifacts:
    - path: "src/layouts/BaseLayout.astro"
      provides: "Responsive layout with sidebar navigation"
      contains: "MobileMenuToggle"
    - path: "src/pages/index.astro"
      provides: "Landing page with roadmap"
      contains: "CourseRoadmap"
  key_links:
    - from: "src/layouts/BaseLayout.astro"
      to: "src/components/Navigation.tsx"
      via: "client:load directive"
      pattern: "Navigation.*client:load"
    - from: "src/layouts/BaseLayout.astro"
      to: "src/stores/navigation.ts"
      via: "inline script subscription"
      pattern: "isSidebarOpen\\.subscribe"
    - from: "src/pages/index.astro"
      to: "src/components/CourseRoadmap.tsx"
      via: "client:visible directive"
      pattern: "CourseRoadmap.*client:visible"
---

<objective>
Integrate navigation components into BaseLayout and add interactive roadmap to landing page. This completes the Phase 2 navigation system.

Purpose: Connect all navigation components - BaseLayout gets responsive sidebar with mobile toggle, landing page gets interactive roadmap. Together they fulfill all Phase 2 success criteria.
Output: Updated `src/layouts/BaseLayout.astro` with responsive navigation, updated `src/pages/index.astro` with course roadmap.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-navigation-roadmap/02-RESEARCH.md

# Components created in prior plans
@src/components/MobileMenuToggle.tsx
@src/components/Navigation.tsx
@src/components/CourseRoadmap.tsx
@src/stores/navigation.ts
@src/utils/navigation.ts

# Existing files to modify
@src/layouts/BaseLayout.astro
@src/pages/index.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update BaseLayout with responsive sidebar navigation</name>
  <files>src/layouts/BaseLayout.astro</files>
  <action>
Update `src/layouts/BaseLayout.astro`:

1. Add imports in frontmatter:
```astro
---
import { getNavigationTree } from '../utils/navigation';
import { Navigation } from '../components/Navigation';
import { MobileMenuToggle } from '../components/MobileMenuToggle';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
const navigationTree = await getNavigationTree();
const currentPath = Astro.url.pathname;

// Convert Map to serializable array for React island
const modulesArray = Array.from(navigationTree.entries()).map(([moduleId, lessons]) => ({
  moduleId,
  lessons
}));
---
```

2. Update body structure:
   - Add mobile overlay div (hidden by default, controlled by script)
   - Update sidebar to be fixed on mobile, sticky on desktop
   - Add transform classes for slide-in animation
   - Add MobileMenuToggle in header
   - Pass navigation data to Navigation component

3. Sidebar classes (responsive):
```html
<aside
  id="sidebar"
  class="
    fixed inset-y-0 left-0 z-50 w-64
    transform -translate-x-full transition-transform duration-300
    lg:relative lg:translate-x-0 lg:sticky lg:top-0 lg:h-screen
    bg-gray-800 border-r border-gray-700 overflow-y-auto
  "
>
```

4. Mobile overlay:
```html
<div
  id="sidebar-overlay"
  class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
/>
```

5. Add inline script to sync nanostores with DOM:
```html
<script>
  import { isSidebarOpen } from '../stores/navigation';

  isSidebarOpen.subscribe(isOpen => {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    if (sidebar && overlay) {
      if (isOpen) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }
  });

  // Close on overlay click
  document.getElementById('sidebar-overlay')?.addEventListener('click', () => {
    isSidebarOpen.set(false);
  });
</script>
```

6. Component integration:
   - `<MobileMenuToggle client:load />` in header (hidden on lg+)
   - `<Navigation modules={modulesArray} currentPath={currentPath} client:load />` in sidebar

AVOID:
- Removing existing styles/structure unnecessarily
- Forgetting client:load directives (components won't hydrate)
- Passing Map directly to React (not serializable - use array conversion)
  </action>
  <verify>
    - `cat src/layouts/BaseLayout.astro` shows MobileMenuToggle and Navigation imports
    - Has sidebar-overlay div with close handler
    - Has inline script importing from stores/navigation
    - Uses client:load for both components
    - `npm run build` succeeds
  </verify>
  <done>
    - BaseLayout updated with responsive sidebar
    - MobileMenuToggle in header (hidden on desktop)
    - Navigation component in sidebar
    - Overlay closes sidebar on click
    - Nanostores subscription syncs state to DOM
  </done>
</task>

<task type="auto">
  <name>Task 2: Add interactive roadmap to landing page</name>
  <files>src/pages/index.astro</files>
  <action>
Update `src/pages/index.astro`:

1. Add imports:
```astro
---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { CourseRoadmap } from '../components/CourseRoadmap';

const allCourses = await getCollection('course');
const sortedCourses = allCourses
  .filter(c => !c.data.draft)
  .sort((a, b) => a.data.order - b.data.order);

// Prepare lessons array for roadmap (serializable)
const roadmapLessons = sortedCourses.map(entry => ({
  title: entry.data.title,
  slug: entry.slug, // e.g., "01-intro" from "01-intro/index.mdx"
}));
---
```

2. Add CourseRoadmap component after page header, before lesson list:
```astro
<CourseRoadmap lessons={roadmapLessons} client:visible />
```

Use `client:visible` (not client:load) because roadmap may be below the fold - lazy hydration improves initial load performance.

3. Add a heading section for the roadmap:
```html
<section class="mb-12">
  <h2 class="text-2xl font-bold text-gray-100 mb-6">Карта курса</h2>
  <CourseRoadmap lessons={roadmapLessons} client:visible />
</section>
```

4. Keep existing lesson cards section below roadmap

AVOID:
- Using client:load for roadmap (wastes JavaScript on initial load)
- Breaking existing lesson list functionality
- Removing difficulty badges and metadata from lesson cards
  </action>
  <verify>
    - `cat src/pages/index.astro` shows CourseRoadmap import and usage
    - Uses client:visible directive
    - Roadmap section has Russian heading "Карта курса"
    - Lesson cards section preserved below roadmap
    - `npm run build` succeeds
  </verify>
  <done>
    - Landing page has interactive roadmap section
    - Roadmap uses client:visible for lazy hydration
    - Existing lesson list preserved
    - Russian localization maintained
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete navigation system</name>
  <what-built>
    Complete Phase 2 navigation system:
    - Responsive sidebar (always visible desktop, slide-in mobile)
    - Hamburger menu toggle on mobile
    - Navigation with module grouping and current page highlight
    - Interactive course roadmap with clickable nodes
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Open http://localhost:4321 in browser

    **Desktop verification (window width >= 1024px):**
    - [ ] Sidebar visible on left with course navigation
    - [ ] No hamburger menu visible in header
    - [ ] Navigation shows module grouping
    - [ ] Course roadmap visible with connected nodes
    - [ ] Click a roadmap node -> navigates to lesson
    - [ ] Current page highlighted in sidebar

    **Mobile verification (resize to < 1024px or use devtools):**
    - [ ] Sidebar hidden initially
    - [ ] Hamburger menu visible in header
    - [ ] Click hamburger -> sidebar slides in from left
    - [ ] Dark overlay visible behind sidebar
    - [ ] Click overlay -> sidebar closes
    - [ ] Click navigation link -> navigates AND sidebar closes

    **Roadmap interaction:**
    - [ ] Nodes are clickable (cursor changes to pointer)
    - [ ] Clicking node navigates to correct lesson page
    - [ ] Roadmap has dark theme matching site
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 complete when:
1. All automated tasks pass their verify checks
2. Human verification checkpoint approved
3. `npm run build` succeeds
4. All 4 success criteria from ROADMAP.md verified
</verification>

<success_criteria>
**From ROADMAP.md Phase 2:**
1. Students see an interactive visual roadmap displaying all course modules
2. Students can click roadmap elements to navigate to specific topics
3. Students see a sidebar menu with clear module and topic organization
4. Navigation adapts to screen size (hamburger menu on mobile, sidebar on desktop)
</success_criteria>

<output>
After completion, create `.planning/phases/02-navigation-roadmap/02-04-SUMMARY.md`
</output>
