---
phase: 12-mysql-infrastructure-binlog-fundamentals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - labs/docker-compose.yml
  - labs/.env
autonomous: true

must_haves:
  truths:
    - "MySQL 8.0.40 container starts successfully with docker compose up"
    - "Binlog is enabled with ROW format (SHOW VARIABLES LIKE 'binlog_format' returns ROW)"
    - "GTID mode is active (SHOW VARIABLES LIKE 'gtid_mode' returns ON)"
    - "Binlog retention is configured (SHOW VARIABLES LIKE 'binlog_expire_logs_seconds' returns 604800)"
    - "MySQL is accessible on port 3307 from host"
  artifacts:
    - path: "labs/docker-compose.yml"
      provides: "MySQL service configuration"
      contains: "mysql:"
    - path: "labs/.env"
      provides: "MySQL environment variables"
      contains: "MYSQL_VERSION=8.0.40"
  key_links:
    - from: "labs/docker-compose.yml"
      to: "labs/.env"
      via: "environment variable interpolation"
      pattern: "\\$\\{MYSQL_"
---

<objective>
Add MySQL 8.0.40 Docker service to the existing lab infrastructure with binlog configured for CDC.

Purpose: Learners need a working MySQL environment with proper binlog configuration to practice MySQL CDC in subsequent lessons. This is the foundational infrastructure for Module 8.

Output: Updated docker-compose.yml with mysql service, updated .env with MySQL variables.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-mysql-infrastructure-binlog-fundamentals/12-RESEARCH.md
@labs/docker-compose.yml
@labs/.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MySQL service to docker-compose.yml and update .env</name>
  <files>
    labs/docker-compose.yml
    labs/.env
  </files>
  <action>
Update labs/.env to add MySQL variables at the end:
```
# MySQL
MYSQL_VERSION=8.0.40
MYSQL_PORT=3307
MYSQL_ROOT_PASSWORD=mysql
MYSQL_USER=mysqluser
MYSQL_PASSWORD=mysqlpw
MYSQL_DATABASE=inventory
```

Update labs/docker-compose.yml to add mysql service after postgres service:
```yaml
  mysql:
    image: mysql:${MYSQL_VERSION}
    container_name: mysql
    ports:
      - "${MYSQL_PORT}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    command:
      - "mysqld"
      - "--server-id=1"
      - "--log-bin=mysql-bin"
      - "--binlog-format=ROW"
      - "--binlog-row-image=FULL"
      - "--gtid-mode=ON"
      - "--enforce-gtid-consistency=ON"
      - "--binlog-expire-logs-seconds=604800"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - mysql-data:/var/lib/mysql
```

Add mysql-data to volumes section at the bottom:
```yaml
volumes:
  postgres-data:
  kafka-data:
  prometheus-data:
  grafana-data:
  mysql-data:
```

Important configuration notes:
- Use port 3307 externally (3306 may conflict with local MySQL)
- Use inline command configuration (NOT my.cnf volume mount - avoids MySQL Bug #78957)
- binlog-row-image=FULL for educational clarity (shows complete before/after)
- enforce-gtid-consistency=ON must accompany gtid-mode=ON
- binlog-expire-logs-seconds=604800 = 7 days retention
- server-id=1 required for binlog
- Healthcheck uses $$ to escape $ in YAML for the password variable
  </action>
  <verify>
Run: `cd "/Users/levoely/debezium course/labs" && docker compose config --services | grep mysql`
Expected output includes "mysql"

Run: `grep "MYSQL_VERSION=8.0.40" "/Users/levoely/debezium course/labs/.env"`
Should return the line
  </verify>
  <done>
docker-compose.yml contains mysql service with all binlog configuration options.
.env contains all MySQL environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify MySQL starts with correct binlog configuration</name>
  <files>
    (no file modifications - verification only)
  </files>
  <action>
Start the MySQL container and verify all binlog settings are correct.

1. Start only MySQL service (not full stack to save time):
```bash
cd "/Users/levoely/debezium course/labs"
docker compose up -d mysql
```

2. Wait for healthy status:
```bash
docker compose ps mysql
```
Should show "healthy" status (may take 10-20 seconds due to start_period)

3. Verify binlog configuration:
```bash
docker compose exec mysql mysql -u root -pmysql -e "
SHOW VARIABLES LIKE 'binlog_format';
SHOW VARIABLES LIKE 'binlog_row_image';
SHOW VARIABLES LIKE 'gtid_mode';
SHOW VARIABLES LIKE 'enforce_gtid_consistency';
SHOW VARIABLES LIKE 'binlog_expire_logs_seconds';
SHOW VARIABLES LIKE 'server_id';
SHOW BINARY LOGS;
"
```

Expected output:
- binlog_format = ROW
- binlog_row_image = FULL
- gtid_mode = ON
- enforce_gtid_consistency = ON
- binlog_expire_logs_seconds = 604800
- server_id = 1
- At least one binary log file (mysql-bin.000001)

4. Verify external connectivity:
```bash
mysql -h 127.0.0.1 -P 3307 -u root -pmysql -e "SELECT VERSION();"
```
Should return MySQL version 8.0.40

5. Stop MySQL to clean up:
```bash
docker compose down mysql
```
  </action>
  <verify>
All SHOW VARIABLES queries return expected values.
External connection via port 3307 works.
Binary log file exists.
  </verify>
  <done>
MySQL 8.0.40 container starts with ROW binlog format, GTID mode ON, and 7-day retention configured. Container is accessible from host on port 3307.
  </done>
</task>

</tasks>

<verification>
1. `docker compose config --services` includes mysql
2. MySQL container reaches healthy state
3. `SHOW VARIABLES LIKE 'binlog_format'` returns ROW
4. `SHOW VARIABLES LIKE 'gtid_mode'` returns ON
5. `SHOW BINARY LOGS` shows at least one log file
6. External connection on port 3307 succeeds
</verification>

<success_criteria>
- MySQL 8.0.40 Docker service is added to labs/docker-compose.yml
- All MySQL environment variables are in labs/.env
- Container starts successfully with healthcheck passing
- Binlog is ROW format with GTID mode enabled
- MySQL is accessible on host port 3307
</success_criteria>

<output>
After completion, create `.planning/phases/12-mysql-infrastructure-binlog-fundamentals/12-01-SUMMARY.md`
</output>
