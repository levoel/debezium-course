---
phase: 36-finalization-testing-mermaid-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/diagrams.spec.ts
  - tests/e2e/accessibility.spec.ts
autonomous: true

must_haves:
  truths:
    - "Diagram smoke tests verify all 8 modules render without console errors"
    - "Keyboard navigation test confirms tooltips open via Tab + Enter"
    - "axe-core accessibility audit passes for diagram-containing pages"
  artifacts:
    - path: "tests/e2e/diagrams.spec.ts"
      provides: "Smoke tests for diagram rendering across all modules"
      exports: ["describe('Glass diagram rendering')"]
    - path: "tests/e2e/accessibility.spec.ts"
      provides: "Extended accessibility tests for diagram keyboard navigation"
      contains: "FlowNode tooltips accessible via keyboard"
  key_links:
    - from: "tests/e2e/diagrams.spec.ts"
      to: "tests/fixtures/error-tracking.ts"
      via: "import { test, expect }"
      pattern: "import.*from.*fixtures/error-tracking"
    - from: "tests/e2e/accessibility.spec.ts"
      to: "@axe-core/playwright"
      via: "AxeBuilder import"
      pattern: "import AxeBuilder from '@axe-core/playwright'"
---

<objective>
Create diagram smoke tests and extend accessibility tests for keyboard navigation verification.

Purpose: Verify all 170 glass diagrams render correctly and meet WCAG accessibility standards for keyboard navigation before removing Mermaid dependency.

Output: Two test files (diagrams.spec.ts, extended accessibility.spec.ts) that pass when run against production build.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-finalization/36-RESEARCH.md

Existing test infrastructure:
@tests/fixtures/error-tracking.ts
@tests/e2e/accessibility.spec.ts
@tests/e2e/navigation.spec.ts

Diagram primitives (for understanding structure):
@src/components/diagrams/primitives/DiagramContainer.tsx
@src/components/diagrams/primitives/FlowNode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diagram smoke tests</name>
  <files>tests/e2e/diagrams.spec.ts</files>
  <action>
Create new test file `tests/e2e/diagrams.spec.ts` with:

1. Import from error-tracking fixture (catches console errors automatically)
2. Define sample lessons array (one lesson per module with expected diagram count):
   - Module 1: /course/01-module-1/01-cdc-fundamentals (2+ diagrams)
   - Module 2: /course/02-module-2/01-logical-decoding-deep-dive (4+ diagrams)
   - Module 3: /course/03-module-3/01-binlog-architecture (4+ diagrams)
   - Module 4: /course/04-module-4/01-jmx-metrics-interpretation (4+ diagrams)
   - Module 5: /course/05-module-5/01-smt-overview (5+ diagrams)
   - Module 6: /course/06-module-6/01-advanced-python-consumer (2+ diagrams)
   - Module 7: /course/07-module-7/01-cloud-sql-setup (1+ diagrams)
   - Module 8: /course/08-module-8/01-capstone-overview (1+ diagrams)

3. Test suite "Glass diagram rendering":
   - Loop through sample lessons
   - For each: goto page, waitForLoadState('networkidle')
   - Count diagram containers using `figure[role="figure"]` selector (DiagramContainer uses semantic figure element)
   - Assert count >= expected (error-tracking fixture catches JS errors automatically)

4. Use BASE constant `/debezium-course` for all URLs

Pattern from RESEARCH.md:
```typescript
import { test, expect } from '../fixtures/error-tracking';

const BASE = '/debezium-course';

const sampleLessons = [
  { module: 1, path: '/course/01-module-1/01-cdc-fundamentals', minDiagrams: 2 },
  // ... other modules
];

test.describe('Glass diagram rendering', () => {
  for (const lesson of sampleLessons) {
    test(`Module ${lesson.module} diagrams render without errors`, async ({ page }) => {
      await page.goto(`${BASE}${lesson.path}`);
      await page.waitForLoadState('networkidle');

      const diagrams = await page.locator('figure[role="figure"]').count();
      expect(diagrams).toBeGreaterThanOrEqual(lesson.minDiagrams);
    });
  }
});
```
  </action>
  <verify>File exists at tests/e2e/diagrams.spec.ts with 8 test cases (one per module)</verify>
  <done>Diagram smoke test file created with tests for all 8 modules</done>
</task>

<task type="auto">
  <name>Task 2: Extend accessibility tests for diagram keyboard navigation</name>
  <files>tests/e2e/accessibility.spec.ts</files>
  <action>
Add new test section to existing `tests/e2e/accessibility.spec.ts`:

1. Add new describe block "Diagram keyboard accessibility" at the end of file
2. Test "FlowNode tooltips accessible via keyboard":
   - Navigate to a diagram-heavy page (01-cdc-fundamentals)
   - waitForLoadState('networkidle')
   - Find first interactive element with role="button" (FlowNode uses button role for tooltips)
   - Focus it and press Enter
   - Verify tooltip appears using `[data-radix-popper-content-wrapper]` selector (Radix Tooltip/Popover wrapper)
   - Press Escape to close tooltip
   - Verify tooltip is hidden

3. Test "diagram containers meet axe-core accessibility":
   - Navigate to lesson with diagrams
   - Run axe-core audit scoped to figure[role="figure"] elements
   - Exclude code blocks (already excluded in other tests)
   - Assert no violations

Pattern:
```typescript
test.describe('Diagram keyboard accessibility', () => {
  test('FlowNode tooltips accessible via keyboard', async ({ page }) => {
    await page.goto(`${BASE}/course/01-module-1/01-cdc-fundamentals`);
    await page.waitForLoadState('networkidle');

    // Find first interactive diagram node (FlowNode with tooltip)
    const firstNode = page.locator('[role="button"]').first();
    await firstNode.focus();
    await page.keyboard.press('Enter');

    // Radix Popover creates this wrapper when open
    await expect(page.locator('[data-radix-popper-content-wrapper]')).toBeVisible();

    // Close with Escape
    await page.keyboard.press('Escape');
    await expect(page.locator('[data-radix-popper-content-wrapper]')).toBeHidden();
  });

  test('diagram containers meet axe-core accessibility', async ({ page }) => {
    await page.goto(`${BASE}/course/01-module-1/02-debezium-architecture`);
    await page.waitForLoadState('networkidle');

    const results = await new AxeBuilder({ page })
      .include('figure[role="figure"]')
      .withTags(['wcag2aa'])
      .analyze();

    if (results.violations.length > 0) {
      console.log('Diagram accessibility violations:', JSON.stringify(results.violations, null, 2));
    }

    expect(results.violations).toEqual([]);
  });
});
```
  </action>
  <verify>accessibility.spec.ts contains "Diagram keyboard accessibility" describe block with 2 tests</verify>
  <done>Accessibility tests extended with keyboard navigation and axe-core audit for diagrams</done>
</task>

<task type="auto">
  <name>Task 3: Run smoke and accessibility tests</name>
  <files></files>
  <action>
Execute the test suite to verify all tests pass:

1. Run full E2E test suite: `npm run test:e2e`
2. If any tests fail:
   - Check console output for error details
   - Fix issues in test files (selector adjustments, timing issues)
   - Re-run until all pass

Expected outcome:
- All 8 diagram smoke tests pass (one per module)
- Both new accessibility tests pass (keyboard nav, axe-core audit)
- Existing accessibility tests still pass

Note: The error-tracking fixture will catch any JavaScript errors or console errors in the diagrams, making these smoke tests effective at catching rendering issues.
  </action>
  <verify>`npm run test:e2e` completes with all tests passing (0 failures)</verify>
  <done>All smoke tests and accessibility tests pass</done>
</task>

</tasks>

<verification>
1. File `tests/e2e/diagrams.spec.ts` exists with 8 module tests
2. File `tests/e2e/accessibility.spec.ts` contains "Diagram keyboard accessibility" section
3. `npm run test:e2e` passes with 0 failures
4. No console errors detected during diagram rendering (verified by error-tracking fixture)
</verification>

<success_criteria>
- Diagram smoke tests verify all 8 modules render without JavaScript errors
- Keyboard accessibility test confirms Tab + Enter opens tooltips
- axe-core audit passes for diagram containers
- All tests pass in CI-compatible headless mode
</success_criteria>

<output>
After completion, create `.planning/phases/36-finalization-testing-mermaid-removal/36-01-SUMMARY.md`
</output>
