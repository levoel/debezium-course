---
phase: 25-polish-mobile-accessibility-verification
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - package.json
  - tests/e2e/accessibility.spec.ts
autonomous: true

must_haves:
  truths:
    - "Accessibility tests run automatically with npm test:e2e"
    - "Homepage passes WCAG 2.1 AA automated checks"
    - "Lesson pages pass WCAG 2.1 AA automated checks"
    - "Glass components have no color-contrast violations"
    - "prefers-reduced-motion disables glass transitions"
  artifacts:
    - path: "tests/e2e/accessibility.spec.ts"
      provides: "Automated WCAG compliance tests using axe-core"
      min_lines: 50
    - path: "package.json"
      provides: "@axe-core/playwright dependency"
      contains: "@axe-core/playwright"
  key_links:
    - from: "tests/e2e/accessibility.spec.ts"
      to: "@axe-core/playwright"
      via: "import AxeBuilder"
      pattern: "import AxeBuilder from '@axe-core/playwright'"
    - from: "tests/e2e/accessibility.spec.ts"
      to: "glass components"
      via: ".include('.glass-card')"
      pattern: "\\.include\\(['\"]\\."
---

<objective>
Add automated accessibility testing with @axe-core/playwright to verify WCAG 2.1 AA compliance.

Purpose: Automated accessibility testing catches ~57% of WCAG violations automatically, including color-contrast issues, missing ARIA labels, semantic HTML problems, and keyboard navigation issues. This provides ongoing regression protection for accessibility.

Output: Accessibility test suite that runs with existing Playwright tests, verifying homepage, lesson pages, and glass components meet WCAG 2.1 AA standards.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-polish-mobile-accessibility-verification/25-RESEARCH.md

# Existing test patterns
@tests/e2e/navigation.spec.ts
@playwright.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @axe-core/playwright dependency</name>
  <files>package.json</files>
  <action>
Install @axe-core/playwright as a dev dependency:

```bash
npm install -D @axe-core/playwright
```

This adds the official Playwright integration for axe-core accessibility testing engine.

After installation, verify package.json includes the dependency:
```json
"devDependencies": {
  "@axe-core/playwright": "^4.x.x",
  "@playwright/test": "^1.58.1"
}
```
  </action>
  <verify>
```bash
grep "@axe-core/playwright" package.json
```
Should show the dependency is listed in devDependencies.
  </verify>
  <done>@axe-core/playwright is installed and listed in package.json devDependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create accessibility test suite</name>
  <files>tests/e2e/accessibility.spec.ts</files>
  <action>
Create a new accessibility test file at `tests/e2e/accessibility.spec.ts` with the following tests:

```typescript
import { test, expect } from '../fixtures/error-tracking';
import AxeBuilder from '@axe-core/playwright';

// Base path for the course (matches astro.config.mjs base setting)
const BASE = '/debezium-course';

test.describe('Accessibility compliance (WCAG 2.1 AA)', () => {
  test('homepage meets WCAG AA standards', async ({ page }) => {
    await page.goto(`${BASE}/`);

    // Wait for client-side hydration to complete
    await page.waitForLoadState('networkidle');

    const results = await new AxeBuilder({ page })
      .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
      .analyze();

    // Log violations for debugging if any exist
    if (results.violations.length > 0) {
      console.log('Accessibility violations:', JSON.stringify(results.violations, null, 2));
    }

    expect(results.violations).toEqual([]);
  });

  test('lesson page with glass sidebar meets WCAG AA', async ({ page }) => {
    await page.goto(`${BASE}/course/01-module-1/01-cdc-fundamentals`);

    await page.waitForLoadState('networkidle');

    const results = await new AxeBuilder({ page })
      .withTags(['wcag2aa'])
      .analyze();

    if (results.violations.length > 0) {
      console.log('Lesson page violations:', JSON.stringify(results.violations, null, 2));
    }

    expect(results.violations).toEqual([]);
  });

  test('glass card components have sufficient contrast', async ({ page }) => {
    await page.goto(`${BASE}/`);

    await page.waitForLoadState('networkidle');

    // Check if glass-card elements exist before testing
    const glassCards = await page.locator('.glass-card').count();

    if (glassCards > 0) {
      // Focus on color-contrast rule specifically for glass components
      const results = await new AxeBuilder({ page })
        .include('.glass-card')
        .withTags(['wcag2aa'])
        .analyze();

      // Check specifically for contrast violations
      const contrastViolations = results.violations.filter(
        v => v.id === 'color-contrast'
      );

      if (contrastViolations.length > 0) {
        console.log('Contrast violations in glass-card:', JSON.stringify(contrastViolations, null, 2));
      }

      expect(contrastViolations).toEqual([]);
    }
  });

  test('page with tables meets WCAG AA', async ({ page }) => {
    // Visit a lesson that likely has tables (production operations has monitoring tables)
    await page.goto(`${BASE}/course/04-module-4/01-jmx-metrics-interpretation`);

    await page.waitForLoadState('networkidle');

    const results = await new AxeBuilder({ page })
      .withTags(['wcag2aa'])
      .analyze();

    if (results.violations.length > 0) {
      console.log('Table page violations:', JSON.stringify(results.violations, null, 2));
    }

    expect(results.violations).toEqual([]);
  });
});

test.describe('Accessibility preferences respected', () => {
  test('prefers-reduced-motion disables transitions', async ({ page }) => {
    // Emulate reduced motion preference
    await page.emulateMedia({ reducedMotion: 'reduce' });

    await page.goto(`${BASE}/`);
    await page.waitForLoadState('networkidle');

    // Check that glass cards have no transition (or very short)
    const glassCard = page.locator('.glass-card').first();

    if (await glassCard.count() > 0) {
      const transition = await glassCard.evaluate(el =>
        window.getComputedStyle(el).transition
      );

      // Should be 'none' or 'all 0s ease 0s' (no animation)
      // Accept various browser representations of "no transition"
      const hasNoTransition =
        transition === 'none' ||
        transition.includes('0s') ||
        transition === 'all';

      expect(hasNoTransition).toBe(true);
    }
  });

  test('glass panel respects reduced motion', async ({ page }) => {
    await page.emulateMedia({ reducedMotion: 'reduce' });

    await page.goto(`${BASE}/course/01-module-1/01-cdc-fundamentals`);
    await page.waitForLoadState('networkidle');

    // Check progress panel or any glass-panel element
    const glassPanel = page.locator('.glass-panel').first();

    if (await glassPanel.count() > 0) {
      const transition = await glassPanel.evaluate(el =>
        window.getComputedStyle(el).transition
      );

      const hasNoTransition =
        transition === 'none' ||
        transition.includes('0s');

      expect(hasNoTransition).toBe(true);
    }
  });
});
```

Key features:
- Uses existing error-tracking fixture for consistency with other tests
- Tests homepage, lesson pages, and pages with tables
- Specifically tests glass-card contrast
- Verifies prefers-reduced-motion is respected
- Logs violations for debugging
- Uses networkidle to wait for hydration
  </action>
  <verify>
```bash
# Check file exists and has expected content
wc -l tests/e2e/accessibility.spec.ts
grep "AxeBuilder" tests/e2e/accessibility.spec.ts
grep "wcag2aa" tests/e2e/accessibility.spec.ts
```
File should be 100+ lines and contain AxeBuilder and wcag2aa references.
  </verify>
  <done>Accessibility test suite created with WCAG 2.1 AA compliance tests for homepage, lesson pages, and glass components.</done>
</task>

<task type="auto">
  <name>Task 3: Run accessibility tests and verify pass</name>
  <files>tests/e2e/accessibility.spec.ts</files>
  <action>
Run the full E2E test suite including the new accessibility tests:

```bash
npm run test:e2e
```

This will:
1. Build the site (clean build via rm -rf .astro/)
2. Start preview server
3. Run all Playwright tests including accessibility.spec.ts

Expected: All tests pass, including:
- navigation.spec.ts (existing)
- progress.spec.ts (existing)
- accessibility.spec.ts (new)

If any accessibility violations are found, they will be logged to the console. Common fixes:
- Missing alt text on images
- Insufficient color contrast
- Missing form labels
- Improper heading hierarchy

If violations exist, assess whether they are pre-existing issues or new regressions. Document any pre-existing issues for future fix but don't block on them if they're not related to glass design.
  </action>
  <verify>
```bash
npm run test:e2e
```
Exit code 0, all tests pass.
  </verify>
  <done>Accessibility tests run successfully. Any violations are logged and either fixed or documented as pre-existing issues.</done>
</task>

</tasks>

<verification>
1. Dependency verification:
   - `npm ls @axe-core/playwright` shows package installed
   - Version is 4.x or higher

2. Test file verification:
   - `tests/e2e/accessibility.spec.ts` exists
   - Contains AxeBuilder import
   - Has WCAG 2.1 AA tag tests
   - Has glass-specific contrast tests
   - Has prefers-reduced-motion tests

3. Test execution:
   - `npm run test:e2e` passes
   - Accessibility tests are included in test run
   - No WCAG 2.1 AA violations (or pre-existing issues documented)
</verification>

<success_criteria>
1. @axe-core/playwright installed in devDependencies
2. accessibility.spec.ts exists with 6+ test cases covering:
   - Homepage WCAG AA compliance
   - Lesson page WCAG AA compliance
   - Glass card contrast verification
   - Table page WCAG AA compliance
   - prefers-reduced-motion on glass-card
   - prefers-reduced-motion on glass-panel
3. All new accessibility tests pass
4. Test output shows accessibility tests in the run
</success_criteria>

<output>
After completion, create `.planning/phases/25-polish-mobile-accessibility-verification/25-02-SUMMARY.md`
</output>
