---
phase: 03-progress-tracking
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/LessonCompleteButton.tsx
  - src/components/ProgressIndicator.tsx
  - src/components/ProgressExport.tsx
autonomous: true

must_haves:
  truths:
    - "LessonCompleteButton renders a toggle button that changes state on click"
    - "ProgressIndicator shows percentage and progress bar"
    - "ProgressExport allows downloading progress as JSON file"
    - "ProgressExport allows importing progress from JSON file"
  artifacts:
    - path: "src/components/LessonCompleteButton.tsx"
      provides: "Toggle button for marking lessons complete"
      exports: ["LessonCompleteButton"]
    - path: "src/components/ProgressIndicator.tsx"
      provides: "Progress bar and percentage display"
      exports: ["ProgressIndicator"]
    - path: "src/components/ProgressExport.tsx"
      provides: "Export/import progress data UI"
      exports: ["ProgressExport"]
  key_links:
    - from: "src/components/LessonCompleteButton.tsx"
      to: "src/stores/progress.ts"
      via: "useStore and toggleLessonComplete"
      pattern: "useStore.*\\$progress"
    - from: "src/components/ProgressIndicator.tsx"
      to: "src/stores/progress.ts"
      via: "useStore for reactive updates"
      pattern: "useStore.*\\$progress"
    - from: "src/components/ProgressExport.tsx"
      to: "src/stores/progress.ts"
      via: "$progress.get() and $progress.set()"
      pattern: "\\$progress\\.(get|set)"
---

<objective>
Create new React components for progress tracking UI.

Purpose: Provide user-facing controls for viewing and managing progress - button to mark complete, progress bar, export/import.
Output: Three new React components ready for integration into pages.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-progress-tracking/03-RESEARCH.md

# Progress store (created in 03-01)
@src/stores/progress.ts

# Existing component patterns
@src/components/Navigation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LessonCompleteButton component</name>
  <files>src/components/LessonCompleteButton.tsx</files>
  <action>
Create src/components/LessonCompleteButton.tsx:

```typescript
import { useStore } from '@nanostores/react';
import { $progress, toggleLessonComplete } from '../stores/progress';

interface LessonCompleteButtonProps {
  /** Lesson slug for tracking completion */
  slug: string;
}

/**
 * Toggle button for marking a lesson as complete/incomplete.
 * Uses nanostores for reactive state updates across islands.
 */
export function LessonCompleteButton({ slug }: LessonCompleteButtonProps) {
  const progress = useStore($progress);
  const isComplete = progress.completed.includes(slug);

  return (
    <button
      onClick={() => toggleLessonComplete(slug)}
      className={`
        flex items-center gap-2 px-4 py-2 rounded-lg font-medium
        transition-colors duration-200
        ${isComplete
          ? 'bg-green-600 hover:bg-green-700 text-white'
          : 'bg-gray-700 hover:bg-gray-600 text-gray-200'
        }
      `}
      aria-pressed={isComplete}
    >
      {isComplete ? (
        <>
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
          <span>Урок пройден</span>
        </>
      ) : (
        <>
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Отметить как пройденный</span>
        </>
      )}
    </button>
  );
}

export default LessonCompleteButton;
```

Key decisions:
- Use useStore for reactive updates (button re-renders when progress changes)
- Toggle pattern (single button, not separate mark/unmark buttons)
- Green color for complete, gray for incomplete (consistent with roadmap)
- aria-pressed for accessibility
- Russian text ("Урок пройден" / "Отметить как пройденный")
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check file exists and exports LessonCompleteButton.
  </verify>
  <done>LessonCompleteButton.tsx exists with toggle functionality and proper styling.</done>
</task>

<task type="auto">
  <name>Task 2: Create ProgressIndicator component</name>
  <files>src/components/ProgressIndicator.tsx</files>
  <action>
Create src/components/ProgressIndicator.tsx:

```typescript
import { useStore } from '@nanostores/react';
import { useEffect, useState } from 'react';
import { $progress } from '../stores/progress';

interface ProgressIndicatorProps {
  /** Total number of lessons in course */
  totalLessons: number;
}

/**
 * Progress bar showing course completion percentage.
 * SSR-safe: renders placeholder until client hydration.
 */
export function ProgressIndicator({ totalLessons }: ProgressIndicatorProps) {
  const progress = useStore($progress);
  const [mounted, setMounted] = useState(false);

  // SSR-safe: only calculate percentage on client
  useEffect(() => {
    setMounted(true);
  }, []);

  // Placeholder for SSR
  if (!mounted) {
    return (
      <div className="w-full">
        <div className="flex justify-between mb-2">
          <span className="text-sm text-gray-400">Прогресс курса</span>
          <span className="text-sm text-gray-400">—%</span>
        </div>
        <div className="w-full bg-gray-700 rounded-full h-2.5">
          <div className="bg-gray-600 h-2.5 rounded-full w-0" />
        </div>
      </div>
    );
  }

  const completedCount = progress.completed.length;
  const percentage = totalLessons > 0
    ? Math.round((completedCount / totalLessons) * 100)
    : 0;

  return (
    <div className="w-full">
      <div className="flex justify-between mb-2">
        <span className="text-sm text-gray-400">Прогресс курса</span>
        <span className="text-sm text-gray-300 font-medium">{percentage}%</span>
      </div>
      <div className="w-full bg-gray-700 rounded-full h-2.5">
        <div
          className="bg-blue-500 h-2.5 rounded-full transition-all duration-500"
          style={{ width: `${percentage}%` }}
        />
      </div>
      <p className="text-xs text-gray-500 mt-2">
        {completedCount} из {totalLessons} уроков пройдено
      </p>
    </div>
  );
}

export default ProgressIndicator;
```

Key decisions:
- SSR-safe with mounted state check (prevents hydration mismatch)
- Placeholder during SSR shows structure without values
- Blue progress bar matching site theme
- Transition animation for smooth progress updates
- Russian text for labels
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check file exists and exports ProgressIndicator.
  </verify>
  <done>ProgressIndicator.tsx exists with SSR-safe rendering and progress bar.</done>
</task>

<task type="auto">
  <name>Task 3: Create ProgressExport component</name>
  <files>src/components/ProgressExport.tsx</files>
  <action>
Create src/components/ProgressExport.tsx:

```typescript
import { useRef, useState } from 'react';
import { $progress } from '../stores/progress';

/**
 * Export/import progress data for backup and cross-device sync.
 * Uses Blob download for export, FileReader for import.
 */
export function ProgressExport() {
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [importStatus, setImportStatus] = useState<'idle' | 'success' | 'error'>('idle');

  const handleExport = () => {
    const data = $progress.get();
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `debezium-course-progress-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    URL.revokeObjectURL(url);
  };

  const handleImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      // Validate structure
      if (!Array.isArray(data.completed)) {
        throw new Error('Invalid progress format: completed must be an array');
      }

      // Validate all items are strings
      if (!data.completed.every((item: unknown) => typeof item === 'string')) {
        throw new Error('Invalid progress format: completed items must be strings');
      }

      $progress.set({
        completed: data.completed,
        lastUpdated: Date.now(),
      });

      setImportStatus('success');
      setTimeout(() => setImportStatus('idle'), 3000);
    } catch (error) {
      console.error('Import error:', error);
      setImportStatus('error');
      setTimeout(() => setImportStatus('idle'), 3000);
    }

    // Reset input for re-import of same file
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  return (
    <div className="space-y-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
      <h3 className="text-sm font-semibold text-gray-300">Резервное копирование прогресса</h3>

      <div className="flex flex-wrap gap-3">
        <button
          onClick={handleExport}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          <span>Экспорт</span>
        </button>

        <div>
          <input
            ref={fileInputRef}
            type="file"
            accept=".json"
            onChange={handleImport}
            className="hidden"
            id="progress-import"
          />
          <label
            htmlFor="progress-import"
            className="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg text-sm cursor-pointer transition-colors"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            <span>Импорт</span>
          </label>
        </div>
      </div>

      {/* Status messages */}
      {importStatus === 'success' && (
        <p className="text-sm text-green-400 flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
          Прогресс успешно импортирован
        </p>
      )}
      {importStatus === 'error' && (
        <p className="text-sm text-red-400 flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
          Ошибка импорта. Проверьте формат файла.
        </p>
      )}

      <p className="text-xs text-gray-500">
        Экспортируйте прогресс для резервного копирования или переноса на другое устройство.
      </p>
    </div>
  );
}

export default ProgressExport;
```

Key decisions:
- Blob + createObjectURL for export (zero dependencies)
- FileReader.text() for import (modern async API)
- Validation before setting progress (array check, string items check)
- Status feedback with auto-dismiss after 3 seconds
- Russian UI text
- File naming with date for easy identification
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check file exists and exports ProgressExport.
  </verify>
  <done>ProgressExport.tsx exists with export/import functionality and validation.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. All three component files exist:
   - src/components/LessonCompleteButton.tsx
   - src/components/ProgressIndicator.tsx
   - src/components/ProgressExport.tsx
3. Each component properly imports from stores/progress.ts
</verification>

<success_criteria>
- LessonCompleteButton renders toggle button with complete/incomplete states
- ProgressIndicator shows progress bar and percentage (SSR-safe)
- ProgressExport provides download and upload functionality
- All components compile without TypeScript errors
- All components use nanostores for state (not local useState for persistent data)
</success_criteria>

<output>
After completion, create `.planning/phases/03-progress-tracking/03-02-SUMMARY.md`
</output>
