---
phase: 29-module-2-diagram-migration
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/components/diagrams/module2/AuroraFailoverDiagrams.tsx
  - src/components/diagrams/module2/SnapshotStrategyDiagrams.tsx
  - src/components/diagrams/module2/IncrementalSnapshotDiagrams.tsx
  - src/components/diagrams/module2/index.ts
  - src/content/course/02-module-2/01-logical-decoding-deep-dive.mdx
  - src/content/course/02-module-2/02-replication-slots-lifecycle.mdx
  - src/content/course/02-module-2/03-wal-configuration-tuning.mdx
  - src/content/course/02-module-2/04-aurora-parameter-groups.mdx
  - src/content/course/02-module-2/05-aurora-failover-handling.mdx
  - src/content/course/02-module-2/06-snapshot-strategies.mdx
  - src/content/course/02-module-2/07-incremental-snapshot-lab.mdx
autonomous: true

must_haves:
  truths:
    - "User can view Aurora failover sequence diagram in lesson 05"
    - "User can view heartbeat monitoring architecture diagram in lesson 05"
    - "User can view Aurora Global Database strategy diagram in lesson 05"
    - "User can view snapshot data loss diagram in lesson 06"
    - "User can view traditional snapshot blocking sequence diagram in lesson 06"
    - "User can view incremental snapshot parallel sequence diagram in lesson 06"
    - "User can view snapshot decision framework diagram in lesson 06"
    - "User can view incremental snapshot lab architecture diagram in lesson 07"
    - "User can view lab completion summary diagram in lesson 07"
    - "User can click any node in any Module 2 diagram to see tooltip"
    - "No Mermaid import statements exist in Module 2 MDX files"
    - "No <Mermaid chart={...}> blocks exist in Module 2 MDX files"
    - "Module 2 lessons render correctly at localhost:4321/course/02-module-2/*"
  artifacts:
    - path: "src/components/diagrams/module2/AuroraFailoverDiagrams.tsx"
      provides: "Aurora failover diagrams (sequence, heartbeat, global database)"
      exports: ["AuroraFailoverSequenceDiagram", "HeartbeatMonitoringDiagram", "AuroraGlobalDatabaseDiagram"]
    - path: "src/components/diagrams/module2/SnapshotStrategyDiagrams.tsx"
      provides: "Snapshot strategy diagrams (data loss, blocking, parallel, decision)"
      exports: ["SnapshotDataLossDiagram", "TraditionalSnapshotDiagram", "IncrementalSnapshotDiagram", "SnapshotDecisionDiagram"]
    - path: "src/components/diagrams/module2/IncrementalSnapshotDiagrams.tsx"
      provides: "Lab architecture diagrams"
      exports: ["IncrementalSnapshotLabDiagram", "LabCompletionDiagram"]
    - path: "src/content/course/02-module-2/*.mdx"
      provides: "Updated MDX files using glass components"
      contains: "from '../../../../components/diagrams/module2'"
  key_links:
    - from: "src/content/course/02-module-2/*.mdx"
      to: "src/components/diagrams/module2"
      via: "import statement"
      pattern: "import.*from.*diagrams/module2"
    - from: "src/content/course/02-module-2/*.mdx"
      to: "Mermaid component"
      via: "removal verification"
      pattern: "Mermaid"
---

<objective>
Complete Module 2 diagram migration by creating remaining diagram components (lessons 05-07, 9 diagrams) and updating all 7 MDX files to use the new glass components instead of Mermaid.

Purpose: Finish the migration, remove all Mermaid dependencies from Module 2, and verify the new interactive diagrams render correctly with PostgreSQL/Aurora-specific explanations.

Output: 3 additional component files + updated barrel export + 7 MDX files migrated.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-module-2-diagram-migration/29-CONTEXT.md
@.planning/phases/29-module-2-diagram-migration/29-01-SUMMARY.md
@src/components/diagrams/primitives/types.ts
@src/components/diagrams/primitives/SequenceDiagram.tsx
@src/content/course/02-module-2/05-aurora-failover-handling.mdx
@src/content/course/02-module-2/06-snapshot-strategies.mdx
@src/content/course/02-module-2/07-incremental-snapshot-lab.mdx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create remaining diagram components for lessons 05-07</name>
  <files>
    src/components/diagrams/module2/AuroraFailoverDiagrams.tsx
    src/components/diagrams/module2/SnapshotStrategyDiagrams.tsx
    src/components/diagrams/module2/IncrementalSnapshotDiagrams.tsx
    src/components/diagrams/module2/index.ts
  </files>
  <action>
**1. Create `src/components/diagrams/module2/AuroraFailoverDiagrams.tsx` with three exports:**

**A. AuroraFailoverSequenceDiagram** - Complex sequence showing slot loss during failover
- Use SequenceDiagram with actors: App, Writer, Reader, Slot, Debezium, Kafka
- Show normal operation phase, then CRASH, then failover window (highlighted danger zone), then recovery
- Key messages: INSERT, WAL write, slot read, CRASH, Promotion, "Slot not found", slot recreation
- Danger zone highlighting for data loss window

**Tooltip content:**
- App: "Приложение продолжает записывать данные. INSERT INTO orders (id=100) успешно записан и отправлен в Kafka."
- Writer Instance: "Primary Aurora instance обрабатывает write операции. Внезапно падает между записью WAL и подтверждением Debezium."
- Reader Instance: "Read replica автоматически промотится в новый Writer при обнаружении failover. Занимает 1-2 минуты."
- Replication Slot: "КРИТИЧНО: Slot существовал только на Writer. При failover slot ПОТЕРЯН — PostgreSQL до версии 17 не синхронизирует slots."
- Debezium: "После failover пытается подключиться. Получает 'slot not found'. Пересоздает slot с ТЕКУЩЕЙ позиции — данные между crash и recovery потеряны."
- Kafka: "События до crash доставлены. События в failover window (id=101) ПОТЕРЯНЫ НАВСЕГДА."

**B. HeartbeatMonitoringDiagram** - Heartbeat architecture for gap detection
- DiagramContainer with subgroups: Debezium (heartbeat generator), PostgreSQL (heartbeat table), Kafka (CDC + heartbeat topics), Monitoring (alert system)
- FlowNodes showing data flow: Heartbeat -> UPDATE heartbeat table -> CDC event -> Kafka topics -> Monitor -> Alert
- Color coding: amber for heartbeat, blue for database, emerald for Kafka, rose for alert

**Tooltip content:**
- Heartbeat: "Debezium периодически (каждые 10 сек) выполняет UPDATE heartbeat SET ts=NOW(). Создает 'маркеры времени' в потоке CDC."
- Heartbeat Table: "Специальная таблица public.heartbeat с полями id, ts, writer_instance. Хранит последний heartbeat и ID текущего writer."
- CDC Topic: "Топик inventory.public.orders содержит бизнес-события. Heartbeat события помогают обнаружить gaps."
- Heartbeat Topic: "__debezium-heartbeat.inventory — выделенный топик для heartbeat событий. Используется для мониторинга."
- Alert: "Алерт срабатывает при gap > 30 секунд. Heartbeat не предотвращает потерю данных, но позволяет её обнаружить."

**C. AuroraGlobalDatabaseDiagram** - Multi-region CDC strategy
- Two DiagramContainers representing regions: Primary (us-east-1) and Secondary (eu-west-1)
- Each region has: Writer Instance, Debezium connector, Kafka cluster
- Arrow showing Aurora Replication between Writers
- Arrows showing both Kafka clusters feeding into Consumer Service with cross-region merge

**Tooltip content:**
- Primary Region: "Основной регион us-east-1 с Writer Instance, Debezium #1 и Kafka Cluster #1. Обслуживает основной CDC-поток."
- Secondary Region: "Дополнительный регион eu-west-1 с отдельным Debezium #2 и Kafka Cluster #2. Резервный CDC-поток."
- Aurora Replication: "Aurora автоматически реплицирует данные между регионами с задержкой < 1 секунды. При failover primary — secondary становится новым primary."
- Consumer Service: "Потребитель мержит потоки из обоих регионов. Требуется дедупликация по event ID, так как одно событие может прийти из обоих источников."

**2. Create `src/components/diagrams/module2/SnapshotStrategyDiagrams.tsx` with four exports:**

**A. SnapshotDataLossDiagram** - Simple "without snapshot" data loss visualization
- Two parallel flows:
  - "Существующие данные" -> X (rose, "Потеряны")
  - "Новые изменения" -> Kafka (emerald, "Захватываются")
- Simple flowchart showing the problem snapshot solves

**Tooltip content:**
- Existing Data: "Миллионы записей уже существуют в таблице до запуска CDC. Без snapshot consumer их никогда не увидит."
- Lost Data: "Потеря данных — существующие записи невидимы для CDC. Только операции INSERT/UPDATE/DELETE после запуска коннектора захватываются."
- New Changes: "CDC захватывает только изменения после запуска. INSERT, UPDATE, DELETE попадают в Kafka."
- Kafka: "Топик содержит только новые события. Для полной картины нужен initial snapshot существующих данных."

**B. TraditionalSnapshotDiagram** - Sequence showing streaming blocked during snapshot
- SequenceDiagram with actors: Connector, PostgreSQL, Kafka
- Danger zone (rose highlight) showing "Период блокировки streaming"
- Messages: SELECT * FROM large_table, "10 миллионов строк...", WAL накапливается, op='r' events
- Then green zone: "Streaming возобновляется", WAL reading, op='c/u/d' events

**Tooltip content:**
- Connector (snapshot phase): "Во время traditional snapshot коннектор полностью занят чтением таблицы. SELECT * без WHERE — последовательное чтение миллионов строк."
- PostgreSQL (snapshot): "База выполняет full table scan. WAL продолжает накапливаться, но Debezium не читает его до завершения snapshot."
- Blocking Period: "ПРОБЛЕМА: Streaming заблокирован на время snapshot. Для таблицы 100GB это могут быть часы. WAL retention растет."
- Streaming Resume: "После snapshot коннектор читает накопленный WAL. Может быть большой backlog событий для обработки."

**C. IncrementalSnapshotDiagram** - Sequence showing parallel processing
- SequenceDiagram with actors: Signaling Table, Connector, PostgreSQL, Kafka
- Show parallel operation: snapshot chunks AND streaming events simultaneously
- Messages: execute-snapshot signal, SELECT WHERE id BETWEEN x AND y (loop), publish op='r', AND parallel WAL changes with op='c/u/d'

**Tooltip content:**
- Signaling Table: "Таблица debezium_signal принимает команды. INSERT с type='execute-snapshot' запускает incremental snapshot."
- Connector (incremental): "Коннектор читает таблицу chunk-by-chunk (по 512-4096 строк) по primary key. Между chunks обрабатывает streaming события."
- Chunk Processing: "SELECT * WHERE id BETWEEN 1 AND 512, затем 513-1024, и т.д. Возобновляемо — при crash продолжит с последнего chunk."
- Parallel Events: "Параллельная обработка: snapshot op='r' и streaming op='c/u/d' в одном топике. Consumer различает по source.snapshot поля."

**D. SnapshotDecisionDiagram** - Decision flowchart for choosing strategy
- Flowchart with decision nodes: "Нужен снэпшот?" -> "Размер таблицы" -> choices
- FlowNodes for decisions (diamond-style), outcomes, recommendations
- Color coding: emerald for recommended paths, amber for acceptable, rose for anti-patterns

**Tooltip content:**
- Snapshot Needed: "Первый вопрос: нужны ли существующие данные? Для аналитики с историей — да. Для real-time алертов на новые события — возможно нет."
- Table Size Small: "< 1M строк: Traditional snapshot пройдет за минуты. Простой выбор snapshot.mode=initial."
- Table Size Large: ">= 1M строк: Incremental snapshot обязателен. Минимальный downtime, возобновляемость, параллельный streaming."
- Downtime OK: "Если допустим downtime до 30 минут — можно использовать traditional snapshot даже для средних таблиц."
- snapshot.mode=never: "Используется с incremental snapshot через signaling table. Коннектор сразу начинает streaming."

**3. Create `src/components/diagrams/module2/IncrementalSnapshotDiagrams.tsx` with two exports:**

**A. IncrementalSnapshotLabDiagram** - Lab architecture
- DiagramContainer with 4 subgroups: PostgreSQL (signal table, orders_large), Debezium (Connector), Kafka (topic), Python (Monitor)
- Arrows showing data flow: signal triggers connector, connector reads chunks, publishes to Kafka, Python consumes
- FlowNode variants matching lab tools

**Tooltip content:**
- Signaling Table: "debezium_signal — таблица для управления snapshot. INSERT с execute-snapshot запускает процесс."
- Orders Large: "Тестовая таблица orders_large с 10,000 записями. Демонстрирует chunked чтение."
- Connector: "Коннектор orders-incremental с snapshot.mode=never и signal.data.collection настроенной."
- Kafka Topic: "inventory.public.orders_large — топик с snapshot (op='r') и streaming (op='c/u/d') событиями."
- Python Monitor: "Consumer на Python с confluent-kafka. Считает snapshot события, отслеживает chunk boundaries."

**B. LabCompletionDiagram** - Summary of lab achievements
- Vertical flow showing completed steps as FlowNodes (all emerald):
  1. Signaling Table создана
  2. Orders Large: 10K записей
  3. Коннектор с incremental snapshot
  4. Python Monitor запущен
  5. INSERT execute-snapshot
  6. Наблюдение chunk-by-chunk
  7. Stop/Resume демонстрация
  8. Filtered snapshot

**Tooltip content:**
- Each step: Brief Russian description of what was achieved and why it matters for production CDC

**4. Update `src/components/diagrams/module2/index.ts`:**

Add exports for new components:
```typescript
export * from './LogicalDecodingDiagrams';
export * from './ReplicationSlotsDiagrams';
export * from './WalConfigDiagrams';
export * from './AuroraParameterDiagrams';
export * from './AuroraFailoverDiagrams';
export * from './SnapshotStrategyDiagrams';
export * from './IncrementalSnapshotDiagrams';
```
  </action>
  <verify>
- All 3 new component files exist
- TypeScript compiles without errors: `npx tsc --noEmit`
- Index exports all 19 diagram components for Module 2
  </verify>
  <done>
All 19 Module 2 diagram components created and exported from barrel file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MDX files to use glass components and remove Mermaid</name>
  <files>
    src/content/course/02-module-2/01-logical-decoding-deep-dive.mdx
    src/content/course/02-module-2/02-replication-slots-lifecycle.mdx
    src/content/course/02-module-2/03-wal-configuration-tuning.mdx
    src/content/course/02-module-2/04-aurora-parameter-groups.mdx
    src/content/course/02-module-2/05-aurora-failover-handling.mdx
    src/content/course/02-module-2/06-snapshot-strategies.mdx
    src/content/course/02-module-2/07-incremental-snapshot-lab.mdx
  </files>
  <action>
For each MDX file, perform these changes:

**1. Replace Mermaid import with diagram component imports:**

Remove:
```
import { Mermaid } from '../../../components/Mermaid.tsx';
```

Add appropriate imports from module2 diagrams (note: 4 levels up from course/02-module-2/):
```typescript
// 01-logical-decoding-deep-dive.mdx
import { PhysicalVsLogicalDiagram, LogicalDecodingComponentsDiagram, PublicationsDiagram, LogicalDecodingSequenceDiagram } from '../../../../components/diagrams/module2';

// 02-replication-slots-lifecycle.mdx
import { WalRetentionDiagram, SlotLifecycleDiagram } from '../../../../components/diagrams/module2';

// 03-wal-configuration-tuning.mdx
import { WalLevelHierarchyDiagram, WorkloadWalImpactDiagram } from '../../../../components/diagrams/module2';

// 04-aurora-parameter-groups.mdx
import { AuroraParameterGroupDiagram, AuroraSetupProcessDiagram } from '../../../../components/diagrams/module2';

// 05-aurora-failover-handling.mdx
import { AuroraFailoverSequenceDiagram, HeartbeatMonitoringDiagram, AuroraGlobalDatabaseDiagram } from '../../../../components/diagrams/module2';

// 06-snapshot-strategies.mdx
import { SnapshotDataLossDiagram, TraditionalSnapshotDiagram, IncrementalSnapshotDiagram, SnapshotDecisionDiagram } from '../../../../components/diagrams/module2';

// 07-incremental-snapshot-lab.mdx
import { IncrementalSnapshotLabDiagram, LabCompletionDiagram } from '../../../../components/diagrams/module2';
```

**2. Replace each <Mermaid chart={...}> block with corresponding component:**

01-logical-decoding-deep-dive.mdx:
- First Mermaid (Physical vs Logical) -> `<PhysicalVsLogicalDiagram />`
- Second Mermaid (Logical Decoding components) -> `<LogicalDecodingComponentsDiagram />`
- Third Mermaid (Publications) -> `<PublicationsDiagram />`
- Fourth Mermaid (sequence diagram) -> `<LogicalDecodingSequenceDiagram />`

02-replication-slots-lifecycle.mdx:
- First Mermaid (WAL segments) -> `<WalRetentionDiagram />`
- Second Mermaid (stateDiagram lifecycle) -> `<SlotLifecycleDiagram />`

03-wal-configuration-tuning.mdx:
- First Mermaid (wal_level hierarchy) -> `<WalLevelHierarchyDiagram />`
- Second Mermaid (workload impact) -> `<WorkloadWalImpactDiagram />`

04-aurora-parameter-groups.mdx:
- First Mermaid (Cluster vs Instance params) -> `<AuroraParameterGroupDiagram />`
- Second Mermaid (setup process) -> `<AuroraSetupProcessDiagram />`

05-aurora-failover-handling.mdx:
- First Mermaid (failover sequence) -> `<AuroraFailoverSequenceDiagram />`
- Second Mermaid (heartbeat architecture) -> `<HeartbeatMonitoringDiagram />`
- Third Mermaid (Global Database) -> `<AuroraGlobalDatabaseDiagram />`

06-snapshot-strategies.mdx:
- First Mermaid (data loss without snapshot) -> `<SnapshotDataLossDiagram />`
- Second Mermaid (traditional blocking) -> `<TraditionalSnapshotDiagram />`
- Third Mermaid (incremental parallel) -> `<IncrementalSnapshotDiagram />`
- Fourth Mermaid (decision framework) -> `<SnapshotDecisionDiagram />`

07-incremental-snapshot-lab.mdx:
- First Mermaid (lab architecture) -> `<IncrementalSnapshotLabDiagram />`
- Second Mermaid (completion summary) -> `<LabCompletionDiagram />`

**Important:**
- Remove the entire `<Mermaid chart={...}> client:visible />` block
- Replace with single-line component usage
- Ensure no `client:visible` directive needed (components handle interactivity)
- Keep surrounding content intact (headers, paragraphs, code blocks)

**Verification pattern:**
After changes, each MDX file should:
- Have NO import from Mermaid.tsx
- Have NO <Mermaid> tags
- Have imports from diagrams/module2
- Have appropriate <ComponentName /> usage
  </action>
  <verify>
- No Mermaid imports in any Module 2 MDX file: `grep -r "Mermaid" src/content/course/02-module-2/`
- All 7 MDX files have diagram component imports
- TypeScript/Astro content build: `npm run build`
- Visual check: `npm run dev` and navigate to each lesson
  </verify>
  <done>
All 7 Module 2 MDX files updated to use glass diagram components, Mermaid completely removed from Module 2.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Module 2 renders correctly</name>
  <files>None (verification only)</files>
  <action>
Run development server and verify all Module 2 lessons render correctly:

1. Start dev server: `npm run dev`

2. Verify each lesson URL loads without console errors:
   - http://localhost:4321/course/02-module-2/01-logical-decoding-deep-dive
   - http://localhost:4321/course/02-module-2/02-replication-slots-lifecycle
   - http://localhost:4321/course/02-module-2/03-wal-configuration-tuning
   - http://localhost:4321/course/02-module-2/04-aurora-parameter-groups
   - http://localhost:4321/course/02-module-2/05-aurora-failover-handling
   - http://localhost:4321/course/02-module-2/06-snapshot-strategies
   - http://localhost:4321/course/02-module-2/07-incremental-snapshot-lab

3. For each page, verify:
   - Diagrams render (no blank spaces where Mermaid was)
   - Interactive elements respond to clicks (tooltips appear)
   - Layout is responsive (check mobile viewport)
   - No TypeScript/React errors in console

4. Run production build to ensure no build-time errors:
   ```bash
   npm run build
   ```

5. Grep verification (Mermaid completely removed):
   ```bash
   grep -r "Mermaid" src/content/course/02-module-2/
   # Should return nothing

   grep -r "import.*diagrams/module2" src/content/course/02-module-2/
   # Should return 7 results (one per file)
   ```
  </action>
  <verify>
- `npm run build` succeeds with exit code 0
- `grep -r "Mermaid" src/content/course/02-module-2/` returns no results
- All 7 lesson pages render with visible diagrams
  </verify>
  <done>
Module 2 diagram migration verified complete: all 19 diagrams migrated, Mermaid removed, lessons render correctly.
  </done>
</task>

</tasks>

<verification>
1. All 19 diagram components exist in src/components/diagrams/module2/
2. All 7 MDX files updated with glass component imports
3. Zero Mermaid references in Module 2: `grep -r "Mermaid" src/content/course/02-module-2/`
4. Production build succeeds: `npm run build`
5. Requirements coverage:
   - MOD2-01 (audit): Complete in 29-CONTEXT.md (19 diagrams)
   - MOD2-02 (glass versions): 19 components created
   - MOD2-03 (tooltips): All nodes have detailed Russian tooltips
   - MOD2-04 (Mermaid removal): Zero references after migration
   - Mobile rendering: Complex diagrams (failover sequence, Global Database) responsive
</verification>

<success_criteria>
- 19 total diagram components exported from src/components/diagrams/module2/
- 7 MDX files updated with glass component usage
- Zero Mermaid imports/usage in Module 2
- All lessons render correctly in dev and production builds
- Interactive tooltips work on all diagram nodes
- Complex diagrams (Aurora failover, Global Database, incremental snapshot sequences) render clearly on mobile
- Requirements MOD2-01 through MOD2-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/29-module-2-diagram-migration/29-02-SUMMARY.md`
</output>
