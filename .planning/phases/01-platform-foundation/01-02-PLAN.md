---
phase: 01-platform-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/content/config.ts
  - src/layouts/BaseLayout.astro
  - src/styles/global.css
  - src/components/Mermaid.tsx
autonomous: true

must_haves:
  truths:
    - "Course content files validate against schema at build time"
    - "Layout displays correctly on mobile (single column) and desktop (with sidebar placeholder)"
    - "Mermaid diagrams render as SVG graphics"
  artifacts:
    - path: "src/content/config.ts"
      provides: "Type-safe content collection schema"
      contains: "defineCollection"
    - path: "src/layouts/BaseLayout.astro"
      provides: "Responsive page layout"
      contains: "viewport"
    - path: "src/components/Mermaid.tsx"
      provides: "Mermaid diagram React island"
      contains: "mermaid.initialize"
  key_links:
    - from: "src/layouts/BaseLayout.astro"
      to: "Tailwind responsive classes"
      via: "lg:flex-row, hidden lg:block"
      pattern: "lg:flex-row|hidden lg:block"
    - from: "src/components/Mermaid.tsx"
      to: "mermaid library"
      via: "useEffect initialization"
      pattern: "useEffect.*mermaid"
---

<objective>
Create core components: content collection schema for type-safe course content, responsive base layout with mobile-first design, and Mermaid diagram component with islands architecture.

Purpose: These components are the building blocks for all course pages. Schema ensures content consistency, layout provides responsive structure, Mermaid enables architecture diagrams.
Output: Content schema, BaseLayout, and Mermaid component ready for content pages.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-platform-foundation/01-RESEARCH.md
@.planning/phases/01-platform-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content collection schema</name>
  <files>
    src/content/config.ts
  </files>
  <action>
Create content collection schema for course content using Astro's Content Collections API.

Create `src/content/config.ts`:

```typescript
import { defineCollection, z } from 'astro:content';

const courseCollection = defineCollection({
  type: 'content',
  schema: z.object({
    title: z.string(),
    description: z.string(),
    order: z.number(),
    difficulty: z.enum(['beginner', 'intermediate', 'advanced']),
    estimatedTime: z.number(), // in minutes
    topics: z.array(z.string()),
    prerequisites: z.array(z.string()).optional(),
  }),
});

export const collections = {
  course: courseCollection,
};
```

Also create the content directory structure:
- `src/content/course/` (empty for now, will be populated in Plan 03)

This schema enforces:
- Every lesson has title, description, order (for sequencing)
- Difficulty level for filtering
- Estimated time for planning
- Topics for categorization
- Optional prerequisites for learning path
  </action>
  <verify>
Run `npm run build` - should complete without schema validation errors.
TypeScript should recognize `astro:content` module without errors.
  </verify>
  <done>
Content collection schema validates course frontmatter. TypeScript provides autocomplete for content queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create responsive base layout</name>
  <files>
    src/layouts/BaseLayout.astro
    src/styles/global.css
  </files>
  <action>
Create mobile-first responsive layout with Tailwind CSS.

Create `src/styles/global.css`:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Custom prose styles for dark theme */
.prose {
  --tw-prose-body: theme('colors.gray.300');
  --tw-prose-headings: theme('colors.gray.100');
  --tw-prose-links: theme('colors.blue.400');
  --tw-prose-code: theme('colors.gray.200');
  --tw-prose-pre-bg: theme('colors.gray.800');
}

/* Mermaid diagram container */
.mermaid {
  background: transparent;
}

/* Code block styling */
pre {
  border-radius: 0.5rem;
  padding: 1rem;
}
```

Create `src/layouts/BaseLayout.astro`:

```astro
---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Интерактивный курс по Debezium для дата-инженеров' } = Astro.props;
---

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title} - Debezium Course</title>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-4 py-4 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <a href="/" class="text-xl md:text-2xl font-bold text-white hover:text-blue-400 transition-colors">
          Debezium Course
        </a>
        <!-- Mobile menu button placeholder for Phase 2 -->
        <button class="lg:hidden p-2 text-gray-400 hover:text-white" aria-label="Menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main content area -->
    <main class="flex-1 flex flex-col lg:flex-row">
      <!-- Sidebar placeholder (Phase 2: Navigation) -->
      <aside class="hidden lg:block lg:w-64 xl:w-72 bg-gray-800 border-r border-gray-700 p-4">
        <nav class="text-gray-400 text-sm">
          <p class="text-xs uppercase tracking-wider mb-4">Navigation</p>
          <p class="text-gray-500 italic">Coming in Phase 2</p>
        </nav>
      </aside>

      <!-- Content area -->
      <div class="flex-1 px-4 py-6 md:px-8 lg:px-12">
        <article class="max-w-4xl mx-auto w-full prose prose-invert">
          <slot />
        </article>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 px-4 py-6">
      <div class="max-w-7xl mx-auto text-center text-sm text-gray-400">
        <p>Debezium Course for Data Engineers</p>
        <p class="mt-2">Built with Astro</p>
      </div>
    </footer>
  </div>
</body>
</html>
```

CRITICAL mobile requirements:
- `viewport` meta tag with `width=device-width, initial-scale=1.0`
- `flex-col lg:flex-row` for mobile-first column layout
- `hidden lg:block` for sidebar (hidden on mobile)
- `px-4 md:px-8 lg:px-12` progressive padding
- Sticky header for navigation on scroll
  </action>
  <verify>
1. Create `src/pages/index.astro`:

```astro
---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Home">
  <h1>Welcome to Debezium Course</h1>
  <p>Learn Change Data Capture with hands-on exercises.</p>
</BaseLayout>
```

2. Run `npm run dev`, visit http://localhost:4321
3. Open DevTools, toggle device toolbar (mobile view)
4. Verify: Header visible, sidebar hidden, content full-width
5. Toggle to desktop view: Sidebar visible on left
  </verify>
  <done>
BaseLayout renders correctly on mobile (single column, no sidebar) and desktop (sidebar + content). Viewport meta tag present. Sticky header works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Mermaid diagram component</name>
  <files>
    src/components/Mermaid.tsx
  </files>
  <action>
Create React island component for Mermaid diagrams with proper hydration.

Create `src/components/Mermaid.tsx`:

```tsx
import { useEffect, useRef, useState } from 'react';
import mermaid from 'mermaid';

interface MermaidProps {
  chart: string;
}

export function Mermaid({ chart }: MermaidProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [svg, setSvg] = useState<string>('');

  useEffect(() => {
    const renderDiagram = async () => {
      if (!containerRef.current) return;

      // Initialize Mermaid with dark theme
      mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
          fontSize: '14px',
          primaryColor: '#3b82f6',
          primaryTextColor: '#f3f4f6',
          primaryBorderColor: '#4b5563',
          lineColor: '#6b7280',
          secondaryColor: '#1f2937',
          tertiaryColor: '#374151',
        },
        flowchart: {
          curve: 'basis',
          padding: 20,
        },
      });

      try {
        // Generate unique ID for this diagram
        const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
        const { svg } = await mermaid.render(id, chart);
        setSvg(svg);
      } catch (error) {
        console.error('Mermaid rendering error:', error);
        setSvg(`<pre class="text-red-400">Diagram error: ${error}</pre>`);
      }
    };

    renderDiagram();
  }, [chart]);

  return (
    <div
      ref={containerRef}
      className="my-6 overflow-x-auto bg-gray-800 rounded-lg p-4"
      dangerouslySetInnerHTML={{ __html: svg }}
    />
  );
}
```

IMPORTANT hydration notes:
- Use `startOnLoad: false` and call `mermaid.render()` explicitly
- Generate unique ID for each diagram to prevent conflicts
- Use `client:visible` directive when importing in MDX (loads only when scrolled into view)
- Error handling prevents page crash on invalid diagram syntax

Usage in MDX files:
```mdx
import { Mermaid } from '@/components/Mermaid';

<Mermaid client:visible chart={`
graph LR
    A[Database] --> B[Debezium]
    B --> C[Kafka]
`} />
```
  </action>
  <verify>
Create `src/pages/mermaid-test.astro`:

```astro
---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Mermaid } from '../components/Mermaid';
---

<BaseLayout title="Mermaid Test">
  <h1>Mermaid Diagram Test</h1>

  <Mermaid client:visible chart={`
graph LR
    A[PostgreSQL] -->|Changes| B[Debezium]
    B -->|Events| C[Kafka]
    C -->|Stream| D[Consumer]
`} />

  <h2>Sequence Diagram</h2>

  <Mermaid client:visible chart={`
sequenceDiagram
    participant DB as Database
    participant DBZ as Debezium
    participant K as Kafka
    DB->>DBZ: WAL changes
    DBZ->>K: CDC events
`} />
</BaseLayout>
```

Run `npm run dev`, visit http://localhost:4321/mermaid-test
Diagrams should render as SVG graphics with dark theme styling.
  </verify>
  <done>
Mermaid component renders flowcharts and sequence diagrams with dark theme. Uses client:visible for lazy loading. Error handling prevents crashes on invalid syntax.
  </done>
</task>

</tasks>

<verification>
1. Content schema validates at build time (`npm run build` succeeds)
2. BaseLayout responsive: sidebar hidden on mobile, visible on lg+
3. Viewport meta tag present in rendered HTML
4. Mermaid diagrams render as SVG on test page
5. No hydration errors in browser console
</verification>

<success_criteria>
- Content collection schema defines course content structure with Zod validation
- BaseLayout implements mobile-first responsive design with Tailwind
- Mermaid component renders diagrams with dark theme, lazy hydration
- All components work together without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-foundation/01-02-SUMMARY.md`
</output>
