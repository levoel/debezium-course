---
phase: 04-lab-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - labs/monitoring/prometheus.yml
  - labs/monitoring/grafana/provisioning/datasources/datasource.yml
  - labs/monitoring/grafana/provisioning/dashboards/dashboard.yml
  - labs/monitoring/grafana/dashboards/debezium-connect.json
autonomous: true

must_haves:
  truths:
    - "Prometheus scrapes JMX metrics from Debezium Connect"
    - "Grafana displays Debezium connector dashboard"
    - "Monitoring stack starts with docker compose"
  artifacts:
    - path: "labs/monitoring/prometheus.yml"
      provides: "Prometheus scrape configuration"
      contains: "connect:9404"
    - path: "labs/monitoring/grafana/provisioning/datasources/datasource.yml"
      provides: "Grafana Prometheus datasource"
      contains: "prometheus"
    - path: "labs/monitoring/grafana/dashboards/debezium-connect.json"
      provides: "Debezium monitoring dashboard"
      contains: "kafka_connect"
  key_links:
    - from: "labs/monitoring/prometheus.yml"
      to: "connect:9404"
      via: "JMX scrape target"
      pattern: "connect:9404"
    - from: "labs/monitoring/grafana/provisioning/datasources/datasource.yml"
      to: "prometheus:9090"
      via: "Grafana datasource URL"
      pattern: "http://prometheus:9090"
---

<objective>
Create the monitoring stack with Prometheus and Grafana for Debezium CDC metrics visualization.

Purpose: Enable students to monitor connector health, lag, and throughput during lab exercises.
Output: Prometheus configuration and Grafana dashboard that auto-provisions on startup.
</objective>

<execution_context>
@/Users/levoely/.claude/get-shit-done/workflows/execute-plan.md
@/Users/levoely/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-lab-infrastructure/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Prometheus configuration</name>
  <files>labs/monitoring/prometheus.yml</files>
  <action>
Create labs/monitoring/prometheus.yml with scrape configuration for Debezium Connect JMX metrics.

Based on research pattern 4 (JMX Metrics Export):

```yaml
# Prometheus configuration for Debezium Lab
# Scrapes JMX metrics from Kafka Connect via port 9404

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Kafka Connect JMX metrics (Debezium connectors)
  - job_name: 'kafka-connect'
    static_configs:
      - targets: ['connect:9404']
    metric_relabel_configs:
      # Keep only Kafka Connect related metrics
      - source_labels: [__name__]
        regex: 'kafka_connect_.*|debezium_.*'
        action: keep
```

The `connect:9404` target matches the JMX port exposed in docker-compose.yml from Plan 01.
  </action>
  <verify>File exists at labs/monitoring/prometheus.yml with kafka-connect job targeting connect:9404</verify>
  <done>Prometheus config scrapes JMX metrics from connect:9404 every 15s</done>
</task>

<task type="auto">
  <name>Task 2: Create Grafana provisioning configuration</name>
  <files>
    labs/monitoring/grafana/provisioning/datasources/datasource.yml
    labs/monitoring/grafana/provisioning/dashboards/dashboard.yml
  </files>
  <action>
Create Grafana auto-provisioning config for datasource and dashboard discovery.

1. Create labs/monitoring/grafana/provisioning/datasources/datasource.yml:

```yaml
# Grafana Datasource Provisioning
# Auto-configures Prometheus as default datasource

apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
```

2. Create labs/monitoring/grafana/provisioning/dashboards/dashboard.yml:

```yaml
# Grafana Dashboard Provisioning
# Auto-loads dashboards from /etc/grafana/provisioning/dashboards directory

apiVersion: 1

providers:
  - name: 'debezium'
    orgId: 1
    folder: 'Debezium'
    type: file
    disableDeletion: false
    editable: true
    options:
      path: /var/lib/grafana/dashboards
```

These files enable Grafana to auto-discover datasources and dashboards on startup.
  </action>
  <verify>
Files exist at:
- labs/monitoring/grafana/provisioning/datasources/datasource.yml
- labs/monitoring/grafana/provisioning/dashboards/dashboard.yml
  </verify>
  <done>Grafana provisioning configured with Prometheus datasource and dashboard auto-discovery</done>
</task>

<task type="auto">
  <name>Task 3: Create Debezium monitoring dashboard</name>
  <files>labs/monitoring/grafana/dashboards/debezium-connect.json</files>
  <action>
Create labs/monitoring/grafana/dashboards/debezium-connect.json with essential CDC metrics.

Dashboard should include panels for:
1. **Connector Status** - kafka_connect_connector_status (running/paused/failed)
2. **Task Status** - kafka_connect_connector_task_status
3. **Records Processed** - kafka_connect_source_task_source_record_poll_total
4. **Poll Batch Size** - kafka_connect_source_task_poll_batch_avg_time_ms
5. **Connector Lag** - debezium_metrics_MilliSecondsBehindSource (if available)

Create a JSON dashboard with:
- Title: "Debezium Connect Monitoring"
- Datasource: "${DS_PROMETHEUS}" (variable)
- Time range: Last 30 minutes
- Refresh: 10s

Use Grafana dashboard JSON format with templating for connector name variable.

Key metrics to query (from Debezium JMX):
- kafka_connect_connector_status{connector=~"$connector"}
- kafka_connect_source_task_source_record_poll_total{connector=~"$connector"}
- kafka_connect_source_task_source_record_active_count{connector=~"$connector"}

Panel layout (2 columns):
- Row 1: Connector Status, Task Count
- Row 2: Records Polled (graph), Records Active (graph)
- Row 3: Lag metrics (if available)

Reference: https://github.com/debezium/debezium-examples/tree/main/monitoring for panel inspiration.
  </action>
  <verify>
File exists at labs/monitoring/grafana/dashboards/debezium-connect.json and is valid JSON:
`cat labs/monitoring/grafana/dashboards/debezium-connect.json | jq .title`
Expected: "Debezium Connect Monitoring"
  </verify>
  <done>Grafana dashboard shows connector status, task count, and records processed metrics</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the monitoring stack configuration:

```bash
cd labs

# Validate Prometheus config syntax
docker run --rm -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus:latest promtool check config /etc/prometheus/prometheus.yml

# Validate Grafana dashboard JSON
cat monitoring/grafana/dashboards/debezium-connect.json | jq .

# Check directory structure
ls -la monitoring/
ls -la monitoring/grafana/provisioning/datasources/
ls -la monitoring/grafana/provisioning/dashboards/
ls -la monitoring/grafana/dashboards/
```

Expected structure:
```
monitoring/
  prometheus.yml
  grafana/
    provisioning/
      datasources/
        datasource.yml
      dashboards/
        dashboard.yml
    dashboards/
      debezium-connect.json
```
</verification>

<success_criteria>
1. Prometheus config is valid YAML with connect:9404 as scrape target
2. Grafana datasource.yml points to http://prometheus:9090
3. Grafana dashboard.yml enables auto-provisioning from /var/lib/grafana/dashboards
4. Debezium dashboard JSON is valid and contains kafka_connect metrics panels
5. All provisioning files follow Grafana provisioning API format (apiVersion: 1)
</success_criteria>

<output>
After completion, create `.planning/phases/04-lab-infrastructure/04-02-SUMMARY.md`
</output>
